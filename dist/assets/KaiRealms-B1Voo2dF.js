const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bundler-IMYm8BQv.js","assets/index-BWApiWDT.js","assets/index-BmaJNTKf.css"])))=>i.map(i=>d[i]);
import{t as e}from"./x-Bw0a6Rv2.js";import{Bt as t,Ht as n,Sn as r,Tn as i,an as a,jn as o,ln as s,mn as c,t as l,tn as u}from"./index-BWApiWDT.js";var d=o(i(),1);function f(e){return typeof e==`string`?e.toLowerCase():``}function p(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function m(e){return typeof e==`string`&&e.length>0}function h(e){return typeof e==`number`&&Number.isFinite(e)}function g(e){if(typeof e!=`object`||!e)throw Error(`Malformed sigil metadata.`);let t=e;for(let e of[`pulse`,`beat`,`stepIndex`,`chakraDay`])if(!p(t,e))throw Error(`Missing Kai field: ${e}`);if(!p(t,`kaiSignature`))throw Error(`Invalid Kai Signature â€” tampered or unsigned sigil.`);if(!h(t.pulse))throw Error(`Invalid field: pulse`);if(!h(t.beat))throw Error(`Invalid field: beat`);if(!h(t.stepIndex))throw Error(`Invalid field: stepIndex`);if(!m(t.chakraDay))throw Error(`Invalid field: chakraDay`);if(!m(t.kaiSignature))throw Error(`Invalid field: kaiSignature`)}function _(e){try{let t=new DOMParser().parseFromString(e,`image/svg+xml`),n=Array.from(t.getElementsByTagName(`metadata`)),r=[`valuation`,`ledger`,`dht`,`source`];for(let e of n){let t=e.getAttribute(`id`)??``;if(r.some(e=>t.includes(e)))continue;let n=(e.textContent??``).trim();if(!n)continue;let i=n.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(i);if(typeof e==`object`&&e&&p(e,`pulse`)&&p(e,`beat`)&&p(e,`stepIndex`)&&p(e,`chakraDay`)&&p(e,`kaiSignature`))return e}catch{}}return null}catch{return null}}async function v(e){let r=await e.text(),{meta:i,contextOk:a,typeOk:o}=await l(e),s=i&&p(i,`kaiSignature`)&&p(i,`pulse`)?i:_(r);if(!s||!a||!o)throw Error(`Invalid glyph or missing metadata.`);g(s);let c=s,u=await t(c);if(!u||f(u)!==f(c.kaiSignature))throw Error(`Invalid Kai Signature â€” tampered or unsigned sigil.`);let d=await n(c.kaiSignature);if(typeof c.userPhiKey==`string`){if(f(c.userPhiKey)!==f(d))throw Error(`Î¦-Key mismatch â€” identity invalid.`)}else c.userPhiKey=d;return{svgText:r,meta:c,phiKey:d}}var y=o(u(),1),b=`.svg,image/svg+xml`,x=({onEnter:e})=>{let t=(0,d.useRef)(null),[n,r]=(0,d.useState)(!1),[i,a]=(0,d.useState)(!1),[o,s]=(0,d.useState)(``),[c,l]=(0,d.useState)(null),u=(0,d.useId)(),f=(0,d.useId)(),p=(0,d.useId)(),m=()=>{t.current&&(t.current.value=``)},h=(0,d.useCallback)(async t=>{l(null),s(t.name),a(!0);try{if(!(t.type===`image/svg+xml`||t.name.toLowerCase().endsWith(`.svg`)))throw Error(`Please upload a valid Kai Sigil (.svg).`);e(await v(t))}catch(e){l(e instanceof Error?e.message:`Invalid glyph or missing metadata.`)}finally{a(!1),m()}},[e]),g=(0,d.useCallback)(async e=>{let t=e.target.files?.[0];t&&await h(t)},[h]),_=(0,d.useCallback)(async e=>{e.preventDefault(),e.stopPropagation(),r(!1);let t=e.dataTransfer.files?.[0];t&&await h(t)},[h]),x=e=>{e.preventDefault(),e.dataTransfer.dropEffect=`copy`,n||r(!0)},S=e=>{e.currentTarget.contains(e.relatedTarget)||r(!1)},C=()=>t.current?.click(),w=e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),C())};return(0,y.jsxs)(`section`,{className:`portal-card glass-omni`,"aria-labelledby":u,"aria-describedby":f,children:[(0,y.jsx)(`div`,{className:`breath-ring breath-ring--outer`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`breath-ring breath-ring--inner`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`phi-grid`,"aria-hidden":!0}),(0,y.jsx)(`h1`,{id:u,className:`sr-only`,children:`Drop your Kai Sigil`}),(0,y.jsxs)(`div`,{className:`portal-body`,children:[(0,y.jsxs)(`div`,{className:`dropzone ${n?`dropzone--active`:``} ${i?`dropzone--busy`:``}`,role:`button`,tabIndex:0,onKeyDown:w,onClick:C,onDrop:_,onDragOver:x,onDragLeave:S,"aria-busy":i,"aria-describedby":`${f}${c?` ${p}`:``}`,children:[(0,y.jsxs)(`div`,{className:`dropzone-ornament`,"aria-hidden":!0,children:[(0,y.jsx)(`div`,{className:`ornament-ring ornament-ring--outer`}),(0,y.jsx)(`div`,{className:`ornament-ring ornament-ring--inner`}),(0,y.jsx)(`div`,{className:`ornament-core`})]}),(0,y.jsx)(`div`,{className:`dropzone-icon`,"aria-hidden":!0,children:(0,y.jsxs)(`svg`,{width:`44`,height:`44`,viewBox:`0 0 44 44`,children:[(0,y.jsx)(`defs`,{children:(0,y.jsxs)(`linearGradient`,{id:`dzG`,x1:`0`,y1:`0`,x2:`1`,y2:`1`,children:[(0,y.jsx)(`stop`,{offset:`0%`,stopColor:`#00ffd0`}),(0,y.jsx)(`stop`,{offset:`100%`,stopColor:`#8a2be2`})]})}),(0,y.jsx)(`circle`,{cx:`22`,cy:`22`,r:`20`,fill:`none`,stroke:`url(#dzG)`,strokeWidth:`1.5`}),(0,y.jsx)(`path`,{d:`M22 12 L22 30 M14 20 L22 12 L30 20`,stroke:`url(#dzG)`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,fill:`none`})]})}),(0,y.jsxs)(`div`,{className:`dropzone-text`,children:[(0,y.jsx)(`div`,{className:`dz-title`,children:`Inhale your Kai Sigil`}),(0,y.jsxs)(`div`,{id:f,className:`dz-hint`,children:[`Breath-minted `,(0,y.jsx)(`strong`,{children:`Î¦key`}),` only. Drag & drop.`]}),o&&!i&&!c?(0,y.jsxs)(`div`,{className:`dz-file`,children:[`Selected: `,o]}):null,i?(0,y.jsxs)(`div`,{className:`dz-progress`,children:[(0,y.jsx)(`div`,{className:`dz-spinner`}),(0,y.jsx)(`span`,{children:`Verifyingâ€¦`})]}):null]}),(0,y.jsx)(`input`,{ref:t,type:`file`,accept:b,onChange:g,tabIndex:-1,"aria-hidden":!0,className:`dz-input`})]}),c?(0,y.jsx)(`div`,{id:p,className:`portal-error`,role:`alert`,"aria-live":`polite`,children:c}):null,(0,y.jsx)(`p`,{className:`portal-note`,children:`Your sigil is verified by breath. No drift. Only truth.`})]}),(0,y.jsx)(`span`,{className:`sr-only`,children:`Kai Realms sigil gate ready.`})]})},S=typeof window<`u`,C=11n,w=44n,T=36n;function E(e){let t=BigInt(a),n=BigInt(s),r=(e>t?e-t:0n)/n,i=r/C%w,o=r/(C*w)%T;return{pulseIndex:Number(r),stepIndex:Number(i),beatIndex:Number(o)}}function D(e){let t=BigInt(a),n=BigInt(s);return t+((e>t?e-t:0n)/n+1n)*n}function ee(e){let t=(0,d.useRef)(null),n=(0,d.useRef)(e);n.current=e,(0,d.useEffect)(()=>{if(!S)return;let e=null,r=!1,i=()=>{if(r)return;let a=c(),{pulseIndex:o,stepIndex:s,beatIndex:l}=E(a);o!==t.current&&(n.current.onPulse?.(o),o%Number(C)===0&&n.current.onStep?.(s),o%Number(C*w)===0&&n.current.onBeat?.(l),t.current=o);let u=D(a),d=u>a?u-a:0n,f=Number(d);e=window.setTimeout(i,f)};return i(),()=>{r=!0,e!==null&&window.clearTimeout(e)}},[])}var O={Root:`#FF0033`,Sacral:`#FF8000`,Solar:`#FFD700`,Heart:`#00FF99`,Throat:`#33CCFF`,ThirdEye:`#9933FF`,Crown:`#AA00FF`};function k(e,t,n,r,i){e.save(),e.translate(n,r);let{chakraDay:a,pulse:o}=t.meta,s=O[a]??`#00FFFF`;e.beginPath(),e.arc(0,0,i+4,0,Math.PI*2),e.fillStyle=s,e.shadowColor=s,e.shadowBlur=15,e.fill(),e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fillStyle=`#000012`,e.fill();let c=i+o%11*1.5;e.beginPath(),e.arc(0,0,c,0,Math.PI*2),e.strokeStyle=`${s}AA`,e.lineWidth=1.5,e.stroke(),e.restore()}function A(e){return typeof e==`object`&&!!e}function j(e){if(typeof e==`bigint`)return e;if(typeof e==`number`&&Number.isFinite(e)&&Number.isSafeInteger(e))return BigInt(e);if(typeof e==`string`)try{return BigInt(e)}catch{return null}return null}var M=`kai:game:focus`,N=typeof window<`u`;function P(){if(!N||typeof BroadcastChannel>`u`)return null;try{return new BroadcastChannel(`kai-realms-game-focus`)}catch{return null}}function te(e){let t={id:e,ts:c()};if(N)try{window.dispatchEvent(new CustomEvent(M,{detail:t}))}catch{}let n=P();if(n)try{n.postMessage({type:M,detail:{id:t.id,ts:t.ts.toString()}})}catch{}finally{try{n.close()}catch{}}}function F(e){if(!A(e))return null;let t=e.id,n=j(e.ts);return typeof t!=`string`||n===null?null:{id:t,ts:n}}function ne(e){let t=t=>{let n=F(t?.detail);n&&e(n)};N&&window.addEventListener(M,t);let n=P(),r=t=>{let n=t?.data;if(!A(n)||n.type!==M)return;let r=F(n.detail);r&&e(r)};if(n)try{n.addEventListener(`message`,r)}catch{}return()=>{if(N&&window.removeEventListener(M,t),n)try{n.removeEventListener(`message`,r)}catch{}finally{try{n.close()}catch{}}}}function re(e){let[t,n]=(0,d.useState)(!1),r=(0,d.useRef)(0n);return(0,d.useEffect)(()=>ne(t=>{n(t.id!==e),r.current=t.ts}),[e]),{paused:t,takeFocus:(0,d.useCallback)(()=>{te(e),n(!1)},[e])}}var I=5236,L=.085,R=1,ie=60,ae=6.1,oe=5.6,se=.1,ce=1.6,le=10,ue=50,de=150,fe=10,pe=Math.floor(I*1.25),me=.145,he=2.618,ge=I,z=I,_e=1e3,ve=.12,B=44,ye=.618,be=.35,xe=3,Se=`600 12px ui-sans-serif,system-ui,-apple-system`,V={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0},none:{x:0,y:0}},H={up:`down`,down:`up`,left:`right`,right:`left`,none:`none`};function Ce(e,t,n){return e+(t-e)*n}function U(e,t){return(e-t+I)%I/I}function we(e){let t=Math.sin(Math.PI*e);return .78+.44*(t*t)}function Te(e){let t=e.toLowerCase();return t===`arrowup`||t===`w`?`up`:t===`arrowdown`||t===`s`?`down`:t===`arrowleft`||t===`a`?`left`:t===`arrowright`||t===`d`?`right`:`none`}function W(e,t,n){let r=Math.round(n),i=Math.round(t);return r<0||r>=e.length||i<0||i>=e[0].length?!1:e[r][i]!==1}function G(e){return{x:Math.round(e.x),y:Math.round(e.y)}}function K(e,t){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r}function Ee(){let e=Array.from({length:23},()=>Array(27).fill(1));((t,n,r,i)=>{for(let a=n;a<n+i;a++)for(let n=t;n<t+r;n++)a>0&&a<22&&n>0&&n<26&&(e[a][n]=0)})(1,1,25,21);for(let t=2;t<25;t++)e[5][t]=1,e[17][t]=1;for(let t=2;t<21;t++)e[t][4]=1,e[t][22]=1;for(let t=6;t<21;t++)e[11][t]=0;for(let t=4;t<19;t++)e[t][13]=0;for(let t=1;t<22;t++)for(let n=1;n<26;n++)e[t][n]===0&&(e[t][n]=2);for(let t of[{x:6,y:6},{x:20,y:6},{x:6,y:16},{x:20,y:16}])e[t.y][t.x]=3;for(let t of[{x:2,y:2},{x:24,y:2},{x:2,y:20},{x:24,y:20}])e[t.y]?.[t.x]!==1&&(e[t.y][t.x]=4);return e}function De(e){return{pos:{x:e.x,y:e.y},dir:`left`,next:`left`,speed:ae}}function q(e,t,n){return{pos:{x:e.x,y:e.y},dir:`left`,speed:oe,scatterTarget:n,mode:`chase`,frightUntil:0,color:t}}function Oe(e){let t=0;for(let n=0;n<e.length;n++)for(let r=0;r<e[0].length;r++)e[n][r]===2&&t++;return t}function ke(e,t){let n=Ee(),r=n.length,i=n[0].length,a={x:Math.floor(i/2),y:r-4},o={x:Math.floor(i/2),y:Math.floor(r/2)-1},s=[q({x:o.x-2,y:o.y},`#ff4d4d`,{x:2,y:2}),q({x:o.x+2,y:o.y},`#4dd2ff`,{x:i-3,y:2}),q({x:o.x,y:o.y},`#ffd166`,{x:2,y:r-3}),q({x:o.x,y:o.y+2},`#bd7bff`,{x:i-3,y:r-3})],c={phase:`chase`,nextSwitchAt:t+Ae(e,`chase`)};return{grid:n,pellets:Oe(n),level:e,lives:xe,points:0,bankable:0,scorePhi:0,streak:0,bestStreak:0,comboUntil:0,kaiCharge:0,alive:!0,over:!1,ghosts:s,player:De(a),onAltar:!1,channelingUntil:0,cycle:c}}function Ae(e,t){let n=t===`chase`?7e3:5e3,r=Math.max(.55,1-(e-1)*.06);return Math.floor(n*r)}function je(e,t){let n=G(t),r=Math.abs(t.x-n.x),i=Math.abs(t.y-n.y);if(r>=.1||i>=.1)return!1;let a=0;return[`up`,`down`,`left`,`right`].forEach(t=>{W(e,n.x+V[t].x,n.y+V[t].y)&&a++}),a>=3}function Me(e,t){if(t.next===`none`||t.next===t.dir)return;if(t.next===H[t.dir]){t.dir=t.next;return}let n=G(t.pos),r=Math.abs(t.pos.x-n.x),i=Math.abs(t.pos.y-n.y);r>=.12||i>=.12||W(e,n.x+V[t.next].x,n.y+V[t.next].y)&&(t.pos.x=n.x,t.pos.y=n.y,t.dir=t.next)}function Ne(e,t,n,r,i){if(n===`none`)return;let a=V[n],o=t.x+a.x*r*i,s=t.y+a.y*r*i,c=e[0].length;if(o<-1){t.x=c+1;return}if(o>c+1){t.x=-1;return}if(W(e,Math.round(o),Math.round(s)))t.x=o,t.y=s;else{let e=G(t);t.x=e.x,t.y=e.y}}function Pe(e,t,n,r){let i=[`up`,`left`,`down`,`right`],a=n,o=1/0;for(let s of i){if(s===H[n])continue;let i=Math.round(t.x)+V[s].x,c=Math.round(t.y)+V[s].y;if(!W(e,i,c))continue;let l=K({x:i,y:c},r);l<o&&(o=l,a=s)}if(a===n){let r=H[n];if(W(e,Math.round(t.x)+V[r].x,Math.round(t.y)+V[r].y))return r}return a}var Fe=({currentPhi:e,onPhiChange:t,onExit:n})=>{let r=(0,d.useRef)(null),i=(0,d.useRef)(null),{paused:a,takeFocus:o}=re(`KaiMaze`),[s,c]=(0,d.useState)({w:0,h:0});(0,d.useEffect)(()=>{let e=r.current;if(!e)return;let t=new ResizeObserver(e=>{for(let t of e){let e=t.contentRect;c({w:e.width,h:e.height})}});return t.observe(e),()=>t.disconnect()},[]);let[l,u]=(0,d.useState)(e);(0,d.useEffect)(()=>u(e),[e]);let[f,p]=(0,d.useState)(()=>ke(1,performance.now())),m=(0,d.useRef)(performance.now()),[h,g]=(0,d.useState)(()=>{if(typeof window>`u`)return!1;let e=window.matchMedia?.(`(pointer: coarse)`)?.matches??!1,t=window.matchMedia?.(`(max-width: 900px)`)?.matches??!1;return e||t});(0,d.useEffect)(()=>{if(typeof window>`u`)return;let e=window.matchMedia(`(pointer: coarse)`),t=window.matchMedia(`(max-width: 900px)`),n=()=>g(e.matches||t.matches);return e.addEventListener?.(`change`,n),t.addEventListener?.(`change`,n),()=>{e.removeEventListener?.(`change`,n),t.removeEventListener?.(`change`,n)}},[]);let _=(0,d.useMemo)(()=>e=>Math.floor(_e*(1+ve*(e-1))),[]),v=(0,d.useMemo)(()=>h&&!f.over,[h,f.over]),b=(0,d.useMemo)(()=>(h?`Tap/Swipe or D-pad`:`â†â†‘â†’â†“ / WASD`)+` Â· B/Space to Channel on âŸ Â· Esc to exit`,[h]);(0,d.useEffect)(()=>{if(R>0&&l>=R){let e=l-R;u(e),t(e),o()}},[]);let x=()=>{p(e=>e.channelingUntil?{...e,channelingUntil:0}:e)};(0,d.useEffect)(()=>{let e=e=>{let t=e.key.toLowerCase(),r=Te(t);r!==`none`&&(x(),e.preventDefault(),o(),p(e=>({...e,player:{...e.player,next:r}}))),(t===`b`||t===` `)&&f.onAltar&&f.channelingUntil===0&&(o(),p(e=>({...e,channelingUntil:performance.now()+z}))),t===`escape`&&n&&n(),t===`r`&&f.over&&(o(),p(ke(1,performance.now())),m.current=performance.now())};return window.addEventListener(`keydown`,e),()=>window.removeEventListener(`keydown`,e)},[n,f.over,f.onAltar,f.channelingUntil]);let S=e=>{x(),o(),p(t=>({...t,player:{...t.player,next:e}}))},C=()=>{f.onAltar&&f.channelingUntil===0&&(o(),p(e=>({...e,channelingUntil:performance.now()+z})))};(0,d.useEffect)(()=>{let e=0,n=performance.now(),r=(e,n)=>{if(n.channelingUntil===0||!n.onAltar||e<n.channelingUntil)return n;let r=_(n.level);if(n.bankable<r)return{...n,channelingUntil:0};let i=1+Math.min(1,n.kaiCharge/B)*ye,a=Math.max(0,Math.floor(n.bankable/r*i));if(a>0){let e=Math.floor(a*r),i=Math.max(0,n.bankable-e),o=l+a;return u(o),t(o),{...n,scorePhi:n.scorePhi+a,bankable:i,points:i,kaiCharge:Math.max(0,Math.floor(n.kaiCharge*.5)),channelingUntil:0}}return{...n,channelingUntil:0}},i=()=>{e=requestAnimationFrame(i);let o=performance.now(),s=Math.min(1/ie,(o-n)/1e3);n=o,!a&&p(e=>{if(e.over)return e;let n=structuredClone(e);if(o>=n.cycle.nextSwitchAt){let e=n.cycle.phase===`chase`?`scatter`:`chase`;n.cycle={phase:e,nextSwitchAt:o+Ae(n.level,e)};for(let t of n.ghosts)t.mode!==`fright`&&(t.mode=e)}let i=U(o,m.current),a=we(i),c=Math.min(1+n.streak*se,ce),d=Math.min(1+n.streak*me,he),f=n.channelingUntil>0?0:n.player.speed*a*c;Me(n.grid,n.player),Ne(n.grid,n.player.pos,n.player.dir,f,s);let p=G(n.player.pos);n.onAltar=n.grid[p.y]?.[p.x]===4;let h=n.grid[p.y]?.[p.x]??1;if((h===2||h===3)&&n.channelingUntil===0){let e=Math.abs(i-.5)<=L,t=h===2?le:ue;if(e&&(t+=fe,n.kaiCharge=Math.min(B,n.kaiCharge+1)),t=Math.floor(t*d),n.points+=t,n.bankable=n.points,n.streak+=1,n.streak>n.bestStreak&&(n.bestStreak=n.streak),n.comboUntil=o+pe,n.grid[p.y][p.x]=0,n.pellets=Math.max(0,n.pellets-1),h===3){m.current=o;let e=Math.max(ge*Math.max(.55,1-(n.level-1)*.08),I*.5);for(let t of n.ghosts)t.mode=`fright`,t.frightUntil=o+e}}n.comboUntil>0&&o>n.comboUntil&&(n.streak=Math.max(0,Math.floor(n.streak*.5)),n.comboUntil=0);for(let e of n.ghosts){e.mode===`fright`&&o>=e.frightUntil&&(e.mode=n.cycle.phase);let t=G(n.player.pos);if(je(n.grid,e.pos))if(e.mode===`scatter`)e.dir=Pe(n.grid,e.pos,e.dir,e.scatterTarget);else if(e.mode===`fright`){let r=G(e.pos),i=[`up`,`down`,`left`,`right`],a=e.dir,o=-1/0;for(let s of i){if(s===H[e.dir])continue;let i=r.x+V[s].x,c=r.y+V[s].y;if(!W(n.grid,i,c))continue;let l=K({x:i,y:c},t);l>o&&(o=l,a=s)}e.dir=a}else{let r={x:t.x+V[n.player.dir].x*2,y:t.y+V[n.player.dir].y*2};e.dir=Pe(n.grid,e.pos,e.dir,r)}let r=e.mode===`fright`?Ce(.6,.8,Math.sin(i*Math.PI)):a,c=e.speed*r;if(c*=1.06**(n.level-1),Ne(n.grid,e.pos,e.dir,c,s),K(n.player.pos,e.pos)<.4)if(e.mode===`fright`&&n.channelingUntil===0){let t=Math.floor(de*d);n.points+=t,n.bankable=n.points,n.streak+=1,n.streak>n.bestStreak&&(n.bestStreak=n.streak),n.comboUntil=o+pe,e.pos={...e.scatterTarget},e.dir=`left`,e.mode=`scatter`,e.frightUntil=0}else if(--n.lives,n.streak=0,n.comboUntil=0,n.points=Math.max(0,Math.floor(n.points*(1-be))),n.bankable=n.points,n.channelingUntil=0,n.lives<=0)n.alive=!1,n.over=!0;else{let e={x:Math.floor(n.grid[0].length/2),y:n.grid.length-4};n.player.pos={...e},n.player.dir=`left`,n.player.next=`left`;for(let e of n.ghosts)e.mode=`scatter`;m.current=o}}if(n.pellets<=0&&!n.over){let e=_(n.level),r=Math.floor(n.bankable*.2/e);if(r>0){let i=r*e,a=Math.max(0,n.bankable-i),o=l+r;u(o),t(o),n.scorePhi+=r,n.bankable=a,n.points=a}let i=ke(n.level+1,o);i.scorePhi=n.scorePhi,i.lives=Math.max(1,n.lives),i.bestStreak=Math.max(n.bestStreak,n.streak),i.player.speed=n.player.speed*1.06;for(let e of i.ghosts)e.speed*=1.06;return m.current=o,i}return n=r(o,n),n})};return e=requestAnimationFrame(i),()=>cancelAnimationFrame(e)},[t,l,a,_]),(0,d.useEffect)(()=>{let e=0,t=()=>{e=requestAnimationFrame(t);let n=i.current,o=r.current;if(!n||!o)return;let c=n.getContext(`2d`);if(!c)return;let u=Math.max(0,s.w),d=Math.max(0,s.h);if(u===0||d===0)return;let p=Math.min(2,window.devicePixelRatio||1);(n.width!==Math.floor(u*p)||n.height!==Math.floor(d*p))&&(n.width=Math.floor(u*p),n.height=Math.floor(d*p),n.style.width=`${u}px`,n.style.height=`${d}px`),c.setTransform(p,0,0,p,0,0);let h=f.grid.length,g=f.grid[0].length,_=Math.floor(Math.min(u/g,d/h)),v=_*g,y=_*h,b=Math.floor((u-v)/2),x=Math.floor((d-y)/2),S=c.createLinearGradient(0,0,0,d);S.addColorStop(0,`#07071a`),S.addColorStop(1,`#0c1231`),c.fillStyle=S,c.fillRect(0,0,u,d),Be(c,u,d);for(let e=0;e<h;e++)for(let t=0;t<g;t++){let n=f.grid[e][t],r=b+t*_,i=x+e*_;if(n===1)c.fillStyle=`rgba(255,255,255,0.06)`,c.fillRect(r,i,_,_),c.strokeStyle=`rgba(255,255,255,0.20)`,c.lineWidth=1,c.strokeRect(r+.5,i+.5,_-1,_-1);else if(n===2)c.fillStyle=`rgba(255,255,255,0.95)`,c.beginPath(),c.arc(r+_/2,i+_/2,Math.max(2,_*.09),0,Math.PI*2),c.fill();else if(n===3){let e=c.createRadialGradient(r+_/2,i+_/2,0,r+_/2,i+_/2,Math.max(9,_*.38));e.addColorStop(0,`rgba(255,255,255,0.90)`),e.addColorStop(1,`rgba(255,209,110,0.22)`),c.fillStyle=e,c.beginPath(),c.arc(r+_/2,i+_/2,Math.max(5,_*.22),0,Math.PI*2),c.fill()}else if(n===4){let e=Math.max(8,_*.36);c.save(),c.globalAlpha=.9;let t=c.createRadialGradient(r+_/2,i+_/2,e*.2,r+_/2,i+_/2,e);t.addColorStop(0,`rgba(0,255,208,0.35)`),t.addColorStop(1,`rgba(0,255,208,0.05)`),c.fillStyle=t,c.beginPath(),c.arc(r+_/2,i+_/2,e,0,Math.PI*2),c.fill(),c.strokeStyle=`rgba(0,255,208,0.8)`,c.lineWidth=2,c.beginPath(),c.arc(r+_/2,i+_/2,e*.65,0,Math.PI*2),c.stroke(),c.restore()}}let C=f.player.pos;Ie(c,b+C.x*_,x+C.y*_,_*.45,`rgba(255,255,255,0.96)`);for(let e of f.ghosts){let t=e.pos,n=e.mode===`fright`?`rgba(100,180,255,0.92)`:e.color;Le(c,b+t.x*_,x+t.y*_,_*.44,n)}let w=performance.now(),T=typeof window<`u`&&typeof window.__kai_breath_anchor==`number`?window.__kai_breath_anchor:void 0;T!==void 0&&Re(c,u,U(w,T)),Re(c,u,U(w,m.current)),c.fillStyle=`rgba(255,255,255,0.92)`,c.font=Se;let E=Math.min(1+f.streak*me,he);if(c.fillText(`Î¦ ${l.toFixed(0)}  |  PTS ${f.bankable}  |  x${E.toFixed(2)}  |  L${f.level}  |  Lives ${f.lives}  |  Streak ${f.streak}  |  Charge ${f.kaiCharge}/${B}`,8,14),f.channelingUntil>0&&f.onAltar){let e=1-Math.max(0,f.channelingUntil-w)/z,t=u/2;c.strokeStyle=`rgba(0,255,208,0.9)`,c.lineWidth=4,c.globalAlpha=.9,c.beginPath(),c.arc(t,34,16,-Math.PI/2,-Math.PI/2+e*Math.PI*2),c.stroke(),c.globalAlpha=1,c.font=`700 12px ui-sans-serif,system-ui,-apple-system`,c.fillText(`Channelingâ€¦`,t+16+8,38)}if(a&&!f.over){c.fillStyle=`rgba(0,0,0,0.35)`,c.fillRect(0,0,u,d),c.fillStyle=`#fff`,c.font=`700 16px ui-sans-serif,system-ui,-apple-system`;let e=`Paused â€” another Realm is active`;c.fillText(e,(u-c.measureText(e).width)/2,d/2)}if(f.over){c.fillStyle=`rgba(0,0,0,0.55)`,c.fillRect(0,0,u,d),c.fillStyle=`#fff`,c.font=`700 20px ui-sans-serif,system-ui,-apple-system`;let e=`Game Over â€” Press R to restart`;c.fillText(e,(u-c.measureText(e).width)/2,d/2)}};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[f,l,s,a]);let w=f.onAltar&&f.channelingUntil===0;return(0,y.jsxs)(`div`,{className:`km-wrap`,role:`group`,"aria-label":`Kai-Maze`,onPointerDown:()=>o(),onTouchStart:()=>o(),onMouseDown:()=>o(),children:[(0,y.jsxs)(`div`,{className:`km-header`,children:[(0,y.jsx)(`div`,{className:`km-title`,children:`ðŸŒ€ Kai-Maze`}),(0,y.jsx)(`div`,{className:`km-sub`,children:`Score on pulse, risk your points, then âŸ channel to mint Î¦.`})]}),(0,y.jsxs)(`div`,{className:`km-stage`,ref:r,children:[(0,y.jsx)(`canvas`,{ref:i,className:`km-canvas`}),v&&(0,y.jsxs)(`div`,{className:`km-dpad`,style:{position:`absolute`,left:12,bottom:12,width:132,height:132,display:`grid`,gridTemplateColumns:`repeat(3, 1fr)`,gridTemplateRows:`repeat(3, 1fr)`,gap:6,touchAction:`none`,userSelect:`none`,zIndex:4},"aria-label":`Directional pad`,children:[(0,y.jsx)(`div`,{}),(0,y.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move up`,onPointerDown:e=>{e.preventDefault(),S(`up`)},children:`â–²`}),(0,y.jsx)(`div`,{}),(0,y.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move left`,onPointerDown:e=>{e.preventDefault(),S(`left`)},children:`â—€`}),(0,y.jsx)(`button`,{className:`km-dpad-btn`,style:{...J,opacity:.9},"aria-label":`Hold to Channel (if on altar)`,onPointerDown:e=>{e.preventDefault(),C()},title:`Channel one breath to convert points â†’ Î¦`,children:`âŸ`}),(0,y.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move right`,onPointerDown:e=>{e.preventDefault(),S(`right`)},children:`â–¶`}),(0,y.jsx)(`div`,{}),(0,y.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move down`,onPointerDown:e=>{e.preventDefault(),S(`down`)},children:`â–¼`}),(0,y.jsx)(`div`,{})]}),w&&(0,y.jsx)(`button`,{className:`km-chan-btn`,onClick:()=>{o(),p(e=>e.channelingUntil?e:{...e,channelingUntil:performance.now()+z})},"aria-label":`Channel points into Phi`,title:`Channel one breath to convert points â†’ Î¦`,children:`âŸ CHANNEL`}),f.channelingUntil>0&&(0,y.jsx)(`button`,{className:`km-chan-cancel`,onClick:()=>{o(),p(e=>({...e,channelingUntil:0}))},"aria-label":`Cancel channeling`,title:`Cancel`,children:`Cancel`})]}),(0,y.jsxs)(`div`,{className:`km-footer`,children:[(0,y.jsx)(`button`,{className:`km-btn`,onClick:n,title:`Back`,children:`Back`}),(0,y.jsx)(`div`,{className:`km-hint`,children:b})]})]})};function Ie(e,t,n,r,i){e.save(),e.fillStyle=i,e.beginPath(),e.arc(t,n,r,0,Math.PI*2),e.fill(),e.strokeStyle=`rgba(255,255,255,0.35)`,e.lineWidth=1.25,e.stroke(),e.restore()}function Le(e,t,n,r,i){e.save(),e.fillStyle=i,e.beginPath(),e.arc(t,n,r,Math.PI,0),e.lineTo(t+r,n+r*.85),e.lineTo(t-r,n+r*.85),e.closePath(),e.fill(),e.fillStyle=`#fff`,e.beginPath(),e.arc(t-r*.35,n-r*.15,r*.16,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+r*.35,n-r*.15,r*.16,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(0,0,0,0.7)`,e.beginPath(),e.arc(t-r*.3,n-r*.15,r*.08,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+r*.3,n-r*.15,r*.08,0,Math.PI*2),e.fill(),e.restore()}function Re(e,t,n){let r=Math.min(460,Math.max(220,t*.5)),i=t/2,a=r/2;e.save(),e.globalAlpha=.35,e.strokeStyle=`rgba(0,255,208,.6)`,e.lineWidth=2,e.beginPath(),e.moveTo(i-a,20),e.lineTo(i+a,20),e.stroke();let o=ze(r*L*2);e.globalAlpha=.2,e.fillStyle=`#ffd36e`,e.fillRect(i-o,17,o*2,6),e.globalAlpha=.9,e.fillStyle=`#00ffd0`;let s=i-a+n*r;e.beginPath(),e.arc(s,20,4,0,Math.PI*2),e.fill(),e.restore()}function ze(e){return e/2}function Be(e,t,n){e.save(),e.globalAlpha=.08,e.strokeStyle=`rgba(255,255,255,0.15)`,e.lineWidth=1;let r=t/2,i=n/2,a=(1+Math.sqrt(5))/2,o=4;for(let s=0;s<8;s++){let s=Math.min(t,n)/o;e.beginPath(),e.arc(r,i,s,-Math.PI/2,Math.PI),e.stroke(),o*=a}e.restore()}var J={background:`linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04))`,border:`1px solid rgba(255,255,255,0.25)`,borderRadius:10,color:`rgba(255,255,255,0.9)`,fontSize:18,lineHeight:1,padding:0,display:`flex`,alignItems:`center`,justifyContent:`center`,minWidth:36,minHeight:36,touchAction:`none`};(()=>{let e=Array.from({length:31},()=>Array.from({length:28},()=>2));for(let t=0;t<28;t++)e[0][t]=1,e[30][t]=1;for(let t=0;t<31;t++)e[t][0]=1,e[t][27]=1;for(let t=4;t<24;t+=6)for(let n=4;n<27;n+=6)e[n][t]=1,e[n][t+1]=1,e[n+1][t]=1,e[n+1][t+1]=1;for(let t=2;t<26;t++)e[15][t]=0;e[1][1]=3,e[1][26]=3,e[29][1]=3,e[29][26]=3;for(let t=2;t<29;t++)e[t][14]=0;for(let t=2;t<26;t++)e[11][t]=0;return e})();var Ve=5236,Y=3,He=Y*2,Ue=2,We=.15,Ge=220,Ke=60,qe=20;function Je(e){return(Math.imul(e^2654435769,2654435761)>>>0)%1e5/1e5}function Ye(e,t){let n=Math.abs(e-t)%360;return n>180&&(n=360-n),n}var Xe=({currentPhi:e,onPhiChange:t})=>{let[n,r]=(0,d.useState)(`forge`),[i,a]=(0,d.useState)(null),[o,s]=(0,d.useState)(performance.now()),[c,l]=(0,d.useState)(0),[u,f]=(0,d.useState)(!1),[p,m]=(0,d.useState)(null),[h,g]=(0,d.useState)(0);ee({onPulse:e=>{a(e),s(performance.now()),m(e=>e&&{...e,delta:e.delta})}}),(0,d.useEffect)(()=>{if(n!==`forge`)return;let e=0,t=!0,r=()=>{if(!t)return;let n=performance.now();l(Math.max(0,n-o)%Ve/Ve*360%360),e=requestAnimationFrame(r)};return e=requestAnimationFrame(r),()=>{t=!1,cancelAnimationFrame(e)}},[o,n]);let _=(0,d.useMemo)(()=>{let e=i??0,t=Math.floor(Je(e)*360),n=Ke+(e%2==0?qe:0)-Math.min(20,Math.floor(h*6));return{centerDeg:t,halfWidthDeg:Math.max(10,n/2)}},[i,h]),v=(0,d.useMemo)(()=>n===`forge`&&!u&&e>=Y&&i!==null,[n,u,e,i]),b=(0,d.useCallback)(e=>{let t=He,n=1+h*We,r=e?Ue:1;return Math.floor(t*n*r)},[h]),x=(0,d.useCallback)(()=>{if(!v)return;let n=e-Y;t(n),f(!0),m(null);let r=Ye(c,_.centerDeg),i=Math.max(4,_.halfWidthDeg*.25),a=r<=_.halfWidthDeg,o=a&&r<=i;window.setTimeout(()=>{if(a){let e=b(o);t(n+e),g(e=>e+1),m({kind:o?`crit`:`hit`,delta:e})}else g(0),m({kind:`miss`,delta:-Y});f(!1)},650)},[v,e,t,c,_.centerDeg,_.halfWidthDeg,b]);return(0,d.useEffect)(()=>{if(n!==`forge`)return;let e=e=>{let t=e.key.toLowerCase();(t===` `||t===`enter`)&&(e.preventDefault(),x())};return window.addEventListener(`keydown`,e),()=>window.removeEventListener(`keydown`,e)},[n,x]),(0,y.jsx)(`div`,{className:`pf-wrap`,role:`group`,"aria-label":`Pulse Forge`,children:n===`forge`?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(`div`,{className:`pf-header`,children:[(0,y.jsx)(`div`,{className:`pf-title`,children:`âš’ï¸ Pulse Forge`}),(0,y.jsx)(`div`,{className:`pf-sub`,children:`Time your lock to the target arc. Breathe, focus, forge.`}),(0,y.jsx)(`div`,{style:{marginLeft:`auto`,display:`flex`,gap:8},children:(0,y.jsx)(`button`,{type:`button`,className:`pf-lock-btn`,onClick:()=>r(`maze`),title:`Switch to Kai-Maze`,children:`Play Kai-Maze`})})]}),(0,y.jsxs)(`div`,{className:`pf-board`,children:[(0,y.jsxs)(`div`,{className:`pf-dial`,style:{width:Ge,height:Ge},children:[(0,y.jsx)(`div`,{className:`pf-arc`,style:{"--arc-center":`${_.centerDeg}deg`,"--arc-half":`${_.halfWidthDeg}deg`},"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`pf-marker ${u?`pf-marker--lock`:``}`,style:{transform:`rotate(${c}deg)`},"aria-hidden":!0,children:(0,y.jsx)(`div`,{className:`pf-marker-head`})}),(0,y.jsx)(`div`,{className:`pf-rim`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`pf-ticks`,"aria-hidden":!0,children:Array.from({length:12}).map((e,t)=>(0,y.jsx)(`span`,{style:{transform:`rotate(${t*30}deg)`}},t))})]}),(0,y.jsxs)(`div`,{className:`pf-hud`,children:[(0,y.jsxs)(`div`,{className:`pf-chip`,title:`Your Î¦`,children:[(0,y.jsx)(`span`,{className:`pf-chip__label`,children:`Î¦`}),(0,y.jsx)(`span`,{className:`pf-chip__val`,children:e})]}),(0,y.jsxs)(`div`,{className:`pf-chip`,title:`Streak`,children:[(0,y.jsx)(`span`,{className:`pf-chip__label`,children:`Streak`}),(0,y.jsx)(`span`,{className:`pf-chip__val`,children:h})]}),(0,y.jsxs)(`div`,{className:`pf-chip`,title:`Pulse`,children:[(0,y.jsx)(`span`,{className:`pf-chip__label`,children:`Pulse`}),(0,y.jsx)(`span`,{className:`pf-chip__val`,children:i??`â€”`})]})]})]}),(0,y.jsxs)(`div`,{className:`pf-cta`,children:[(0,y.jsx)(`button`,{className:`pf-lock-btn`,onClick:x,disabled:!v,"aria-disabled":!v,title:v?`Press Space/Enter to Lock`:`Insufficient Î¦ or syncingâ€¦`,children:u?`Lockingâ€¦`:`Lock (âˆ’${Y} Î¦)`}),(0,y.jsxs)(`div`,{className:`pf-hint`,children:[`Press `,(0,y.jsx)(`kbd`,{children:`Space`}),` or `,(0,y.jsx)(`kbd`,{children:`Enter`}),` at the right moment. Even pulses widen the target.`]})]}),p&&(0,y.jsxs)(`div`,{className:`pf-result pf-result--${p.kind}`,role:`status`,"aria-live":`polite`,children:[p.kind===`hit`&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(`span`,{className:`pf-result__emoji`,children:`âœ…`}),(0,y.jsxs)(`span`,{className:`pf-result__text`,children:[`Resonant lock! +`,p.delta,` Î¦`]})]}),p.kind===`crit`&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(`span`,{className:`pf-result__emoji`,children:`ðŸ’¥`}),(0,y.jsxs)(`span`,{className:`pf-result__text`,children:[`Perfect lock! +`,p.delta,` Î¦`]})]}),p.kind===`miss`&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(`span`,{className:`pf-result__emoji`,children:`âŒ`}),(0,y.jsx)(`span`,{className:`pf-result__text`,children:`Miss â€” breathe again.`})]})]})]}):(0,y.jsx)(Fe,{currentPhi:e,onPhiChange:t,onExit:()=>r(`forge`)})})};function Ze(){return`kai-${Math.random().toString(36).slice(2,8)}`}function Qe(e){if(typeof e!=`object`||!e)return!1;let t=e;return typeof t.x==`number`&&typeof t.pulseIndex==`number`&&typeof t.chakraDay==`string`&&typeof t.glyph==`object`&&t.glyph!==null}var $e=null;async function et(){return $e||($e=(await r(()=>import(`./bundler-IMYm8BQv.js`),__vite__mapDeps([0,1,2]))).default,$e)}function tt(e){let[t]=(0,d.useState)(()=>e??Ze()),[n,r]=(0,d.useState)([]),[i,a]=(0,d.useState)([]),o=(0,d.useRef)(null),s=(0,d.useRef)({}),c=(0,d.useCallback)((e,t)=>{if(!Qe(t))return;let n={...t,id:e,glyph:t.glyph};a(t=>{let r=t.findIndex(t=>t.id===e);if(r>=0){let e=[...t];return e[r]=n,e}return[...t,n]})},[]),l=(0,d.useCallback)((e,t)=>{Qe(e)&&c(t,e)},[c]);return(0,d.useEffect)(()=>{let e=!1;return(async()=>{let n=await et();if(e)return;let i=new n(t);o.current=i,i.on(`open`,()=>{r(e=>e)}),i.on(`connection`,e=>{s.current[e.peer]=e,r(t=>Array.from(new Set([...t,e.peer]))),e.on(`data`,t=>{l(t,e.peer)}),e.on(`close`,()=>{delete s.current[e.peer],r(t=>t.filter(t=>t!==e.peer)),a(t=>t.filter(t=>t.id!==e.peer))})})})().catch(e=>{console.error(`[KaiRealms] Peer init failed:`,e)}),()=>{e=!0;try{o.current?.destroy()}catch(e){console.warn(`[KaiRealms] Peer destroy failed:`,e)}o.current=null,s.current={},r([]),a([])}},[t,l]),{sessionId:t,peers:n,sendState:(0,d.useCallback)(e=>{let t=Object.values(s.current);for(let n of t)n.open&&n.send(e)},[]),remoteStates:i}}var nt=800,rt=500,it=nt/rt,X=28,Z=10,at=360,ot=10,Q=5236,st=.08,ct=22,lt=90,ut=80,dt=2,ft=4,pt=10,mt=3,ht=1,gt=3,_t=1,vt=1,$=(e,t,n)=>e<t?t:e>n?n:e,yt=({glyphData:e,onExit:t})=>{let n=(0,d.useRef)(null),r=(0,d.useRef)(null),i=(0,d.useRef)(null),[a,o]=(0,d.useState)({w:nt,h:rt}),s=(0,d.useRef)(a);(0,d.useEffect)(()=>{s.current=a},[a]);let[c,l]=(0,d.useState)(0),[u,f]=(0,d.useState)(0),[p,m]=(0,d.useState)(!1),[h,g]=(0,d.useState)(mt),[_,v]=(0,d.useState)(0),[b,x]=(0,d.useState)(0),[S,C]=(0,d.useState)(!1),w=(0,d.useRef)(performance.now()),{sendState:T,remoteStates:E}=tt(),D=(0,d.useRef)([]);(0,d.useEffect)(()=>{D.current=E??[]},[E]);let O=(0,d.useRef)(nt/2),k=(0,d.useRef)([]),A=(0,d.useRef)({}),j=(0,d.useRef)(null),M=(0,d.useRef)(null),N=(0,d.useRef)(null),P=(0,d.useRef)(0),te=(0,d.useRef)(0),F=(0,d.useRef)(null);(0,d.useEffect)(()=>{let e=n.current;if(!e)return;let t=new ResizeObserver(e=>{let t=e[0].contentRect,n=Math.max(320,Math.min(960,t.width));o({w:n,h:Math.round(n/it)})});return t.observe(e),()=>t.disconnect()},[]),(0,d.useEffect)(()=>{let e=r.current;if(!e)return;let t=e.getContext(`2d`);if(!t)return;let n=Math.min(2,window.devicePixelRatio||1);e.style.width=`${a.w}px`,e.style.height=`${a.h}px`,e.width=Math.floor(a.w*n),e.height=Math.floor(a.h*n),t.setTransform(n,0,0,n,0,0),i.current=t,O.current=$(O.current,X,a.w-X)},[a]),(0,d.useEffect)(()=>{let e=e=>{A.current[e.key]=!0,e.key.toLowerCase()===`p`&&m(e=>!e),e.key.toLowerCase()===`r`&&S&&R()},t=e=>{A.current[e.key]=!1};return window.addEventListener(`keydown`,e),window.addEventListener(`keyup`,t),()=>{window.removeEventListener(`keydown`,e),window.removeEventListener(`keyup`,t)}},[S]),(0,d.useEffect)(()=>{let e=r.current;if(!e)return;let t=t=>{let n=e.getBoundingClientRect();return $((t-n.left)/n.width*s.current.w,X,s.current.w-X)},n=!1,i=e=>{n=!0,O.current=t(e.clientX)},a=e=>{n&&(O.current=t(e.clientX))},o=()=>{n=!1};return e.addEventListener(`pointerdown`,i),e.addEventListener(`pointermove`,a),window.addEventListener(`pointerup`,o),()=>{e.removeEventListener(`pointerdown`,i),e.removeEventListener(`pointermove`,a),window.removeEventListener(`pointerup`,o)}},[]);let ne=e=>Math.max(0,e-w.current)%Q/Q,re=e=>{let t=Math.sin(Math.PI*e);return .65+.7*(t*t)},I=e=>{let{w:t}=s.current,n=performance.now(),r=Math.random()*(t-2*Z)+Z,i=-Z*2,a=(Math.random()-.5)*40,o=(e===`gold`?ut:lt)+_*(pt*.2),c={id:`${e}-${n}-${Math.floor(Math.random()*1e6)}`,x:r,y:i,vx:a,baseVy:o,kind:e,bornAt:n},l=k.current.slice(-(ct-1));l.push(c),k.current=l};ee({onPulse:e=>{f(e),w.current=performance.now(),te.current+=1;for(let e=0;e<dt;e++)I(`basic`);te.current%ft===0&&I(`gold`)}});let L=t=>{let n=N.current,r=O.current,i=u;if(!n||Math.abs(n.x-r)>=1||n.pulseIndex!==i||t-P.current>1e3/ot){N.current={x:r,pulseIndex:i},P.current=t;try{T({id:`you`,x:r,pulseIndex:i,chakraDay:e.meta.chakraDay,glyph:e})}catch{}}};(0,d.useEffect)(()=>{let t=r.current,n=i.current;if(!t||!n)return;let a=!0,o=t=>{if(!a)return;j.current=requestAnimationFrame(o);let r=M.current??t,i=Math.min(.05,(t-r)/1e3);M.current=t;let{w:c,h:u}=s.current,d=u-X-10;if(!p&&!S){let e=A.current,n=!!(e.ArrowLeft||e.a||e.A),r=!!(e.ArrowRight||e.d||e.D);n&&(O.current=$(O.current-at*i,X,c-X)),r&&(O.current=$(O.current+at*i,X,c-X));let a=O.current,o=performance.now(),s=ne(o),f=re(s),p=[],m=0,h=0,y=0;for(let e=0;e<k.current.length;e++){let t=k.current[e],n=(t.baseVy+_*(pt*.15))*f;t.x+=t.vx*i,t.y+=n*i,t.x<Z&&(t.x=Z,t.vx=Math.abs(t.vx)*.9),t.x>c-Z&&(t.x=c-Z,t.vx=-Math.abs(t.vx)*.9);let r=t.x-a,l=t.y-d;if(Math.hypot(r,l)<X+Z){let e=t.kind===`gold`?gt:_t;m+=e,Math.abs(s-.5)<=st?(h+=vt,F.current={t:o,x:a,kind:`perfect`}):F.current={t:o,x:a,kind:`good`};continue}if(t.y>u+Z){y+=1;continue}p.push(t)}if(m>0||h>0){let e=m+h;l(t=>t+e),v(e=>{let t=e+1;return x(e=>t>e?t:e),t})}y>0&&(l(e=>Math.max(0,e-ht*y)),v(0),g(e=>{let t=Math.max(0,e-y);return t===0&&C(!0),t})),k.current=p,L(t)}bt(n,e,O.current,d,p||S,k.current,D.current,s.current,w.current,F.current)};return j.current=requestAnimationFrame(o),()=>{a=!1,j.current!==null&&cancelAnimationFrame(j.current),j.current=null,M.current=null}},[e,p,S,a.w,a.h]);let R=()=>{k.current=[],g(mt),v(0),x(e=>e),C(!1)},ie=(0,d.useMemo)(()=>({pulse:u,chakraDay:e?.meta?.chakraDay??`â€”`}),[u,e?.meta?.chakraDay]);return(0,y.jsxs)(`div`,{className:`realm-wrap`,ref:n,children:[(0,y.jsxs)(`div`,{className:`realm-hud`,children:[(0,y.jsxs)(`div`,{className:`hud-chip hud-chip--score`,title:`Banked Î¦`,children:[(0,y.jsx)(`span`,{className:`hud-chip__label`,children:`Î¦`}),(0,y.jsx)(`span`,{className:`hud-chip__value`,children:c})]}),(0,y.jsxs)(`div`,{className:`hud-chip`,title:`Streak`,children:[(0,y.jsx)(`span`,{className:`hud-chip__label`,children:`Streak`}),(0,y.jsx)(`span`,{className:`hud-chip__value`,children:_})]}),(0,y.jsxs)(`div`,{className:`hud-chip`,title:`Lives`,children:[(0,y.jsx)(`span`,{className:`hud-chip__label`,children:`Lives`}),(0,y.jsx)(`span`,{className:`hud-chip__value`,children:h})]}),(0,y.jsxs)(`div`,{className:`hud-chip`,title:`Current Pulse`,children:[(0,y.jsx)(`span`,{className:`hud-chip__label`,children:`Pulse`}),(0,y.jsx)(`span`,{className:`hud-chip__value`,children:ie.pulse})]}),(0,y.jsxs)(`div`,{className:`hud-chip`,title:`Chakra Day`,children:[(0,y.jsx)(`span`,{className:`hud-chip__label`,children:`Day`}),(0,y.jsx)(`span`,{className:`hud-chip__value`,children:ie.chakraDay})]}),(0,y.jsx)(`button`,{className:`hud-button`,onClick:()=>m(e=>!e),"aria-pressed":p,title:`Pause (P)`,children:p?`Resume`:`Pause`})]}),(0,y.jsxs)(`div`,{className:`realm-canvas-wrap`,children:[(0,y.jsx)(`canvas`,{ref:r,className:`realm-canvas`,"aria-label":`Kai Realms Canvas`}),(p||S)&&(0,y.jsx)(`div`,{className:`realm-pause-overlay`,"aria-hidden":!0,children:(0,y.jsxs)(`div`,{className:`pause-card`,children:[(0,y.jsx)(`div`,{className:`pause-title`,children:S?`Game Over`:`Paused`}),(0,y.jsx)(`div`,{className:`pause-sub`,children:S?(0,y.jsxs)(y.Fragment,{children:[`Best Streak: `,(0,y.jsx)(`strong`,{children:b}),` â€” Press `,(0,y.jsx)(`kbd`,{children:`R`}),` to Restart`]}):(0,y.jsxs)(y.Fragment,{children:[`Press `,(0,y.jsx)(`kbd`,{children:`P`}),` or click Resume`]})}),S&&(0,y.jsx)(`button`,{className:`hud-button`,onClick:R,style:{marginTop:12},children:`Restart`})]})})]}),(0,y.jsx)(Xe,{currentPhi:c,onPhiChange:e=>l(e)}),(0,y.jsx)(`button`,{className:`exit-button`,onClick:t,children:`Exit Realm`})]})};function bt(e,t,n,r,i,a,o,s,c,l){let{w:u,h:d}=s,f=e.createLinearGradient(0,0,0,d);f.addColorStop(0,`#020211`),f.addColorStop(1,`#0b0f2a`),e.fillStyle=f,e.fillRect(0,0,u,d),e.save(),e.globalAlpha=.12;for(let t=0;t<40;t++){let n=t*197%u+t%3,r=t*127%d+t*11%7;e.fillStyle=`white`,e.fillRect(n,r,2,2)}e.restore(),xt(e,u,Math.max(36,Math.round(d*.06)),c);for(let t=0;t<a.length;t++)St(e,a[t]);k(e,t,n,r,X);for(let t=0;t<o.length;t++){let n=o[t];k(e,n.glyph,$(n.x,X,u-X),r,X)}if(l){let t=performance.now()-l.t;if(t<650){let n=1-t/650;e.save(),e.globalAlpha=n,e.fillStyle=l.kind===`perfect`?`#ffd36e`:`#00ffd0`,e.font=`bold 16px ui-sans-serif,system-ui,Segoe UI,Roboto`,e.textAlign=`center`,e.fillText(l.kind===`perfect`?`Perfect Breath!`:`+Î¦`,l.x,r-X-16),e.restore()}}e.save();let p=e.createLinearGradient(0,r+X+6,0,r+X+18);p.addColorStop(0,`rgba(0,255,208,0.25)`),p.addColorStop(1,`rgba(0,255,208,0.0)`),e.fillStyle=p,e.fillRect(0,r+X+6,u,12),e.restore(),i&&(e.save(),e.fillStyle=`rgba(0,0,0,.35)`,e.fillRect(0,0,u,d),e.restore())}function xt(e,t,n,r){let i=(performance.now()-r)%Q/Q,a=t/2,o=Math.round(n*.6),s=Math.min(420,Math.max(200,Math.round(t*.5))),c=s/2;e.save(),e.globalAlpha=.35,e.strokeStyle=`rgba(0,255,208,.5)`,e.lineWidth=2,e.beginPath(),e.moveTo(a-c,o),e.lineTo(a+c,o),e.stroke();let l=a-c+i*s;e.globalAlpha=.9,e.fillStyle=`#00ffd0`,e.beginPath(),e.arc(l,o,4,0,Math.PI*2),e.fill(),e.globalAlpha=.25,e.fillStyle=`#ffd36e`;let u=a,d=s*st;e.fillRect(u-d,o-3,d*2,6),e.restore()}function St(e,t){e.save();let n=Z;e.globalAlpha=.35;let r=e.createLinearGradient(t.x,t.y-12,t.x,t.y+n);r.addColorStop(0,`rgba(0,255,208,0.0)`),r.addColorStop(1,t.kind===`gold`?`rgba(255,211,110,0.35)`:`rgba(0,255,208,0.35)`),e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y-12),e.lineTo(t.x,t.y+n*.2),e.stroke(),e.globalAlpha=1;let i=e.createRadialGradient(t.x,t.y,n*.15,t.x,t.y,n);i.addColorStop(0,`#fff`),t.kind===`gold`?(i.addColorStop(.5,`#ffd36e`),i.addColorStop(1,`rgba(255,211,110,0.0)`)):(i.addColorStop(.5,`#00ffd0`),i.addColorStop(1,`rgba(0,255,208,0.0)`)),e.fillStyle=i,e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),e.strokeStyle=t.kind===`gold`?`rgba(255,211,110,.75)`:`rgba(0,255,208,.65)`,e.lineWidth=1.25,e.stroke(),e.restore()}var Ct=({onClose:t})=>{let[n,r]=(0,d.useState)(null),i=(0,d.useRef)(null),a=(0,d.useRef)(null),o=(0,d.useCallback)(e=>r(e),[]),s=(0,d.useCallback)(()=>{r(null),t?.()},[t]);(0,d.useEffect)(()=>{let e=e=>{e.key===`Escape`&&t?.()};return document.addEventListener(`keydown`,e),a.current?.focus(),()=>document.removeEventListener(`keydown`,e)},[t]),(0,d.useEffect)(()=>{let e=i.current;if(!e)return;let t=e=>e.stopPropagation();return e.addEventListener(`wheel`,t,{passive:!0}),()=>e.removeEventListener(`wheel`,t)},[]);let c=()=>t?.(),l=e=>e.stopPropagation();return(0,y.jsxs)(`div`,{className:`realms-backdrop realms-veil`,role:`dialog`,"aria-modal":`true`,"aria-labelledby":`kai-realms-title`,onMouseDown:c,children:[(0,y.jsx)(`div`,{className:`realms-stars`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`realms-halo realms-halo--1`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`realms-halo realms-halo--2`,"aria-hidden":!0}),(0,y.jsxs)(`div`,{ref:i,className:`realms-container glass-omni`,onMouseDown:l,role:`document`,children:[(0,y.jsx)(`div`,{className:`breath-ring breath-ring--outer`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`breath-ring breath-ring--inner`,"aria-hidden":!0}),(0,y.jsx)(`div`,{className:`phi-grid`,"aria-hidden":!0}),(0,y.jsxs)(`header`,{className:`realms-header`,children:[(0,y.jsx)(`button`,{ref:a,type:`button`,className:`realms-close auric-btn`,"aria-label":`Close Kai Realms`,onClick:e=>{e.stopPropagation(),t?.()},onMouseDown:e=>e.stopPropagation(),onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),e.stopPropagation(),t?.())},children:(0,y.jsx)(e,{size:20,"aria-hidden":!0})}),(0,y.jsx)(`div`,{className:`header-seals`,"aria-hidden":!0,children:(0,y.jsxs)(`div`,{className:`seal-emblem`,children:[(0,y.jsx)(`div`,{className:`seal-ring`}),(0,y.jsx)(`div`,{className:`seal-ring seal-ring--inner`}),(0,y.jsx)(`div`,{className:`seal-core`})]})}),(0,y.jsx)(`h2`,{id:`kai-realms-title`,className:`sr-only`,children:`Kai Realms â€” Sigil Gate`})]}),(0,y.jsx)(`main`,{className:`realms-body`,children:n?(0,y.jsx)(`div`,{className:`realm-stage`,children:(0,y.jsx)(yt,{glyphData:n,onExit:s})}):(0,y.jsx)(`div`,{className:`portal-stage`,children:(0,y.jsx)(x,{onEnter:o})})}),(0,y.jsx)(`footer`,{className:`realms-footer`,"aria-hidden":!0,children:(0,y.jsx)(`div`,{className:`footer-center`,style:{margin:`0 auto`},children:(0,y.jsx)(wt,{})})})]})]})};function wt(){return(0,y.jsxs)(`svg`,{className:`seal-coin`,width:`56`,height:`56`,viewBox:`0 0 56 56`,"aria-hidden":!0,children:[(0,y.jsxs)(`defs`,{children:[(0,y.jsxs)(`radialGradient`,{id:`coinGlowRealms`,cx:`50%`,cy:`50%`,r:`50%`,children:[(0,y.jsx)(`stop`,{offset:`0%`,stopColor:`#ffffff`,stopOpacity:`0.9`}),(0,y.jsx)(`stop`,{offset:`40%`,stopColor:`#ffd86b`,stopOpacity:`0.75`}),(0,y.jsx)(`stop`,{offset:`100%`,stopColor:`#ffd86b`,stopOpacity:`0.15`})]}),(0,y.jsxs)(`linearGradient`,{id:`coinEdgeRealms`,x1:`0`,y1:`0`,x2:`1`,y2:`1`,children:[(0,y.jsx)(`stop`,{offset:`0%`,stopColor:`#00ffd0`,stopOpacity:`0.8`}),(0,y.jsx)(`stop`,{offset:`100%`,stopColor:`#8a2be2`,stopOpacity:`0.8`})]})]}),(0,y.jsx)(`circle`,{cx:`28`,cy:`28`,r:`26`,fill:`url(#coinGlowRealms)`,stroke:`url(#coinEdgeRealms)`,strokeWidth:`1.5`}),(0,y.jsxs)(`g`,{className:`seal-coin__rotor`,children:[(0,y.jsx)(`circle`,{cx:`28`,cy:`28`,r:`18`,fill:`none`,stroke:`url(#coinEdgeRealms)`,strokeWidth:`1.25`}),(0,y.jsxs)(`g`,{stroke:`rgba(255,255,255,0.35)`,strokeWidth:`0.6`,children:[(0,y.jsx)(`line`,{x1:`28`,y1:`10`,x2:`28`,y2:`46`}),(0,y.jsx)(`line`,{x1:`10`,y1:`28`,x2:`46`,y2:`28`}),(0,y.jsx)(`line`,{x1:`15`,y1:`15`,x2:`41`,y2:`41`}),(0,y.jsx)(`line`,{x1:`41`,y1:`15`,x2:`15`,y2:`41`})]})]}),(0,y.jsx)(`circle`,{className:`seal-coin__core`,cx:`28`,cy:`28`,r:`6.5`})]})}export{Ct as default};