import{Ct as e,gt as t,mt as n}from"./index-DbHHjBj8.js";function r(t,n,r){let i=`glyph::${n}::${Math.random().toString(36).slice(2,10)}`,a={...t.metadata??{},...r??{},kaiSignature:i,timestamp:Date.now()},o={hash:i,pulseCreated:n,pulseGenesis:t.pulseGenesis??t.pulseCreated,parentHash:t.hash,sentFrom:t.hash,value:1,inhaled:{},metadata:a},s=(t.sentTo??[]).map(e=>({senderSignature:t.metadata?.kaiSignature??t.hash,senderStamp:t.hash,senderKaiPulse:e.pulseSent,receiverSignature:e.recipientHash})),{unsigned:c}=e({pulse:n,kaiSignature:i,seriesSize:1,quality:`med`,creatorVerified:!1,creatorRep:0,transfers:s,cumulativeTransfers:s.length},n);return o.value=c.valuePhi,o}function i(e){let t=(e??``).trim();return t?t.replace(/^@+/,``).replace(/[\s_]+/g,` `).trim().toLowerCase().replace(/[.,;:!?]+$/g,``):``}function a(e){let t=(e??``).trim();if(!t)return``;if(/^[0-9a-f]{64}$/i.test(t))return t.toLowerCase();if(/^[A-Za-z0-9_-]{16,}$/u.test(t))return n(t);try{let e=new URL(t),r=e.pathname||``,i=r.match(/\/(?:stream|feed)\/p\/([^/?#]+)/u)||r.match(/\/p\/([^/?#]+)/u)||r.match(/\/p(?:\u007e|%7[Ee])\/?([^/?#]+)/u);if(i?.[1])return n(i[1]);let a=e.hash&&e.hash.startsWith(`#`)?e.hash.slice(1):``,o=new URLSearchParams(a),s=e.searchParams;for(let e of[`t`,`p`,`token`,`capsule`]){let t=o.get(e);if(t)return n(t);let r=s.get(e);if(r)return n(r)}}catch{}return``}function o(e,n,r){let a=i(n);if(!a)throw Error(`Username required for claim payload`);return{kind:t,username:n.trim(),normalized:a,originHash:e,ownerHint:r??null}}function s(e){let t=o(e.origin.hash,e.username,e.ownerHint??e.origin.meta?.userPhiKey??e.origin.metadata?.creator??null),n={...e.origin.metadata??{},usernameClaim:t};return r(e.origin,e.pulse,n)}var c=typeof window<`u`,l=`kai:username-claims:v1`,u=`kai-username-claims`,d=`username-claim:registered`,f=`username-claim`,p={};function m(e){return Object.fromEntries(Object.entries(e))}function h(e){let t=(e??``).trim();if(!t)return null;if(!c)return t;try{return new URL(t,window.location?.origin??void 0).toString()}catch{return t}}function g(){if(!c)return m(p);try{let e=window.localStorage.getItem(l);if(!e)return p={},{};let t=JSON.parse(e);if(!t||typeof t!=`object`)return{};let n=t,r={};for(let[e,t]of Object.entries(n))!t||typeof t!=`object`||typeof t.normalized!=`string`||typeof t.claimHash!=`string`||(r[e]=t);return p=m(r),m(r)}catch{return m(p)}}function _(e){if(p=m(e),c)try{window.localStorage.setItem(l,JSON.stringify(e))}catch{}}var v=null;function y(){return!c||!(`BroadcastChannel`in window)?null:v||(v=new BroadcastChannel(u),v)}function b(e){let t=g(),n=t[e.normalized];return n&&n.claimHash!==e.claimHash?!1:n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?!0:(t[e.normalized]=e,_(t),!0)}function x(e){if(c){try{let t=new CustomEvent(d,{detail:e});window.dispatchEvent(t)}catch{}try{y()?.postMessage({type:f,entry:e})}catch{}}}function S(e,t){let n=t.payload;if(!n||n.kind!==`username_claim`)return{updated:!1,reason:`not a username-claim glyph`};let r=a(t.hash);if(!r)return{updated:!1,reason:`missing glyph hash`};let o=i(n.normalized||n.username);if(!o)return{updated:!1,reason:`missing username`};let s=e[o];if(s&&s.claimHash!==r)return{updated:!1,reason:`username already bound`};let c=h(t.url??``);if(!c)return{updated:!1,reason:`missing claim url`};let l=t.ownerHint??n.ownerHint??null,u={username:n.username,normalized:o,claimHash:r,claimUrl:c,originHash:n.originHash,ownerHint:l,updatedAt:Date.now()},d=s&&s.claimHash===u.claimHash&&s.claimUrl===u.claimUrl&&s.originHash===u.originHash&&s.ownerHint===u.ownerHint;return e[o]=u,{updated:!d,entry:u}}function C(e){let t=g(),{updated:n,entry:r,reason:i}=S(t,e);return n?(_(t),r&&x(r),{accepted:!0,updated:!0,registry:t}):{accepted:!!r,updated:!1,reason:i,registry:t}}function w(){return g()}function T(e){if(!c)return()=>{};let t=t=>{let n=t;n?.detail&&b(n.detail)&&e(n.detail,`event`)},n=y(),r=t=>{let n=t?.data;n?.type===f&&n.entry&&b(n.entry)&&e(n.entry,`broadcast`)},i=t=>{if(!(t.key!==l||typeof t.newValue!=`string`))try{let n=JSON.parse(t.newValue);for(let t of Object.values(n))t&&typeof t==`object`&&b(t)&&e(t,`storage`)}catch{}};return window.addEventListener(d,t),n&&n.addEventListener(`message`,r),window.addEventListener(`storage`,i),()=>{window.removeEventListener(d,t),n&&n.removeEventListener(`message`,r),window.removeEventListener(`storage`,i)}}export{a,s as i,C as n,i as o,T as r,w as t};