import{E as e,N as t,n,t as r}from"./index-BftR5qL3.js";import{F as i,d as a,h as o,l as s}from"./sigilUrl-V_6O8cFf.js";import"./valuation-fobxj7Zk.js";import{a as c,n as l,o as u,r as d,t as f}from"./usernameClaimRegistry-BZF2s8jg.js";var p=t(e(),1),m=t(r(),1),h=`https://align.kaiklok.com`,g=`http://m.kai`,_={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function v(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function y(e){let t=v(e),n=t?_[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}var ee=`kai:sigils:v1`,te=`sigil:urls`,b=`kai-sigil-registry`,ne=512,re=`/phi.svg`,x=typeof window<`u`,S=x&&window.localStorage!==void 0,C=(3+Math.sqrt(5))*1e3,w=1715323541888,T=25,E=3e4;function ie(e=j()){let t=e-w;if(!Number.isFinite(t))return 5236;let n=t/C,r=w+(Math.floor(n)+1)*C-e,i=Number.isFinite(r)?r:5236;return Math.min(E,Math.max(T,Math.round(i)))}var D=5e3,ae=24,oe=200,se=180,O=1200,ce=12e3,le=`kai:inhaleQueue:v1`,k=`kai:urlHealth:v1`,ue=18,A=2200,de=`sigil-explorer-prefetch-v1`,fe=4200,pe=`https://phi.network`,me=520,he=900,ge=80;function j(){return Date.now()}function _e(e){if(!x)return e;let t=window;return typeof t.CSS?.escape==`function`?t.CSS.escape(e):e.replace(/[^a-zA-Z0-9_-]/gu,e=>`\\${e}`)}var M=h,N=g,ve=`/sigils/seal`,ye=`/sigils/urls`,be=`/sigils/inhale`,xe=`kai:lahmahtorBase:v1`,Se=`kai:lahmahtorBackupDeadUntil:v1`,Ce=120*1e3,P=0;function we(){if(!S)return;let e=localStorage.getItem(Se);if(!e)return;let t=Number(e);Number.isFinite(t)&&t>0&&(P=t)}function Te(){if(S)try{localStorage.setItem(Se,String(P))}catch{}}function Ee(){return j()<P}function De(){P!==0&&(P=0,Te())}function Oe(){P=j()+Ce,Te(),F===N&&(F=M,Ae())}var F=M;function ke(){if(!S)return;let e=localStorage.getItem(xe);if(e===M){F=e;return}e===N&&(F=Ee()?M:e)}function Ae(){if(S)try{localStorage.setItem(xe,F)}catch{}}function je(){let e=F===N&&!Ee()?[N,M]:[M,N];if(!x)return Ee()?e.filter(e=>e!==N):e;let t=window.location.protocol===`https:`?e.filter(e=>e.startsWith(`https://`)):e;return Ee()?t.filter(e=>e!==N):t}function Me(e){return e===0||e===404||e===408||e===429||e>=500}async function Ne(e,t){let n=je(),r=null;for(let i of n){let n=e(i);try{let e=await fetch(n,t);if(r=e,e.ok||e.status===304)return i===N&&De(),F=i,Ae(),e;if(i===N&&Me(e.status)&&Oe(),!Me(e.status))return e}catch{i===N&&Oe();continue}}return r}async function Pe(e,t){let n=await Ne(e,t);if(!n)return{ok:!1,status:0};if(!n.ok)return{ok:!1,status:n.status};try{return{ok:!0,value:await n.json(),status:n.status}}catch{return{ok:!1,status:0}}}function I(){return x?window.location.origin:pe}function L(e){try{let t=I(),n=new URL(e,t);return new URL(`${n.pathname}${n.search}${n.hash}`,t).toString()}catch{return e}}function Fe(e){try{let t=new URL(e,I()).pathname.match(/\/s\/([^/]+)/u);return t?.[1]?decodeURIComponent(t[1]):void 0}catch{return}}function R(e){try{return new URL(e,I()).pathname.toLowerCase().startsWith(`/p~`)}catch{return e.toLowerCase().includes(`/p~`)}}function Ie(e){try{return decodeURIComponent(e)}catch{return e}}function Le(e){let t=e.trim();return t.length<16?!1:/^[A-Za-z0-9_-]+$/u.test(t)}function Re(e){let t=I();return new URL(`/stream/p/${e}`,t).toString()}function ze(e){let t=I(),n=new URL(`/stream`,t),r=new URLSearchParams;return r.set(`p`,e),n.hash=`#${r.toString()}`,n.toString()}function Be(e){try{let t=I(),n=new URL(e,t),r=n.pathname.match(/\/stream\/p\/([^/]+)/u);if(!r?.[1])return e;let i=decodeURIComponent(r[1]),a=new URL(`/stream`,t);a.search=n.search;let o=n.hash.startsWith(`#`)?n.hash.slice(1):``,s=new URLSearchParams(o);return s.set(`p`,i),a.hash=`#${s.toString()}`,a.toString()}catch{return e}}function z(e){try{let t=new URL(e,I()),n=t.pathname,r=n.match(/\/stream\/p\/([^/]+)/u);if(r?.[1])return decodeURIComponent(r[1]);let i=n.match(/^\/p~([^/]+)/u);if(i?.[1])return decodeURIComponent(i[1]);let a=t.searchParams.get(`p`);if(a)return a;let o=t.hash.startsWith(`#`)?t.hash.slice(1):``;return new URLSearchParams(o).get(`p`)||void 0}catch{let t=e.toLowerCase().match(/\/p~([^/?#]+)/u);return t?.[1]?Ie(t[1]):void 0}}function B(e){let t=L(e);if(R(t)){let e=z(t);return e?L(ze(e)):t}let n=Be(t);return n===t?t:L(n)}function Ve(e){if(!x)return B(e);let t=B(e),n=window.location.origin;try{let e=new URL(t,n);return`${n}${e.pathname}${e.search}${e.hash}`}catch{let e=t.match(/^(?:https?:\/\/[^/]+)?(\/.*)$/i);return`${n}${(e?.[1]??t).startsWith(`/`)?e?.[1]??t:`/${e?.[1]??t}`}`}}function He(e,t=10){return e?e.length<=t*2+3?e:`${e.slice(0,t)}…${e.slice(-t)}`:`—`}function V(e,t){return(e.pulse??0)===(t.pulse??0)?(e.beat??0)===(t.beat??0)?(e.stepIndex??0)-(t.stepIndex??0):(e.beat??0)-(t.beat??0):(e.pulse??0)-(t.pulse??0)}function Ue(e){return e.toFixed(6).replace(/0+$/u,``).replace(/\.$/u,``)}function H(){return x?typeof navigator>`u`?!0:navigator.onLine:!1}function We(){return x&&typeof window.crypto?.randomUUID==`function`?window.crypto.randomUUID():Math.random().toString(16).slice(2)}function U(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function Ge(e,t){if(!U(e))return;let n=e[t];return typeof n==`string`&&n.trim()||void 0}async function Ke(e){if(!x||!H())return;let t=new AbortController,n=window.setTimeout(()=>t.abort(),fe);try{let n=await fetch(e,{method:`GET`,cache:`force-cache`,signal:t.signal});if(n&&n.ok&&`caches`in window&&typeof caches.open==`function`)try{await(await caches.open(de)).put(new Request(e),n.clone())}catch{}}catch{}finally{window.clearTimeout(n)}}var W=new Map;function qe(){if(!S)return;let e=localStorage.getItem(k);if(e)try{let t=JSON.parse(e);if(!U(t))return;W.clear();for(let[e,n]of Object.entries(t))(n===1||n===-1)&&W.set(L(e),n)}catch{}}function Je(){if(!S)return;let e={};for(let[t,n]of W)e[t]=n;try{localStorage.setItem(k,JSON.stringify(e))}catch{}}function Ye(e,t){let n=L(e);return W.get(n)===t?!1:(W.set(n,t),Je(),!0)}function Xe(e){let t=new URL(h).host,n=new URL(g).host,r=new URL(I()).host,i=new URL(pe).host;return e===t||e===n||e===r||e===i}async function Ze(e){if(!x)return`unknown`;let t=B(e),n;try{if(n=new URL(t,I()),!Xe(n.host))return`unknown`;if(n.pathname.toLowerCase()===`/stream`)return`ok`}catch{return`unknown`}try{let e=new AbortController,t=window.setTimeout(()=>e.abort(),A),r=t=>fetch(n.toString(),{method:t,cache:`no-store`,signal:e.signal,redirect:`follow`,mode:`cors`}),i;try{i=await r(`HEAD`)}catch{i=await r(`GET`)}finally{window.clearTimeout(t)}return i.ok?`ok`:`bad`}catch{return`unknown`}}function Qe(e){try{let t=new URL(e,I()),n=t.pathname.toLowerCase();if(n.includes(`/s/`))return`postS`;if(n.startsWith(`/p~`))return`streamP`;if(!n.includes(`/stream`))return`other`;if(n.includes(`/stream/p/`))return`streamP`;let r=t.searchParams.get(`t`);if(r&&r.trim())return`streamT`;let i=t.hash.startsWith(`#`)?t.hash.slice(1):``,a=new URLSearchParams(i),o=a.get(`t`);if(o&&o.trim()||n.includes(`/stream/t`))return`streamT`;let s=t.searchParams.get(`p`);if(s&&s.trim())return`streamQ`;let c=a.get(`p`);return c&&c.trim()?`streamQ`:`stream`}catch{let t=e.toLowerCase();return t.includes(`/s/`)?`postS`:t.includes(`/p~`)||t.includes(`/stream/p/`)?`streamP`:t.includes(`/stream/t`)||/[?&#]t=/.test(t)?`streamT`:t.includes(`/stream`)&&/[?&#]p=/.test(t)?`streamQ`:t.includes(`/stream`)?`stream`:`other`}}function $e(e){let t=Qe(e);return t===`postS`?`post`:t.startsWith(`stream`)?`stream`:`other`}function et(e){let t=e;return typeof t.userPhiKey==`string`&&t.userPhiKey||typeof t.phiKey==`string`&&t.phiKey||typeof t.phikey==`string`&&t.phikey||``}function tt(e,t){let n=et(t),r=Number.isFinite(t.pulse??NaN)?t.pulse:null;if(n&&r!=null)return`k:${n}|${r}`;let i=typeof t.kaiSignature==`string`?t.kaiSignature.trim():``;if(i)return`sig:${i}`;let a=z(e);if(a&&a.trim())return`tok:${a.trim()}`;let o=Fe(e)??``;return o?`h:${o}`:`u:${L(e)}`}function nt(e,t){let n=$e(e),r=Fe(e)??``;if(n===`post`&&r)return`post:${r}`;let i=et(t),a=Number.isFinite(t.pulse??NaN)?t.pulse:null;if(n===`stream`&&i&&a!=null)return`stream:${i}|${a}`;let o=typeof t.kaiSignature==`string`?t.kaiSignature.trim():``;if(o)return`${n}:sig:${o}`;let s=z(e);return s&&s.trim()?`${n}:tok:${s.trim()}`:`${n}:u:${L(e)}`}var rt=e=>{let t=e.toLowerCase();if(!t.includes(`/stream`))return!1;let n=t.includes(`root=`)||t.includes(`&seg=`)||t.includes(`&add=`),r=t.includes(`/stream#`)||t.includes(`#v=`);return n&&r};function G(e,t){if(R(e))return-1e9;let n=e.toLowerCase(),r=Qe(e),i=0;rt(n)&&(i-=1e4),t===`post`?r===`postS`?i+=220:i-=25:t===`stream`?r===`streamT`?i+=220:r===`streamP`?i+=190:r===`streamQ`?i+=175:r===`stream`?i+=160:r===`postS`?i+=80:i-=25:(r===`postS`&&(i+=120),r===`streamT`&&(i+=125),r===`streamP`&&(i+=105),(r===`streamQ`||r===`stream`)&&(i+=95));let a=I().toLowerCase();n.startsWith(a)&&(i+=12),n.startsWith(h.toLowerCase())&&(i+=10),n.startsWith(g.toLowerCase())&&(i+=10);let o=W.get(L(e));return o===1&&(i+=200),o===-1&&(i-=200),i+=Math.max(0,20-Math.floor(e.length/40)),i}function it(e,t){let n=e.filter(e=>!R(e)),r=n.length>0?n:e;if(n.length===0&&e.length>0){let t=z(e[0]??``);if(t)return L(ze(t))}let i=r[0]??``,a=-1e9;for(let e of r){let n=G(e,t);(n>a||n===a&&e.length<i.length)&&(i=e,a=n)}return i}function at(e){try{let t=new URL(e,I()),n=t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=[...t.searchParams.getAll(`add`),...r.getAll(`add`)],a=[];for(let e of i){let t=Ie(String(e)).trim();if(!t)continue;if(Le(t)){let e=L(Re(t));a.includes(e)||a.push(e);continue}let n=L(t);if(R(n)){let e=z(n);e&&(n=L(Re(e)))}a.includes(n)||a.push(n)}return a.slice(-ne)}catch{return[]}}function ot(e){let t=at(e);return t.length===0?{chain:[]}:{chain:t,originUrl:t[0],parentUrl:t[t.length-1]}}function st(e,t){let n={...e};return t.originUrl&&!n.originUrl&&(n.originUrl=t.originUrl),t.parentUrl&&!n.parentUrl&&(n.parentUrl=t.parentUrl),n}var K=new Map,q=x&&`BroadcastChannel`in window?new BroadcastChannel(b):null;function ct(e){let t=e;for(let e of[`phiSent`,`sentPhi`,`phi_amount`,`amountPhi`,`phi`,`phiValue`,`phi_amount_sent`]){let n=t[e];if(typeof n==`number`){if(!Number.isFinite(n)||Math.abs(n)<1e-12)continue;return n}if(typeof n==`string`){let e=Number(n);if(!Number.isNaN(e)&&Math.abs(e)>=1e-12)return e}}}function J(){if(!S)return;let e=Array.from(K.keys());try{localStorage.setItem(ee,JSON.stringify(e))}catch{}}function Y(e,t){let n=L(e);lt(n,t);let r=K.get(n);if(!r)return K.set(n,t),!0;let i=r.parentUrl??``,a=r.originUrl??``,o=t.parentUrl??``,s=t.originUrl??``,c=i!==o||a!==s,l=Object.keys(r).length,u=Object.keys(t).length!==l,d=V(r,t)!==0;return c||u||d?(K.set(n,t),!0):!1}function lt(e,t){let n=t.feed;if(!n)return;let r=n.usernameClaim,i=r?u(r.payload?.normalized||r.payload?.username||``):``,a=u(n.author??``),o=i||a;if(!o||!r)return;let s=c(r.hash??``),d=r.url?.trim()||e;if(!s||!d)return;let f=r.payload;if(!f||f.kind!==`username_claim`)return;let p=u(f.normalized||f.username||``)||o;if(p!==o)return;let m=r.ownerHint??f.ownerHint??null;l({hash:s,url:L(d),payload:{...f,normalized:p},ownerHint:m})}function ut(e){let t=L(e),n=s(t);return n?Y(t,st(n,ot(t))):!1}function dt(e,t){if(e.length===0)return!1;let n=L(e[0]),r=!1;r=ut(n)||r;{let e=K.get(n);if(e){let t={...e};t.originUrl||=n,r=Y(n,t)||r}}for(let t=1;t<e.length;t++){let i=L(e[t]),a=L(e[t-1]);r=ut(i)||r;let o=K.get(i);if(o){let e={...o};e.originUrl||=n,e.parentUrl||=a,r=Y(i,e)||r}}let i=L(t),a=K.get(i);if(a){let t={...a};t.originUrl||=n,t.parentUrl||=L(e[e.length-1]),r=Y(i,t)||r}return r}var X=new Map,Z=null,ft=!1,pt=0;function mt(){if(S)try{let e=JSON.stringify([...X.entries()]);localStorage.setItem(le,e)}catch{}}function ht(){if(!S)return;let e=localStorage.getItem(le);if(e)try{let t=JSON.parse(e);if(!Array.isArray(t))return;X.clear();for(let e of t){if(!Array.isArray(e)||e.length!==2)continue;let[t,n]=e;typeof t!=`string`||!U(n)||X.set(L(t),n)}}catch{}}function gt(e){let t=e.url;if(typeof t!=`string`||!t.trim())return;let n=L(t.trim());X.set(n,{...e,url:n}),mt(),x&&(Z!=null&&window.clearTimeout(Z),Z=window.setTimeout(()=>{Z=null,Q()},se))}function _t(e,t){let n=L(e),r={url:n,...t};X.set(n,r),mt(),x&&(Z!=null&&window.clearTimeout(Z),Z=window.setTimeout(()=>{Z=null,Q()},se))}function vt(){for(let[e,t]of K){let n=L(e),r=t;X.set(n,{url:n,...r})}mt()}async function Q(){if(x&&H()&&!ft&&X.size!==0){ft=!0;try{let e=[],t=[];for(let[n,r]of X)if(e.push(r),t.push(n),e.length>=oe)break;let n=JSON.stringify(e),r=new Blob([n],{type:`application/json`}),i=new FormData;i.append(`file`,r,`sigils_${We()}.json`);let a=await Ne(e=>{let t=new URL(be,e);return t.searchParams.set(`include_state`,`false`),t.searchParams.set(`include_urls`,`false`),t.toString()},{method:`POST`,body:i});if(!a||!a.ok)throw Error(`inhale failed: ${a?.status??0}`);try{await a.json()}catch{}for(let e of t)X.delete(e);mt(),pt=0,X.size>0&&(Z=window.setTimeout(()=>{Z=null,Q()},10))}catch{pt=Math.min(pt?pt*2:O,ce),Z=window.setTimeout(()=>{Z=null,Q()},pt)}finally{ft=!1}}}function $(e,t){let n=L(e),r=s(n);if(!r)return!1;let i=t?.includeAncestry??!0,a=t?.broadcast??!0,c=t?.persist??!0,l=t?.source??`local`,u=t?.enqueueToApi??l===`local`,d=!1,f=ot(n);if(d=Y(n,st(r,f))||d,i&&f.chain.length>0){for(let e of f.chain)d=ut(e)||d;d=dt(f.chain,n)||d}if(i){let e=o(n);for(let t of e){let e=L(t),n=s(e);n&&(d=Y(e,st(n,ot(e)))||d)}}if(d&&(c&&J(),q&&a&&q.postMessage({type:`sigil:add`,url:n}),u)){let e=K.get(n);e&&_t(n,e)}return d}function yt(e){let t=[],n=[],r=e=>{let n=L(e);t.includes(n)||t.push(n)};if(Array.isArray(e)){for(let i of e){if(typeof i==`string`){i.trim()&&r(i.trim());continue}if(U(i)){let e=i.url;if(typeof e==`string`&&e.trim()){let r=L(e.trim());t.includes(r)||t.push(r),n.push({...i,url:r})}}}return{urls:t,rawKrystals:n}}if(U(e)){let i=e.urls;if(Array.isArray(i))for(let e of i)typeof e==`string`&&e.trim()&&r(e.trim());let a=e.url;if(typeof a==`string`&&a.trim()){let r=L(a.trim());t.includes(r)||t.push(r),n.push({...e,url:r})}return{urls:t,rawKrystals:n}}return{urls:t,rawKrystals:n}}function bt(e){for(let t of e){let e=L(t),n=K.get(e)??s(e);n&&_t(e,st(n,ot(e)))}Q()}function xt(){if(!S)return!1;let e=e=>{if(!e)return!1;try{let t=JSON.parse(e);if(!Array.isArray(t))return!1;let n=!1;for(let e of t)typeof e==`string`&&$(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`hydrate`,enqueueToApi:!1})&&(n=!0);return n}catch{return!1}},t=e(localStorage.getItem(ee)),n=e(localStorage.getItem(te));return(t||n)&&J(),t||n}async function St(e){let t=0,n,r;for(let i=0;i<ae;i++){let a=i*D,o=await Pe(e=>{let t=new URL(ye,e);return t.searchParams.set(`offset`,String(a)),t.searchParams.set(`limit`,String(D)),t.toString()},{method:`GET`,signal:e,cache:`no-store`});if(!o.ok)break;n=o.value.state_seal,r=o.value.total;let s=o.value.urls;if(!Array.isArray(s)||s.length===0)break;for(let e of s){if(typeof e!=`string`)continue;let n=L(e);K.has(n)||$(n,{includeAncestry:!0,broadcast:!1,persist:!1,source:`remote`,enqueueToApi:!1})&&(t+=1)}if(s.length<D||r!=null&&a+s.length>=r)break}return t>0&&J(),{imported:t,remoteSeal:n,remoteTotal:r}}function Ct(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=L(r),a=$e(e),o=nt(e,i),s=tt(e,i);t.set(e,o);let c=n.get(o);if(!c){n.set(o,{payload:i,urls:new Set([e]),kind:a,momentKey:s});continue}V(i,c.payload)>0&&(c.payload=i),c.urls.add(e);let l=c.momentKey,u=s;l.startsWith(`u:`)&&!u.startsWith(`u:`)&&(c.momentKey=u),l.startsWith(`h:`)&&(u.startsWith(`k:`)||u.startsWith(`sig:`)||u.startsWith(`tok:`))&&(c.momentKey=u)}let r=new Map;for(let[e,t]of n){let n=it(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let o=new Map,s=new Map,c=new Map;for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),a;a=i.length>0?i.slice().sort((e,t)=>G(t.primaryUrl,`post`)-G(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>G(t.primaryUrl,t.kind)-G(e.primaryUrl,e.kind))[0];let l=a?.id??t[0];o.set(e,l);for(let e of t)s.set(e,l);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)c.set(e,l)}}let l=new Map;for(let e of r.values()){let n=s.get(e.id)??e.id;if(e.id!==n)continue;let r=Ge(e.payload,`originUrl`),i=r?L(r):a(e.primaryUrl)??e.primaryUrl,o=t.get(i),u=c.get(i)??(o?s.get(o):void 0);l.set(n,u??n)}let u=new Map;for(let e of r.values()){let n=s.get(e.id)??e.id,r=l.get(n)??n,i;if(e.id!==n)i=n;else{let n=Ge(e.payload,`parentUrl`);if(n){let r=L(n),a=t.get(r),o=c.get(r)??(a?s.get(a):void 0);o&&o!==e.id&&(i=o)}}u.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return u}function wt(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>V(t.get(n).payload,t.get(e).payload)),n}function Tt(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=wt(e,t).map(e=>Tt(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function Et(e){let t=0,n=e.payload,r=e=>{t+=1,V(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function Dt(e){let t=Ct(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=Tt(e,t);if(!n)continue;let i=Et(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=V(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?V(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function Ot(e,t){let n=e.payload,r=[],i=new Set,a=ct(e.payload);a!==void 0&&r.push({label:`This glyph Φ`,value:`${Ue(a)} Φ`});let o=n.feed,s=typeof o?.author==`string`?o.author:typeof n.author==`string`?n.author:void 0,c=o?o.usernameClaim:void 0,l=c?u(c.payload?.normalized||c.payload?.username||``):``,d=u(s??``),f=l||d;if(f){let e=t[f],n=typeof s==`string`&&s.trim().length>0?s.trim():`@${f}`;e?(r.push({label:`Username (claimed)`,value:`${n} → glyph ${He(e.claimHash,10)}`}),r.push({label:`Claim glyph`,value:B(e.claimUrl)})):r.push({label:`Username`,value:n})}let p=(e,t)=>{let a=n[e];typeof a==`string`&&a.trim().length>0&&!i.has(e)&&(r.push({label:t,value:a.trim()}),i.add(e))};p(`userPhiKey`,`PhiKey`),p(`phiKey`,`PhiKey`),p(`phikey`,`PhiKey`),p(`kaiSignature`,`Kai Signature`);let m=n.parentUrl;typeof m==`string`&&m.length>0&&(r.push({label:`Parent URL`,value:B(m)}),i.add(`parentUrl`));let h=n.originUrl;typeof h==`string`&&h.length>0&&(r.push({label:`Origin URL`,value:B(h)}),i.add(`originUrl`));let g=n.label??n.title??n.type??n.note??n.description;typeof g==`string`&&g.trim().length>0&&r.push({label:`Label / Type`,value:g.trim()});for(let e of[`memoryUrl`,`memory_url`,`streamUrl`,`stream_url`,`feedUrl`,`feed_url`,`stream`]){let t=n[e];typeof t==`string`&&t.trim().length>0&&!i.has(e)&&(r.push({label:e,value:B(t.trim())}),i.add(e))}for(let[e,t]of Object.entries(n)){if(r.length>=12)break;if(i.has(e)||t==null)continue;let n=e.toLowerCase();if(!(n.includes(`stream`)||n.includes(`memory`)||n.includes(`feed`))||typeof t==`string`&&t.trim().length===0)continue;let a=typeof t==`string`?B(t.trim()):JSON.stringify(t);r.push({label:e,value:a})}r.push({label:`Primary URL`,value:B(e.url)});let _=e.urls.filter(e=>!R(e)).map(e=>B(e));return e.urls.length>1&&r.push({label:`URL variants`,value:_.length===0?`${e.urls.length} urls (kept in data; hidden from browser view)`:_.length<=3?_.join(` | `):`${e.urls.length} urls (kept in data; rendered once)`}),r}async function kt(e){if(x){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}var At=()=>(0,m.jsx)(`style`,{children:`
    /* glyph mark */
    .kx-glyph{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .kx-glyph__mark{
      width:72%;
      height:72%;
      display:block;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
      filter: drop-shadow(0 8px 22px rgba(0,0,0,.34));
    }

    /* mobile scroll stability */
    .sigil-explorer,
    .sigil-explorer *{
      -webkit-tap-highlight-color: transparent;
    }
    .sigil-explorer{
      overscroll-behavior: none;
      overscroll-behavior-y: none;
      touch-action: pan-y;
    }
    .sigil-explorer .explorer-scroll{
      overscroll-behavior: contain;
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
  `});function jt({p:e}){return(0,m.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${e.pulse} • beat ${e.beat} • step ${e.stepIndex}`,children:[(0,m.jsxs)(`span`,{className:`k-pill`,children:[`pulse `,e.pulse]}),(0,m.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,m.jsxs)(`span`,{className:`k-pill`,children:[`beat `,e.beat]}),(0,m.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,m.jsxs)(`span`,{className:`k-pill`,children:[`step `,e.stepIndex]})]})}function Mt({node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i}){let a=t.has(e.id),o=Fe(e.url),s=e.payload.kaiSignature,c=e.payload.chakraDay,l=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,u=l==null?void 0:r.get(l),d=Ve(e.url),f=a?Ot(e,i):[];return(0,m.jsxs)(`div`,{className:`node`,style:y(c),"data-chakra":String(c??``),"data-node-id":e.id,children:[(0,m.jsxs)(`div`,{className:`node-row`,children:[(0,m.jsxs)(`div`,{className:`node-main`,children:[(0,m.jsx)(`button`,{className:`twirl`,"aria-label":a?`Collapse memories`:`Expand memories`,"aria-expanded":a,onClick:()=>n(e.id),title:a?`Collapse`:`Expand`,type:`button`,children:(0,m.jsx)(`span`,{className:`tw ${a?`open`:``}`})}),(0,m.jsx)(`a`,{className:`node-link`,href:d,target:`_blank`,rel:`noopener noreferrer`,title:d,children:(0,m.jsx)(`span`,{children:He(s??o??`glyph`,12)})})]}),(0,m.jsxs)(`div`,{className:`node-meta`,children:[(0,m.jsx)(jt,{p:e.payload}),c&&(0,m.jsx)(`span`,{className:`chakra`,title:String(c),children:String(c)}),u!==void 0&&(0,m.jsxs)(`span`,{className:`phi-pill`,title:`Total Φ sent from pulse ${e.payload.pulse}`,children:[`Φ sent: `,Ue(u),`Φ`]}),(0,m.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void kt(d),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),a&&(0,m.jsxs)(`div`,{className:`node-open`,children:[(0,m.jsx)(`div`,{className:`node-detail`,children:f.length===0?(0,m.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,m.jsx)(`div`,{className:`node-detail-grid`,children:f.map(e=>(0,m.jsxs)(p.Fragment,{children:[(0,m.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,m.jsx)(`div`,{className:`detail-value`,title:e.value,children:e.value})]},e.label))})}),e.children.length>0&&(0,m.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,m.jsx)(Mt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i},e.id))})]})]})}function Nt({root:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i}){let a=(0,p.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),o=Fe(e.url),s=e.payload.kaiSignature,c=Ve(e.url);return(0,m.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:y(e.payload.chakraDay),"data-chakra":String(e.payload.chakraDay??``),"data-node-id":e.id,children:[(0,m.jsxs)(`header`,{className:`origin-head`,children:[(0,m.jsxs)(`div`,{className:`o-meta`,children:[(0,m.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,m.jsx)(`a`,{className:`o-link`,href:c,target:`_blank`,rel:`noopener noreferrer`,title:c,children:He(s??o??`origin`,14)}),e.payload.chakraDay&&(0,m.jsx)(`span`,{className:`o-chakra`,title:String(e.payload.chakraDay),children:String(e.payload.chakraDay)})]}),(0,m.jsxs)(`div`,{className:`o-right`,children:[(0,m.jsx)(jt,{p:e.payload}),(0,m.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[a,` keys`]}),(0,m.jsx)(`button`,{className:`o-copy`,onClick:()=>void kt(c),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,m.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,m.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,m.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,m.jsx)(Mt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i},e.id))})})]})}function Pt({onAdd:e,onImport:t,onExport:n,total:r,lastAdded:i}){let[a,o]=(0,p.useState)(``);return(0,m.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,m.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,m.jsxs)(`div`,{className:`kx-brand`,children:[(0,m.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,m.jsx)(`img`,{className:`kx-glyph__mark`,src:re,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,m.jsxs)(`div`,{className:`kx-title`,children:[(0,m.jsxs)(`h1`,{children:[`KAIROS `,(0,m.jsx)(`span`,{children:`Keystream`})]}),(0,m.jsx)(`div`,{className:`kx-tagline`,children:`Sovereign Lineage • No DB • Pure Φ`})]})]}),(0,m.jsxs)(`div`,{className:`kx-controls`,children:[(0,m.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),a.trim()&&(e(a.trim()),o(``))},children:[(0,m.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:a,onChange:e=>o(e.target.value),"aria-label":`Sigil Key`}),(0,m.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,m.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,m.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,m.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,m.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,m.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,m.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[r,` KEYS`]}),i&&(0,m.jsxs)(`span`,{className:`kx-pill subtle`,title:i,children:[`Last: `,He(i,8)]})]})]})]})})}var Ft=()=>{let[e,t]=(0,p.useState)(0),[r,i]=(0,p.useState)(void 0),[a,o]=(0,p.useState)(()=>f()),c=(0,p.useRef)(!1),l=(0,p.useRef)(new Set),u=(0,p.useRef)(null),h=(0,p.useRef)(!1),g=(0,p.useRef)(null),_=(0,p.useRef)(0),v=(0,p.useRef)(null),y=(0,p.useRef)(!1),b=(0,p.useRef)(void 0),ne=(0,p.useRef)([]),re=(0,p.useRef)(null),S=(0,p.useCallback)(e=>{let t=j()+e;t>_.current&&(_.current=t)},[]),C=(0,p.useCallback)(()=>{if(!x||c.current)return;let e=j(),n=_.current-e;if(n>0){v.current!=null&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{v.current=null,C()},n+ge);return}let r=ne.current.splice(0);if(r.length>0&&(0,p.startTransition)(()=>{o(e=>{let t=e;for(let e of r){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null}})}return t})}),b.current!==void 0){let e=b.current;b.current=void 0,(0,p.startTransition)(()=>i(e))}y.current&&(y.current=!1,(0,p.startTransition)(()=>t(e=>e+1)))},[]),w=(0,p.useCallback)(()=>{if(!x||v.current!=null)return;let e=j(),t=_.current-e,n=Math.max(0,t)+ge;v.current=window.setTimeout(()=>{v.current=null,C()},n)},[C]),T=(0,p.useCallback)(()=>{if(!c.current){if(j()<_.current||h.current){y.current=!0,w();return}(0,p.startTransition)(()=>t(e=>e+1))}},[w]),E=(0,p.useCallback)(e=>{if(!c.current){if(j()<_.current||h.current){b.current=e,w();return}(0,p.startTransition)(()=>i(e))}},[w]),D=(0,p.useRef)(null),[ae,oe]=(0,p.useState)(()=>new Set),se=(0,p.useCallback)(e=>{S(he);let t=u.current;if(t){let n=`[data-node-id="${_e(e)}"]`,r=t.querySelector(n);D.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}oe(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),w()},[S,w]);(0,p.useEffect)(()=>{if(!x)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,p.useEffect)(()=>{if(!x)return;let e=u.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]);let O=(0,p.useRef)(null),ce=(0,p.useRef)(!1),le=(0,p.useRef)(null);(0,p.useEffect)(()=>{if(!x)return;let e=u.current;if(!e)return;let t=()=>{h.current=!0,S(me),g.current!=null&&window.clearTimeout(g.current),g.current=window.setTimeout(()=>{h.current=!1,g.current=null,w()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),g.current!=null&&window.clearTimeout(g.current),g.current=null,h.current=!1}},[S,w]),(0,p.useLayoutEffect)(()=>{let e=D.current;if(!e)return;D.current=null;let t=u.current;if(!t)return;let n=`[data-node-id="${_e(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[ae]),(0,p.useEffect)(()=>{if(c.current=!1,we(),ke(),qe(),ht(),xt()&&T(),x){let e=L(window.location.href);if(s(e)){let t=$(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});E(B(e)),t&&T()}}let e=window.__SIGIL__?.registerSigilUrl;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=e=>{$(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(E(B(e)),T())};let t=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&$(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(E(B(t)),T())};window.addEventListener(`sigil:url-registered`,t);let n=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&$(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(E(B(t)),T())};window.addEventListener(`sigil:minted`,n);let r;q&&(r=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&$(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(E(B(t.url)),T())},q.addEventListener(`message`,r));let i=e=>{if(!e.key)return;let t=e.key===ee,n=e.key===te;if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&$(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);E(void 0),n&&(J(),T())}catch{}};window.addEventListener(`storage`,i);let a=()=>{mt(),Q()};window.addEventListener(`pagehide`,a);let l=d(e=>{if(j()<_.current||h.current){ne.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),w();return}(0,p.startTransition)(()=>{o(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),u=new AbortController,f=async e=>{if(!c.current&&H()&&!ce.current&&!h.current&&!(j()<_.current&&(e===`pulse`||e===`import`))){ce.current=!0;try{await Q();let t=O.current,n=await Ne(e=>new URL(ve,e).toString(),{method:`GET`,cache:`no-store`,signal:u.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``}catch{return}if(t&&r&&t===r){O.current=r;return}let i=await St(u.signal);O.current=i.remoteSeal??r??t??null,i.imported>0&&(E(void 0),T());let a=O.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&a!==le.current)&&(vt(),le.current=a,await Q())}finally{ce.current=!1}}};re.current=f,vt(),f(`open`);let m=null,g=()=>{if(!x||c.current)return;m!=null&&window.clearTimeout(m);let e=ie();m=window.setTimeout(()=>{if(m=null,document.visibilityState!==`visible`){g();return}if(!H()){g();return}f(`pulse`),g()},e)},y=()=>{g()};g();let b=()=>{document.visibilityState===`visible`&&(y(),f(`visible`))};document.addEventListener(`visibilitychange`,b);let S=()=>{y(),f(`focus`)},C=()=>{y(),f(`online`)};return window.addEventListener(`focus`,S),window.addEventListener(`online`,C),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=e),window.removeEventListener(`sigil:url-registered`,t),window.removeEventListener(`sigil:minted`,n),window.removeEventListener(`storage`,i),window.removeEventListener(`pagehide`,a),window.removeEventListener(`focus`,S),window.removeEventListener(`online`,C),document.removeEventListener(`visibilitychange`,b),q&&r&&q.removeEventListener(`message`,r),typeof l==`function`&&l(),v.current!=null&&window.clearTimeout(v.current),v.current=null,m!=null&&window.clearTimeout(m),m=null,u.abort(),re.current=null,c.current=!0}},[T,S,w,E]);let k=(0,p.useCallback)(e=>{let t=re.current;t&&t(e)},[]);(0,p.useEffect)(()=>{if(!x)return;let e=()=>k(`visible`);return window.addEventListener(n,e),()=>window.removeEventListener(n,e)},[k]);let A=(0,p.useMemo)(()=>Dt(K),[e]),de=(0,p.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of K){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=tt(L(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=ct(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[e]),fe=(0,p.useMemo)(()=>{let e=[];for(let[t]of K){let n=L(Ve(t));e.includes(n)||e.push(n)}return e},[e]);(0,p.useEffect)(()=>{if(!x||fe.length===0)return;let e=fe.filter(e=>!l.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;l.current.add(n),await Ke(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[fe]);let pe=(0,p.useCallback)(async()=>{if(!x||h.current||!H()||j()<_.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=$e(n.url),r=[...n.urls].map(e=>L(B(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>G(n,t)-G(e,t));for(let t of r.slice(0,2)){let n=L(t);!W.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of A)t(e);if(e.length!==0)for(let t of e.slice(0,ue)){let e=await Ze(t);e===`ok`&&Ye(t,1),e===`bad`&&Ye(t,-1)}},[A]);(0,p.useEffect)(()=>{if(!x)return;let e=!1,t=()=>{e||pe()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[e,pe]);let M=(0,p.useCallback)(e=>{S(he),$(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(E(B(e)),T())},[T,S,E]),N=(0,p.useCallback)(async e=>{try{S(he);let t=await e.text(),{urls:n,rawKrystals:r}=yt(JSON.parse(t));if(n.length===0&&r.length===0)return;let i=!1;for(let e of n)$(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(i=!0);if(E(void 0),i&&(J(),T()),r.length>0){for(let e of r)gt(e);Q()}else n.length>0&&bt(n);k(`import`)}catch{}},[T,S,k,E]),ye=(0,p.useCallback)(()=>{let e=JSON.stringify(Array.from(K.keys()),null,2),t=new Blob([e],{type:`application/json`}),n=URL.createObjectURL(t),r=document.createElement(`a`);r.href=n,r.download=`sigils.json`,r.click(),URL.revokeObjectURL(n)},[]);return(0,m.jsxs)(`div`,{className:`sigil-explorer`,children:[(0,m.jsx)(At,{}),(0,m.jsx)(Pt,{onAdd:M,onImport:N,onExport:ye,total:K.size,lastAdded:r}),(0,m.jsx)(`div`,{className:`explorer-scroll`,ref:u,role:`region`,"aria-label":`Kairos Sigil-Glyph Explorer Content`,children:(0,m.jsxs)(`div`,{className:`explorer-inner`,children:[A.length===0?(0,m.jsxs)(`div`,{className:`kx-empty`,children:[(0,m.jsx)(`p`,{children:`No sigils in your keystream yet.`}),(0,m.jsxs)(`ol`,{children:[(0,m.jsx)(`li`,{children:`Import your keystream memories.`}),(0,m.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,m.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage reconstructs instantly.`})]})]}):(0,m.jsx)(`div`,{className:`forest`,children:A.map(e=>(0,m.jsx)(Nt,{root:e,expanded:ae,toggle:se,phiTotalsByPulse:de,usernameClaims:a},e.id))}),(0,m.jsx)(`footer`,{className:`kx-footer`,"aria-label":`About`,children:(0,m.jsxs)(`div`,{className:`row`,children:[(0,m.jsx)(`span`,{children:`Determinate • Stateless • Kairos-remembered`}),(0,m.jsx)(`span`,{className:`dot`,children:`•`}),(0,m.jsx)(`span`,{children:`No DB. No Server. Pure Φ.`})]})})]})})]})};export{Ft as default};