import{Ct as e,gt as t,mn as n,mt as r}from"./index-BGzUQCv_.js";function i(e){let t=2166136261;for(let n=0;n<e.length;n+=1)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,`0`)}function a(e,t,n){let r=e.metadata?.kaiSignature??``,a=typeof n?.kaiSignature==`string`?n.kaiSignature:``,o=typeof n?.timestamp==`number`?String(n.timestamp):``;return`glyph::${t}::${i(`evolve|p=${t}|parentHash=${e.hash}|parentSig=${r}|patchSig=${a}|patchTs=${o}`)}`}function o(t,n,r){let i=a(t,n,r),o=typeof r?.timestamp==`number`?r.timestamp:n,s={...t.metadata??{},...r??{},kaiSignature:i,timestamp:o},c={hash:i,pulseCreated:n,pulseGenesis:t.pulseGenesis??t.pulseCreated,parentHash:t.hash,sentFrom:t.hash,value:1,inhaled:{},metadata:s},l=(t.sentTo??[]).map(e=>({senderSignature:t.metadata?.kaiSignature??t.hash,senderStamp:t.hash,senderKaiPulse:e.pulseSent,receiverSignature:e.recipientHash})),{unsigned:u}=e({pulse:n,kaiSignature:i,seriesSize:1,quality:`med`,creatorVerified:!1,creatorRep:0,transfers:l,cumulativeTransfers:l.length},n);return c.value=u.valuePhi,c}function s(e){let t=(e??``).trim();return t?t.replace(/^@+/,``).replace(/[\s_]+/g,` `).trim().toLowerCase().replace(/[.,;:!?]+$/g,``):``}function c(e){let t=(e??``).trim();if(!t)return``;if(/^[0-9a-f]{64}$/i.test(t))return t.toLowerCase();if(/^[A-Za-z0-9_-]{16,}$/u.test(t))return r(t);try{let e=new URL(t),n=e.pathname||``,i=n.match(/\/(?:stream|feed)\/p\/([^/?#]+)/u)||n.match(/\/p\/([^/?#]+)/u)||n.match(/\/p(?:\u007e|%7[Ee])\/?([^/?#]+)/u);if(i?.[1])return r(i[1]);let a=e.hash&&e.hash.startsWith(`#`)?e.hash.slice(1):``,o=new URLSearchParams(a),s=e.searchParams;for(let e of[`t`,`p`,`token`,`capsule`]){let t=o.get(e);if(t)return r(t);let n=s.get(e);if(n)return r(n)}}catch{}return``}function l(e,n,r){let i=s(n);if(!i)throw Error(`Username required for claim payload`);return{kind:t,username:n.trim(),normalized:i,originHash:e,ownerHint:r??null}}function u(e){let t=l(e.origin.hash,e.username,e.ownerHint??e.origin.meta?.userPhiKey??e.origin.metadata?.creator??null),n={...e.origin.metadata??{},usernameClaim:t};return o(e.origin,e.pulse,n)}var d=typeof window<`u`,f=`kai:username-claims:v1`,p=`kai-username-claims`,m=`username-claim:registered`,h=`username-claim`,g={};function _(e){return Object.fromEntries(Object.entries(e))}function v(e){let t=BigInt(2**53-1);return e>t?2**53-1:e<-t?-(2**53-1):Number(e)}function y(){return v(n())}function b(e){let t=(e??``).trim();if(!t)return null;if(!d)return t;try{return new URL(t,window.location?.origin??void 0).toString()}catch{return t}}function x(e){if(typeof e==`number`)return Number.isFinite(e)?e:0;if(typeof e==`bigint`)return v(e);if(typeof e==`string`){let t=e.trim();if(!t)return 0;let n=Number(t);return Number.isFinite(n)?n:0}return 0}function S(e){if(!e||typeof e!=`object`)return null;let t=e,n=typeof t.normalized==`string`?t.normalized:``,r=typeof t.claimHash==`string`?t.claimHash:``;if(!n||!r)return null;let i={username:typeof t.username==`string`?t.username:n,normalized:n,claimHash:r,claimUrl:typeof t.claimUrl==`string`?t.claimUrl:``,originHash:typeof t.originHash==`string`?t.originHash:``,ownerHint:t.ownerHint===null||typeof t.ownerHint==`string`?t.ownerHint:null,updatedAt:x(t.updatedAt)};return!i.claimUrl||!i.originHash?null:i}function C(){if(!d)return _(g);try{let e=window.localStorage.getItem(f);if(!e)return g={},{};let t=JSON.parse(e);if(!t||typeof t!=`object`)return{};let n=t,r={};for(let[e,t]of Object.entries(n)){let n=S(t);n&&(r[e]=n)}return g=_(r),_(r)}catch{return _(g)}}function w(e){if(g=_(e),d)try{window.localStorage.setItem(f,JSON.stringify(e))}catch{}}var T=null;function E(){return!d||!(`BroadcastChannel`in window)?null:T||(T=new BroadcastChannel(p),T)}function D(e){let t=C(),n={...e,updatedAt:x(e?.updatedAt)},r=t[n.normalized];return r&&r.claimHash!==n.claimHash?!1:r&&r.claimHash===n.claimHash&&r.claimUrl===n.claimUrl&&r.originHash===n.originHash&&r.ownerHint===n.ownerHint&&r.updatedAt===n.updatedAt?!0:(t[n.normalized]=n,w(t),!0)}function O(e){if(d){try{let t=new CustomEvent(m,{detail:e});window.dispatchEvent(t)}catch{}try{E()?.postMessage({type:h,entry:e})}catch{}}}function k(e,t){let n=t.payload;if(!n||n.kind!==`username_claim`)return{updated:!1,reason:`not a username-claim glyph`};let r=c(t.hash);if(!r)return{updated:!1,reason:`missing glyph hash`};let i=s(n.normalized||n.username);if(!i)return{updated:!1,reason:`missing username`};let a=e[i];if(a&&a.claimHash!==r)return{updated:!1,reason:`username already bound`};let o=b(t.url??``);if(!o)return{updated:!1,reason:`missing claim url`};let l=t.ownerHint??n.ownerHint??null,u={username:n.username,normalized:i,claimHash:r,claimUrl:o,originHash:n.originHash,ownerHint:l,updatedAt:y()},d=a&&a.claimHash===u.claimHash&&a.claimUrl===u.claimUrl&&a.originHash===u.originHash&&a.ownerHint===u.ownerHint;return e[i]=u,{updated:!d,entry:u}}function A(e){let t=C(),{updated:n,entry:r,reason:i}=k(t,e);return n?(w(t),r&&O(r),{accepted:!0,updated:!0,registry:t}):{accepted:!!r,updated:!1,reason:i,registry:t}}function j(){return C()}function M(e){if(!d)return()=>{};let t=t=>{let n=t;n?.detail&&D(n.detail)&&e(n.detail,`event`)},n=E(),r=t=>{let n=t?.data;n?.type===h&&n.entry&&D(n.entry)&&e(n.entry,`broadcast`)},i=t=>{if(!(t.key!==f||typeof t.newValue!=`string`))try{let n=JSON.parse(t.newValue);for(let t of Object.values(n)){let n=S(t);n&&D(n)&&e(n,`storage`)}}catch{}};return window.addEventListener(m,t),n&&n.addEventListener(`message`,r),window.addEventListener(`storage`,i),()=>{window.removeEventListener(m,t),n&&n.removeEventListener(`message`,r),window.removeEventListener(`storage`,i)}}export{c as a,u as i,A as n,s as o,M as r,j as t};