var e=`KaiVoh.SealEnvelopeV1.content`,t=`KaiVoh.SealEnvelopeV1.wrap.derived`,n=`KaiVoh.SealEnvelopeV1.wrap.glyph`,r=new TextEncoder;function i(e){if(e.buffer instanceof ArrayBuffer)return e;let t=new Uint8Array(e.byteLength);return t.set(e),t}function a(e){let t=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/`,n=[],r=e.length,i=0;for(;i+2<r;i+=3){let r=e[i]<<16|e[i+1]<<8|e[i+2];n.push(t[r>>>18&63]+t[r>>>12&63]+t[r>>>6&63]+t[r&63])}let a=r-i;if(a===1){let r=e[i]<<16;n.push(t[r>>>18&63]+t[r>>>12&63]+`==`)}else if(a===2){let r=e[i]<<16|e[i+1]<<8;n.push(t[r>>>18&63]+t[r>>>12&63]+t[r>>>6&63]+`=`)}return n.join(``).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function o(e){let t=e.replace(/-/g,`+`).replace(/_/g,`/`).trim();if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw Error(`Invalid base64/base64url`);let n=(4-t.length%4)%4,r=t+`=`.repeat(n),i=new Int16Array(128).fill(-1);for(let e=0;e<64;e++)i[`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/`.charCodeAt(e)]=e;let a=Math.floor(r.length*3/4)-(r.endsWith(`==`)?2:r.endsWith(`=`)?1:0),o=new Uint8Array(a),s=0;for(let e=0;e<r.length;e+=4){let t=r.charCodeAt(e),n=r.charCodeAt(e+1),c=r.charCodeAt(e+2),l=r.charCodeAt(e+3),u=i[t]??-1,d=i[n]??-1,f=c===61?-1:i[c]??-1,p=l===61?-1:i[l]??-1;if(u<0||d<0||f<0&&c!==61||p<0&&l!==61)throw Error(`Invalid base64 characters`);let m=u<<18|d<<12|(f<0?0:f)<<6|(p<0?0:p);s<a&&(o[s++]=m>>>16&255),s<a&&c!==61&&(o[s++]=m>>>8&255),s<a&&l!==61&&(o[s++]=m&255)}return o}function s(e){if(typeof crypto>`u`||!crypto.getRandomValues)throw Error(`crypto.getRandomValues unavailable`);let t=new Uint8Array(e);return crypto.getRandomValues(t),t}function c(e){if(typeof e!=`object`||!e)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}function l(e,t){if(e===null)return null;let n=typeof e;if(n===`string`||n===`number`||n===`boolean`)return e;if(Array.isArray(e))return e.map(e=>l(e,t));if(c(e)){if(t.has(e))throw Error(`Cannot seal cyclic objects`);t.add(e);let n=Object.keys(e).sort(),r={};for(let i of n){let n=e[i];n!==void 0&&(r[i]=l(n,t))}return t.delete(e),r}let r=JSON.stringify(e);if(typeof r!=`string`)return null;try{return JSON.parse(r)}catch{return null}}function u(e){let t=l(e,new Set),n=JSON.stringify(t);return i(r.encode(n))}function d(e){let t=e.trim().toLowerCase();if(!/^[0-9a-f]+$/.test(t)||t.length%2!=0)throw Error(`Invalid hex`);let n=new Uint8Array(t.length/2);for(let e=0;e<n.length;e++)n[e]=parseInt(t.slice(e*2,e*2+2),16);return n}function f(e){let t=e.trim();return t.length>=32&&t.length%2==0&&/^[0-9a-fA-F]+$/.test(t)}function p(e){let t=e.trim();return t.length>=16&&/^[A-Za-z0-9\-_]+$/.test(t)}function m(e){let t=e.trim();if(!t)throw Error(`Empty kaiSignature`);if(f(t))return d(t);if(p(t))try{return o(t)}catch{}return i(r.encode(t))}function h(){if(typeof crypto>`u`||!crypto.subtle)throw Error(`WebCrypto subtle unavailable`);return crypto.subtle}async function g(e){let t=h(),n=i(e.ikm),r=i(e.salt),a=i(e.info),o=await t.importKey(`raw`,n,{name:`HKDF`},!1,[`deriveBits`]),s=await t.deriveBits({name:`HKDF`,hash:`SHA-256`,salt:r,info:a},o,e.bits);return new Uint8Array(s)}async function _(e,t){if(e.length!==32)throw Error(`AES-256 key must be 32 bytes`);let n=h(),r=i(e);return await n.importKey(`raw`,r,{name:`AES-GCM`},!1,t)}async function v(e){if(e.iv12.length!==12)throw Error(`AES-GCM iv must be 12 bytes`);let t=h(),n=i(e.iv12),a=i(r.encode(e.aad)),o=i(e.plaintext),s=await t.encrypt({name:`AES-GCM`,iv:n,additionalData:a},e.key,o);return new Uint8Array(s)}async function y(e){if(e.iv12.length!==12)throw Error(`AES-GCM iv must be 12 bytes`);let t=h(),n=i(e.iv12),a=i(r.encode(e.aad)),o=i(e.ciphertext),s=await t.decrypt({name:`AES-GCM`,iv:n,additionalData:a},e.key,o);return new Uint8Array(s)}async function b(e){return await g({ikm:e.kaiSigBytes,salt:e.salt,info:r.encode(`KaiVoh.wrapKey.derived.v1`),bits:256})}async function x(e){return await g({ikm:e.kaiSigBytes,salt:e.salt,info:r.encode(`KaiVoh.wrapKey.glyph.v1`),bits:256})}async function S(e){return await g({ikm:m(e.baseKaiSignature),salt:o(e.salt_b64url),info:r.encode(`KaiVoh.deriveKaiSignature.v1`),bits:256})}async function C(e){return a(await S(e))}function w(e=18){return a(s(e))}async function T(r){let i=[],c=s(32),l=s(12),d=await v({key:await _(c,[`encrypt`,`decrypt`]),iv12:l,aad:e,plaintext:u(r.inner)});if(r.derived){let e=r.derived.salt_b64url??w(18),n=o(e),l=await _(await b({kaiSigBytes:await S({baseKaiSignature:r.derived.issuerKaiSignature,salt_b64url:e}),salt:n}),[`encrypt`,`decrypt`]),u=s(12),d=await v({key:l,iv12:u,aad:t,plaintext:c});i.push({kind:`derived`,salt_b64url:e,issuerPhiKey:r.derived.issuerPhiKey,wrap_iv_b64url:a(u),wrap_ct_b64url:a(d)})}if(Array.isArray(r.allowGlyphs)&&r.allowGlyphs.length>0)for(let e of r.allowGlyphs){let t=w(18),r=o(t),l=await _(await x({kaiSigBytes:m(e.kaiSignature),salt:r}),[`encrypt`,`decrypt`]),u=s(12),d=await v({key:l,iv12:u,aad:n,plaintext:c});i.push({kind:`glyph`,allowPhiKey:e.phiKey,allowSigilId:e.sigilId,salt_b64url:t,wrap_iv_b64url:a(u),wrap_ct_b64url:a(d)})}if(i.length===0)throw Error(`sealEnvelopeV1: no grants provided (derived or allowGlyphs required)`);return{v:1,alg:`AES-256-GCM`,kdf:`HKDF-SHA-256`,content_iv_b64url:a(l),content_ct_b64url:a(d),grants:i,teaser:r.teaser}}async function E(e,n){let r=o(e.salt_b64url),i=o(e.wrap_iv_b64url),a=o(e.wrap_ct_b64url);{let e=await _(await b({kaiSigBytes:m(n),salt:r}),[`decrypt`]);try{return await y({key:e,iv12:i,aad:t,ciphertext:a})}catch{}}try{return await y({key:await _(await b({kaiSigBytes:await S({baseKaiSignature:n,salt_b64url:e.salt_b64url}),salt:r}),[`decrypt`]),iv12:i,aad:t,ciphertext:a})}catch{return null}}async function D(e,t){let r=o(e.salt_b64url),i=o(e.wrap_iv_b64url),a=o(e.wrap_ct_b64url);try{return await y({key:await _(await x({kaiSigBytes:m(t),salt:r}),[`decrypt`]),iv12:i,aad:n,ciphertext:a})}catch{return null}}async function O(t,n){if(!t||t.v!==1)return{ok:!1,error:`Unsupported sealed envelope version`};if(!Array.isArray(t.grants)||t.grants.length===0)return{ok:!1,error:`No grants`};let r=o(t.content_iv_b64url),i=o(t.content_ct_b64url);for(let a of t.grants){if(a.kind===`glyph`){if(n.phiKey&&n.phiKey!==a.allowPhiKey)continue;let t=await D(a,n.kaiSignature);if(!t||t.length!==32)continue;try{let n=await y({key:await _(t,[`decrypt`]),iv12:r,aad:e,ciphertext:i}),o=new TextDecoder().decode(n);return{ok:!0,inner:JSON.parse(o),usedGrant:a}}catch{}}if(a.kind===`derived`){let t=await E(a,n.kaiSignature);if(!t||t.length!==32)continue;try{let n=await y({key:await _(t,[`decrypt`]),iv12:r,aad:e,ciphertext:i}),o=new TextDecoder().decode(n);return{ok:!0,inner:JSON.parse(o),usedGrant:a}}catch{}}}if(!n.phiKey)for(let a of t.grants){if(a.kind!==`glyph`)continue;let t=await D(a,n.kaiSignature);if(!(!t||t.length!==32))try{let n=await y({key:await _(t,[`decrypt`]),iv12:r,aad:e,ciphertext:i}),o=new TextDecoder().decode(n);return{ok:!0,inner:JSON.parse(o),usedGrant:a}}catch{}}return{ok:!1,error:`Access denied (no grant could be unlocked with provided glyph)`}}export{O as a,T as i,S as n,w as r,C as t};