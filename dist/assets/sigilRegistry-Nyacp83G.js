import{Bt as e,En as t,Ht as n,Mn as r,t as i,tn as a}from"./index-iMpvLCYB.js";import{n as o}from"./SigilAuthContext-BgvWtxs8.js";var s=r(t(),1),c=r(a(),1);function l(e){return typeof e==`string`?e.toLowerCase():``}function u(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function d(e){return typeof e==`string`&&e.length>0}function f(e){return typeof e==`number`&&Number.isFinite(e)}function p(e){if(typeof e!=`string`||!e)return!1;try{let t=new URL(e);return t.protocol===`https:`||t.protocol===`http:`}catch{return!1}}function m(e){if(typeof e!=`object`||!e)throw Error(`Malformed sigil metadata.`);let t=e;for(let e of[`pulse`,`beat`,`stepIndex`,`chakraDay`])if(!u(t,e))throw Error(`Missing Kai field: ${e}`);if(!u(t,`kaiSignature`))throw Error(`Invalid Kai Signature — tampered or unsigned sigil.`);if(!f(t.pulse))throw Error(`Invalid field: pulse`);if(!f(t.beat))throw Error(`Invalid field: beat`);if(!f(t.stepIndex))throw Error(`Invalid field: stepIndex`);if(!d(t.chakraDay))throw Error(`Invalid field: chakraDay`);if(!d(t.kaiSignature))throw Error(`Invalid field: kaiSignature`)}function h(e){try{let t=new DOMParser().parseFromString(e,`image/svg+xml`),n=Array.from(t.getElementsByTagName(`metadata`)),r=[`valuation`,`ledger`,`dht`,`source`];for(let e of n){let t=e.getAttribute(`id`)??``;if(r.some(e=>t.includes(e)))continue;let n=(e.textContent??``).trim();if(!n)continue;let i=n.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(i);if(typeof e==`object`&&e&&u(e,`pulse`)&&u(e,`beat`)&&u(e,`stepIndex`)&&u(e,`chakraDay`)&&u(e,`kaiSignature`))return e}catch{}}return null}catch{return null}}function g(e,t){let n=[`sigilActionUrl`,`sigilUrl`,`actionUrl`,`url`,`claimedUrl`,`loginUrl`,`sourceUrl`,`originUrl`,`link`,`href`];if(t)for(let e of n){let n=t[e];if(p(n))return n}try{let t=new DOMParser().parseFromString(e,`image/svg+xml`);for(let e of Array.from(t.getElementsByTagName(`metadata`))){let t=(e.textContent??``).trim();if(!t)continue;let r=t.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(r);if(typeof e==`object`&&e)for(let t of n){let n=e[t];if(p(n))return n}}catch{let e=r.match(/https?:\/\/[^\s"'<>)#]+/i);if(e&&p(e[0]))return e[0]}}for(let e of Array.from(t.getElementsByTagName(`a`))){let t=e.getAttribute(`href`)||e.getAttribute(`xlink:href`);if(p(t))return t}}catch{}return null}function _(){return(0,c.jsxs)(`svg`,{className:`kai-orb-svg`,viewBox:`0 0 88 88`,role:`img`,"aria-label":`Kai Orb`,children:[(0,c.jsx)(`defs`,{children:(0,c.jsxs)(`radialGradient`,{id:`orbGlow`,cx:`50%`,cy:`50%`,r:`50%`,children:[(0,c.jsx)(`stop`,{offset:`0%`,stopColor:`#ffffff`,stopOpacity:`1`}),(0,c.jsx)(`stop`,{offset:`55%`,stopColor:`#00ffd0`,stopOpacity:`1`}),(0,c.jsx)(`stop`,{offset:`100%`,stopColor:`#00ffd0`,stopOpacity:`0`})]})}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`41`,fill:`none`,stroke:`#00ffd0`,strokeOpacity:`0.38`,strokeWidth:`1.6`}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`32`,fill:`none`,stroke:`#8a2be2`,strokeOpacity:`0.45`,strokeWidth:`1.4`}),(0,c.jsxs)(`g`,{opacity:`0.45`,children:[(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`20`,fill:`none`,stroke:`rgba(255,255,255,.3)`,strokeWidth:`.8`}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`10`,fill:`none`,stroke:`rgba(255,255,255,.25)`,strokeWidth:`.7`}),(0,c.jsx)(`line`,{x1:`44`,y1:`4`,x2:`44`,y2:`84`,stroke:`rgba(255,255,255,.2)`,strokeWidth:`.8`}),(0,c.jsx)(`line`,{x1:`4`,y1:`44`,x2:`84`,y2:`44`,stroke:`rgba(255,255,255,.2)`,strokeWidth:`.8`})]}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`10`,fill:`url(#orbGlow)`}),(0,c.jsx)(`path`,{d:`M44 14 L72 68 H16 Z`,fill:`none`,stroke:`#00b4ff`,strokeOpacity:`0.35`,strokeWidth:`1.2`})]})}function v({onVerified:t}){let r=(0,s.useRef)(null),[a,d]=(0,s.useState)(null),[f,p]=(0,s.useState)(!1),[v,y]=(0,s.useState)(!1),[b,x]=(0,s.useState)(null),{setAuth:S}=o(),C=(0,s.useCallback)(async a=>{p(!0),d(null),x(null);try{if(a.type!==`image/svg+xml`&&!a.name.toLowerCase().endsWith(`.svg`))throw Error(`Please upload an SVG sigil file.`);let r=await a.text(),{meta:o,contextOk:s,typeOk:c}=await i(a),d=o&&u(o,`kaiSignature`)&&u(o,`pulse`)?o:h(r);if(!d||!s||!c)throw Error(`Malformed or unrecognized sigil structure.`);m(d);let f=d,p=await e(f);if(!p||l(p)!==l(f.kaiSignature))throw Error(`Invalid Kai Signature — tampered or unsigned sigil.`);let _=await n(f.kaiSignature);if(typeof f.userPhiKey==`string`){if(l(_)!==l(f.userPhiKey))throw Error(`Φ-Key mismatch — identity invalid.`)}else f.userPhiKey=_;let v=g(r,f)??void 0;S(r,{pulse:f.pulse,beat:f.beat,stepIndex:f.stepIndex,chakraDay:f.chakraDay,kaiSignature:f.kaiSignature,userPhiKey:f.userPhiKey,...typeof f.sigilId==`string`?{sigilId:f.sigilId}:{},...v?{sigilActionUrl:v}:{}}),x(f),t(r,f)}catch(e){d(e instanceof Error?e.message:`Invalid sigil file. Ensure it’s a Kai-sealed SVG with embedded JSON <metadata>.`)}finally{p(!1),r.current&&(r.current.value=``)}},[t,S]),w=async e=>{let t=e.target.files?.[0];t&&await C(t)};return(0,c.jsx)(`div`,{className:`sigil-login-only w-full max-w-xl mx-auto`,children:(0,c.jsxs)(`div`,{onDrop:async e=>{e.preventDefault(),e.stopPropagation(),y(!1);let t=e.dataTransfer.files?.[0];t&&await C(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),y(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),y(!1)},onKeyDown:e=>{f||(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),r.current?.click())},className:[`sigil-dropzone`,v?`sigil-dropzone--over`:``,f?`sigil-dropzone--loading`:``,b?`sigil-dropzone--ok`:``,a?`sigil-dropzone--err`:``].filter(Boolean).join(` `),role:`button`,tabIndex:0,"aria-disabled":f,title:`Drag & drop your Kai-sealed SVG here, or tap to browse`,"aria-label":`Inhale or drop your Kai-sealed SVG sigil`,"aria-describedby":`sigil-instructions sigil-trustline`,onClick:()=>{f||r.current?.click()},children:[(0,c.jsx)(`div`,{className:`sigil-grid`,"aria-hidden":!0}),(0,c.jsx)(`div`,{className:`sigil-ring sigil-ring--outer`,"aria-hidden":!0}),(0,c.jsx)(`div`,{className:`sigil-ring sigil-ring--inner`,"aria-hidden":!0}),(0,c.jsxs)(`div`,{className:`sigil-center`,children:[(0,c.jsx)(`div`,{className:`sigil-orb`,"aria-hidden":!0,children:(0,c.jsx)(_,{})}),(0,c.jsxs)(`p`,{id:`sigil-instructions`,className:`sigil-instructions`,children:[`Inhale, `,(0,c.jsx)(`span`,{className:`sigil-accent`,children:`Φkey here.`})]}),(0,c.jsxs)(`div`,{className:`sigil-status`,"aria-live":`polite`,children:[f&&(0,c.jsxs)(`div`,{className:`sigil-status__row`,children:[(0,c.jsx)(`span`,{className:`sigil-spinner`,"aria-hidden":`true`}),(0,c.jsx)(`span`,{children:`Verifying signature & deriving Φ-Key…`})]}),!f&&b&&(0,c.jsxs)(`div`,{className:`sigil-status__ok`,children:[(0,c.jsx)(`span`,{className:`ok-dot`,"aria-hidden":`true`}),(0,c.jsx)(`span`,{children:`Verified — Φ-Key bound`})]}),!f&&a&&(0,c.jsx)(`div`,{className:`sigil-status__err`,children:a})]})]}),(0,c.jsx)(`input`,{ref:r,type:`file`,accept:`.svg,image/svg+xml`,onChange:w,className:`sigil-file-input`,tabIndex:-1,"aria-hidden":`true`})]})})}const y=`kai:sigils:v1`,b=`sigil:urls`;var x=typeof window<`u`;function S(){if(!x)return{};let e=window;return e.__SIGIL__||={},e.__SIGIL__}function C(e){if(!x)return[];try{let t=window.localStorage.getItem(e);if(!t)return[];let n=JSON.parse(t);return Array.isArray(n)?n.filter(e=>typeof e==`string`).map(e=>e.trim()).filter(Boolean):[]}catch{return[]}}function w(e,t){if(x)try{let n=Array.from(new Set(t.map(e=>e.trim()).filter(Boolean)));window.localStorage.setItem(e,JSON.stringify(n))}catch{}}function T(e,t){return e.includes(t)?!1:(e.push(t),!0)}function E(e){let t=e.trim();if(!t)return null;if(!x)return t;try{return new URL(t,window.location.origin).toString()}catch{return t}}var D=null;function O(){return!x||!(`BroadcastChannel`in window)?null:D||(D=new BroadcastChannel(`kai-sigil-registry`),D)}function k(e){if(!x)return;let t=E(e);if(!t)return;let n=C(y);T(n,t)&&w(y,n);let r=C(b);T(r,t)&&w(b,r);try{let e=new CustomEvent(`sigil:url-registered`,{detail:{url:t}});window.dispatchEvent(e)}catch{}try{O()?.postMessage({type:`sigil:add`,url:t})}catch{}try{let e=S();e.registerSigilUrl!==k&&(e.registerSigilUrl=k)}catch{}}if(x)try{let e=S();e.registerSigilUrl!==k&&(e.registerSigilUrl=k)}catch{}export{v as n,k as t};