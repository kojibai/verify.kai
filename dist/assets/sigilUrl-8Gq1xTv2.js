const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/__vite-browser-external-BAvXPwaV.js","assets/index-B3x9bTgI.js","assets/index-C6OlTZ9f.css"])))=>i.map(i=>d[i]);
import{C as e,M as t,_ as n}from"./index-B3x9bTgI.js";const r=`username_claim`,i=1,a=1800,o=3500;function s(e){return typeof e==`object`&&!!e}function c(e){return typeof e==`string`}function l(e){return typeof e==`number`&&Number.isFinite(e)}function u(e){return e===void 0||c(e)}function d(e){return e===void 0||l(e)}function f(e){return e===void 0||e===`x`||e===`manual`}function p(e){return s(e)?e.kind===`username_claim`&&c(e.username)&&c(e.normalized)&&c(e.originHash)&&(e.ownerHint===void 0||e.ownerHint===null||c(e.ownerHint)):!1}function ee(e){return s(e)?c(e.hash)&&(e.url===void 0||c(e.url))&&p(e.payload)&&(e.ownerHint===void 0||e.ownerHint===null||c(e.ownerHint)):!1}function te(e){return s(e)?e.kind===`text`&&c(e.text):!1}function ne(e){return s(e)?e.kind===`code`&&c(e.code)&&u(e.lang):!1}function re(e){if(!s(e))return!1;let t=e.mode,n=t===void 0||t===`code`||t===`sanitized`;return e.kind===`html`&&c(e.html)&&n}function ie(e){return s(e)?e.kind===`md`&&c(e.md):!1}function ae(e){return te(e)||ne(e)||re(e)||ie(e)}function oe(e){return e===void 0||ae(e)}function se(e){return s(e)?e.kind===`url`&&c(e.url)&&u(e.title):!1}function ce(e){if(!s(e))return!1;let t=e.kind===`file-ref`,n=e.sha256;return!!t&&c(n)&&/^[0-9a-f]{64}$/.test(n)&&u(e.name)&&u(e.type)&&d(e.size)&&(e.url===void 0||c(e.url))}function le(e){return s(e)?e.kind===`file-inline`&&u(e.name)&&u(e.type)&&d(e.size)&&c(e.data_b64url)&&(e.thumbnail_b64===void 0||c(e.thumbnail_b64)):!1}function ue(e){return se(e)||ce(e)||le(e)}function m(e){return!(!s(e)||e.version!==1||!Array.isArray(e.items)||!e.items.every(ue)||!d(e.totalBytes)||!d(e.inlinedBytes))}function de(e){return e===void 0||s(e)}function fe(e){return s(e)?e.v===2&&c(e.url)&&l(e.pulse)&&f(e.source)&&u(e.caption)&&oe(e.body)&&u(e.author)&&u(e.sigilId)&&u(e.phiKey)&&u(e.kaiSignature)&&u(e.parent)&&u(e.parentUrl)&&u(e.originUrl)&&d(e.ts)&&(e.attachments===void 0||m(e.attachments))&&de(e.seal)&&(e.usernameClaim===void 0||ee(e.usernameClaim)):!1}function pe(e){return s(e)?e.v===1&&c(e.url)&&l(e.pulse)&&f(e.source)&&u(e.caption)&&u(e.author)&&u(e.sigilId)&&u(e.phiKey)&&u(e.kaiSignature)&&u(e.parent)&&u(e.parentUrl)&&u(e.originUrl)&&d(e.ts)&&(e.attachments===void 0||m(e.attachments)):!1}var h=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/`,g=(()=>{let e=new Int16Array(256);for(let t=0;t<256;t++)e[t]=-1;for(let t=0;t<64;t++)e[h.charCodeAt(t)]=t;return e})();function me(e){let t=[],n=e.length,r=0;for(;r+2<n;r+=3){let n=e[r]<<16|e[r+1]<<8|e[r+2];t.push(h[n>>>18&63]+h[n>>>12&63]+h[n>>>6&63]+h[n&63])}let i=n-r;if(i===1){let n=e[r]<<16;t.push(h[n>>>18&63]+h[n>>>12&63]+`==`)}else if(i===2){let n=e[r]<<16|e[r+1]<<8;t.push(h[n>>>18&63]+h[n>>>12&63]+h[n>>>6&63]+`=`)}return t.join(``).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function _(e){let t=(e??``).trim();if(!t)return new Uint8Array;let n=t.replace(/-/g,`+`).replace(/_/g,`/`);n=n.replace(/[\r\n\s]/g,``);let r=(4-n.length%4)%4;r&&(n+=`=`.repeat(r));let i=n.length;if(i%4!=0)throw Error(`Invalid base64 length`);let a=i/4*3;i>=2&&n[i-2]===`=`&&n[i-1]===`=`?a-=2:i>=1&&n[i-1]===`=`&&--a;let o=new Uint8Array(a),s=0;for(let e=0;e<i;e+=4){let t=n.charCodeAt(e),r=n.charCodeAt(e+1),i=n.charCodeAt(e+2),c=n.charCodeAt(e+3),l=g[t],u=g[r],d=i===61?64:g[i],f=c===61?64:g[c];if(l<0||u<0||d<0||f<0)throw Error(`Invalid base64 character`);let p=l<<18|u<<12|(d&63)<<6|f&63;o[s++]=p>>>16&255,d!==64&&s<a&&(o[s++]=p>>>8&255),f!==64&&s<a&&(o[s++]=p&255)}return o}function v(e){let t=JSON.stringify(e);return me(new TextEncoder().encode(t))}function he(e){let t=e.parentUrl??e.parent,n=e.caption,r=n&&n.trim()?{kind:`text`,text:n}:void 0;return{v:2,url:e.url,pulse:e.pulse,caption:e.caption,body:r,author:e.author,source:e.source,sigilId:e.sigilId,phiKey:e.phiKey,kaiSignature:e.kaiSignature,parent:e.parent,parentUrl:t,originUrl:e.originUrl,ts:e.ts,attachments:e.attachments}}function y(e){try{if(!e||e.length>1e6)return null;let t=_(e);if(t.length===0)return null;let n=new TextDecoder().decode(t),r=JSON.parse(n);return fe(r)?r:pe(r)?he(r):null}catch{return null}}function b(e){if(e instanceof ArrayBuffer)return e;let t=new Uint8Array(e),n=new ArrayBuffer(t.byteLength);return new Uint8Array(n).set(t),n}function ge(e){let t=new Uint8Array(e),n=``;for(let e=0;e<t.length;e++)n+=t[e].toString(16).padStart(2,`0`);return n}async function _e(n){let r=b(n);if(globalThis.crypto!==void 0&&`subtle`in globalThis.crypto)return ge(await globalThis.crypto.subtle.digest(`SHA-256`,r));let{createHash:i}=await e(async()=>{let{createHash:e}=await import(`./__vite-browser-external-BAvXPwaV.js`).then(t(1));return{createHash:e}},__vite__mapDeps([0,1,2]));return i(`sha256`).update(new Uint8Array(r)).digest(`hex`)}function ve(e,t){let n=b(e);try{return new Blob([n],{type:t||`application/octet-stream`})}catch{return new Blob([n])}}function ye(e){return _(e)}function x(e){let t=0,n=0,r=e.attachments?.items??[];for(let e of r)e.kind===`file-ref`?t+=e.size??0:e.kind===`file-inline`&&(t+=e.size??0,n+=e.data_b64url.length*.75,e.thumbnail_b64&&(n+=e.thumbnail_b64.length*.75));return{totalBytes:Math.round(t),inlinedBytes:Math.round(n)}}function S(e){if(!e.attachments)return e;let t=e.attachments.items.map(e=>{if(e.kind===`file-inline`&&e.thumbnail_b64){let t={...e};return delete t.thumbnail_b64,t}return e}),{totalBytes:n,inlinedBytes:r}=x({attachments:{...e.attachments,items:t}});return{...e,attachments:{version:1,items:t,totalBytes:n,inlinedBytes:r}}}async function be(e,t={}){let n=t.cacheName??`sigil-attachments-v1`,r=(t.pathPrefix??`/att/`).replace(/\/+$/,``)+`/`,i=S(e);if(!i.attachments||i.attachments.items.length===0||!(globalThis.caches!==void 0&&typeof globalThis.caches.open==`function`))return i;let a=null;try{a=await globalThis.caches.open(n)}catch{a=null}let o=[];for(let e of i.attachments.items){if(e.kind!==`file-inline`){o.push(e);continue}if(!a){o.push(e);continue}try{let t=ye(e.data_b64url),n=await _e(t.buffer),i=ve(t.buffer,e.type),s=`${r}${n}`;await a.put(new Request(s,{method:`GET`}),new Response(i,{headers:e.type?{"Content-Type":e.type}:void 0}));let c={kind:`file-ref`,name:e.name,type:e.type,size:e.size,sha256:n,url:s};o.push(c)}catch{o.push(e)}}return{...i,attachments:P(o)}}function C(e){let t=v(S(e));return{token:t,withinSoft:t.length<=a,withinHard:t.length<=o}}function w(e){let t=(e??``).trim();if(!t)return``;if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch{}return t.includes(` `)&&(t=t.replace(/ /g,`+`)),/[+/=]/.test(t)&&(t=t.replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)),t}function T(e){try{let t=e??(typeof window<`u`&&window.location?window.location:null);if(!t)return null;let n=t.hash.startsWith(`#`)?t.hash.slice(1):t.hash,r=t.search.startsWith(`?`)?t.search.slice(1):t.search,i=new URLSearchParams(n),a=new URLSearchParams(r),o=i.get(`t`)??i.get(`p`)??i.get(`token`);if(o)return w(o);let s=a.get(`t`)??a.get(`p`)??a.get(`token`);if(s)return w(s);let c=t.pathname.match(/^\/(?:stream|feed)\/p\/([^/?#]+)\/?$/);if(c?.[1])return w(c[1]);let l=t.pathname.match(/^\/p~([^/?#]+)\/?$/);return l?.[1]?w(l[1]):null}catch{return null}}function E(e){let t=(e??``).trim();if(!t)return null;let n=t.split(`?`)[0].split(`#`)[0],r=e=>{try{return decodeURIComponent(e)}catch{return e}},i=n.match(/^\/p~([^/?#]+)\/?$/);if(i?.[1])return w(r(i[1]));let a=n.match(/^\/(?:stream|feed)\/p\/([^/?#]+)\/?$/);return a?.[1]?w(r(a[1])):null}function D(e){let t=typeof window<`u`?window.location?.origin??void 0:void 0,n=e.trim();if(!n)return null;if(/^[A-Za-z0-9_-]{16,}$/u.test(n))return w(n);let r;try{r=new URL(n)}catch{try{r=new URL(n,t)}catch{return null}}let i=r.pathname||``;{let e=i.match(/\/(?:stream|feed)\/p\/([^/?#]+)/u);if(e?.[1])return w(e[1])}{let e=i.match(/\/p\/([^/?#]+)/u);if(e?.[1])return w(e[1])}{let e=i.match(/\/p(?:\u007e|%7[Ee])\/?([^/?#]+)/u);if(e?.[1])return w(e[1])}let a=r.hash&&r.hash.startsWith(`#`)?r.hash.slice(1):``,o=new URLSearchParams(a);for(let e of[`t`,`p`,`token`,`capsule`]){let t=o.get(e);if(t)return w(t);let n=r.searchParams.get(e);if(n)return w(n)}return null}async function O(e,t={}){let n=S(e);if(C(n).withinHard||!(n.attachments?.items?.some(e=>e.kind===`file-inline`)??!1))return n;if(!(globalThis.caches!==void 0&&typeof globalThis.caches.open==`function`))throw Error(`Inline attachments exceed safe token size, but CacheStorage is unavailable on this device/session. Attach via a public URL (Drive/S3/IPFS) or use smaller files.`);let r=await be(n,t),i=C(r),a=r.attachments?.items?.some(e=>e.kind===`file-inline`)??!1;if(!i.withinHard&&a)throw Error(`Inline attachments are still too large to share safely (and could not be cached). Attach via public URL or reduce inline file size/count.`);return S(r)}function k(e){return{kind:`text`,text:e}}function A(e,t){return{kind:`code`,code:e,lang:t}}function j(e,t){return{kind:`html`,html:e,mode:t}}function M(e){return{kind:`md`,md:e}}function N(e){let t=e.parentUrl??e.parent,n=e.caption??(e.body?.kind===`text`&&e.body.text.length>0?e.body.text:void 0);return{v:2,url:e.url,pulse:e.pulse,caption:n,body:e.body,author:e.author,source:e.source,sigilId:e.sigilId,phiKey:e.phiKey,kaiSignature:e.kaiSignature,parent:e.parent,parentUrl:t,originUrl:e.originUrl,ts:e.ts,attachments:e.attachments,seal:e.seal,usernameClaim:e.usernameClaim}}function P(e){let t={version:1,items:e.slice()},{totalBytes:n,inlinedBytes:r}=x({attachments:t});return t.totalBytes=n,t.inlinedBytes=r,t}function xe(e){return{kind:`file-inline`,name:e.name,type:e.type,size:e.size,data_b64url:e.data_b64url,thumbnail_b64:e.thumbnail_b64}}function F(e){if(!/^[0-9a-f]{64}$/.test(e.sha256))throw Error(`sha256 must be 64 hex chars`);return{kind:`file-ref`,sha256:e.sha256,name:e.name,type:e.type,size:e.size,url:e.url}}function Se(e){return{kind:`url`,url:e.url,title:e.title}}function Ce(e){let t=JSON.stringify(e);return`h:${R(I(new TextEncoder().encode(t)))}`}function we(e){if(!e.startsWith(`h:`))throw Error(`Invalid history param`);let t=L(z(e.slice(2))),n=new TextDecoder().decode(t);return JSON.parse(n)}var Te=e=>typeof globalThis.btoa==`function`?globalThis.btoa(e):Buffer.from(e,`binary`).toString(`base64`),Ee=e=>typeof globalThis.atob==`function`?globalThis.atob(e):Buffer.from(e,`base64`).toString(`binary`),I=e=>Te(String.fromCharCode(...e)),L=e=>Uint8Array.from(Ee(e),e=>e.charCodeAt(0)),R=e=>e.replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``),z=e=>{let t=e.replace(/-/g,`+`).replace(/_/g,`/`);return t+(t.length%4?`=`.repeat(4-t.length%4):``)};function B(e){let t={u:e.pulse,b:e.beat,s:e.stepIndex,c:e.chakraDay,d:e.stepsPerBeat??44,k:e.kaiSignature,p:e.userPhiKey};e.parentUrl&&(t.r=e.parentUrl),e.originUrl&&(t.o=e.originUrl);let n=JSON.stringify(t);return`c:${R(I(new TextEncoder().encode(n)))}`}function V(e){if(e.startsWith(`c:`)){let t=L(z(e.slice(2))),n=new TextDecoder().decode(t),r=JSON.parse(n);return{pulse:Number(r.u)||0,beat:Number(r.b)||0,stepIndex:Number(r.s)||0,chakraDay:r.c,stepsPerBeat:Number(r.d)||44,kaiSignature:typeof r.k==`string`?r.k:void 0,userPhiKey:typeof r.p==`string`?r.p:void 0,parentUrl:typeof r.r==`string`?r.r:void 0,originUrl:typeof r.o==`string`?r.o:void 0}}let t=L(z(e.startsWith(`j:`)?e.slice(2):e)),n=new TextDecoder().decode(t),r=JSON.parse(n),i={pulse:Number(r.pulse)||0,beat:Number(r.beat)||0,stepIndex:Number(r.stepIndex)||0,chakraDay:r.chakraDay,stepsPerBeat:Number(r.stepsPerBeat)||44,kaiSignature:typeof r.kaiSignature==`string`?r.kaiSignature:void 0,userPhiKey:typeof r.userPhiKey==`string`?r.userPhiKey:void 0,parentUrl:typeof r.parentUrl==`string`?r.parentUrl:void 0,originUrl:typeof r.originUrl==`string`?r.originUrl:void 0},a={expiresAtPulse:r.expiresAtPulse==null?void 0:Number(r.expiresAtPulse),canonicalHash:typeof r.canonicalHash==`string`?r.canonicalHash:void 0,transferNonce:typeof r.transferNonce==`string`?r.transferNonce:void 0,exportedAtPulse:r.exportedAtPulse==null?void 0:Number(r.exportedAtPulse),claimExtendUnit:r.claimExtendUnit===`breaths`||r.claimExtendUnit===`steps`?r.claimExtendUnit:void 0,claimExtendAmount:r.claimExtendAmount==null?void 0:Number(r.claimExtendAmount)};return{...r,...a,...i}}function H(e,t,n){let r=typeof window<`u`&&window.location?.origin?window.location.origin:``,i=n?.absolute===!1?``:n?.origin??r,a={...t},o=n?.parentUrl||(n?.autoInferParent&&typeof window<`u`?window.location.href:void 0);if(o&&!a.parentUrl){a.parentUrl=o;try{let e=W(o);a.originUrl=a.originUrl||e?.originUrl||o}catch{a.originUrl=a.originUrl||o}}let s=B(a),c=`/s/${encodeURIComponent(e)}?p=${s}`;return i?`${i}${c}`:c}function U(e){try{return new URL(e,`resolve://`).searchParams.get(`p`)??null}catch{let t=e.match(/[?&]p=([^&#]+)/);return t?decodeURIComponent(t[1]):null}}function De(e){try{let t=new URL(e,`https://example.invalid`);if(t.hash){let e=new URLSearchParams(t.hash.replace(/^#/,``)).get(`t`);if(e)return e}return E(t.pathname)||(t.searchParams.get(`p`)??null)}catch{let t=e.match(/#(?:t|p)=([^&#]+)/);if(t)return decodeURIComponent(t[1]);let n=e.match(/\/p~([^/?#]+)/);if(n)return decodeURIComponent(n[1]);let r=e.match(/\/(?:stream|feed)\/p\/([^/]+)/);if(r)return decodeURIComponent(r[1]);let i=e.match(/[?&]p=([^&#]+)/);return i?decodeURIComponent(i[1]):null}}function Oe(e){let t=De(e);if(!t)return null;let r=y(t);if(!r)return null;let i=0,a=0,o=`Root`,s=44;try{let e=n(r.pulse);typeof e.beat==`number`?i=e.beat:typeof e.beatIndex==`number`&&(i=e.beatIndex),typeof e.stepIndex==`number`&&(a=e.stepIndex),typeof e.chakraDay==`string`&&(o=e.chakraDay),typeof e.stepsPerBeat==`number`&&(s=e.stepsPerBeat)}catch{}let c=typeof r.parentUrl==`string`?r.parentUrl:typeof r.parent==`string`?r.parent:void 0;return{pulse:r.pulse,beat:i,stepIndex:a,chakraDay:o,stepsPerBeat:s,kaiSignature:typeof r.kaiSignature==`string`?r.kaiSignature:void 0,userPhiKey:typeof r.phiKey==`string`?r.phiKey:void 0,parentUrl:c,originUrl:typeof r.originUrl==`string`?r.originUrl:void 0,feed:r}}function W(e){let t=U(e);if(t)try{return V(t)}catch{}return Oe(e)}function G(e){let t=[],n=e,r=new Set;for(;n&&!r.has(n);){r.add(n),t.push(n);let e=W(n);if(!e?.parentUrl)break;n=e.parentUrl}return t}function ke(e){let t=W(e);if(t?.originUrl)return t.originUrl;let n=G(e);return n.length?n[n.length-1]:void 0}const K=`kai:sigils:v1`,q=`sigil:urls`,J=`kai-sigil-registry`;var Y=typeof window<`u`;function X(e){if(!Y)return[];try{let t=window.localStorage.getItem(e);if(!t)return[];let n=JSON.parse(t);return Array.isArray(n)?n.filter(e=>typeof e==`string`):[]}catch{return[]}}function Z(e,t){if(Y)try{window.localStorage.setItem(e,JSON.stringify(t))}catch{}}function Q(e,t){return e.includes(t)?!1:(e.push(t),!0)}function Ae(e){try{return new URL(e,Y?window.location.origin:`https://example.invalid`).toString()}catch{return e}}var $=null;function je(){return!Y||!(`BroadcastChannel`in window)?null:$||($=new BroadcastChannel(J),$)}function Me(e){if(!Y||!e)return;let t=Ae(e),n=X(K);Q(n,t)&&Z(K,n);let r=X(q);Q(r,t)&&Z(q,r);try{window.dispatchEvent(new CustomEvent(`sigil:url-registered`,{detail:{url:t}}))}catch{}try{je()?.postMessage({type:`sigil:add`,url:t})}catch{}}function Ne(e){try{let t=new URL(e),n=t.pathname.match(/\/(?:s|sigil)\/([a-f0-9]{6,})/i)?.[1],r=W(e);if(n&&r)return H(n,r);let i=t.hash?.slice(1).match(/^([a-f0-9]{6,})$/i)?.[1];return i&&r?H(i,r):null}catch(e){return console.error(`Failed to generate canonical QR URL:`,e),null}}function Pe(e){if(e)try{return new URL(e).origin}catch{}return typeof window<`u`&&typeof window.location?.origin==`string`&&window.location.origin?window.location.origin:`https://kaiklok.com`}function Fe(e,t){let n=Pe(t),r=(e??``).toString().trim().toLowerCase();if(!r)return n+`/`;let i=new URL(`/s/${encodeURIComponent(r)}`,n);if(typeof window<`u`){let e=new URLSearchParams(window.location.search),t=e.get(`d`);t&&i.searchParams.set(`d`,t);let n=e.get(`t`);n&&i.searchParams.set(`t`,n)}return i.toString()}export{M as A,D as C,F as D,A as E,r as F,Se as M,w as N,j as O,O as P,T as S,N as T,o as _,we as a,v as b,B as c,ke as d,Ne as f,i as g,G as h,Fe as i,k as j,xe as k,W as l,Me as m,q as n,V as o,H as p,K as r,Ce as s,J as t,U as u,a as v,P as w,C as x,y};