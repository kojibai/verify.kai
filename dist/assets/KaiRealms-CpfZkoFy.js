const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bundler-DW1MhLMJ.js","assets/index-BUaEhjRR.js","assets/index-BmaJNTKf.css"])))=>i.map(i=>d[i]);
import{t as e}from"./x-ZmTr4L8Q.js";import{Bt as t,Ht as n,Sn as r,Tn as i,jn as a,t as o,tn as s}from"./index-BUaEhjRR.js";var c=a(i(),1);function l(e){return typeof e==`string`?e.toLowerCase():``}function u(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function d(e){return typeof e==`string`&&e.length>0}function f(e){return typeof e==`number`&&Number.isFinite(e)}function p(e){if(typeof e!=`object`||!e)throw Error(`Malformed sigil metadata.`);let t=e;for(let e of[`pulse`,`beat`,`stepIndex`,`chakraDay`])if(!u(t,e))throw Error(`Missing Kai field: ${e}`);if(!u(t,`kaiSignature`))throw Error(`Invalid Kai Signature â€” tampered or unsigned sigil.`);if(!f(t.pulse))throw Error(`Invalid field: pulse`);if(!f(t.beat))throw Error(`Invalid field: beat`);if(!f(t.stepIndex))throw Error(`Invalid field: stepIndex`);if(!d(t.chakraDay))throw Error(`Invalid field: chakraDay`);if(!d(t.kaiSignature))throw Error(`Invalid field: kaiSignature`)}function m(e){try{let t=new DOMParser().parseFromString(e,`image/svg+xml`),n=Array.from(t.getElementsByTagName(`metadata`)),r=[`valuation`,`ledger`,`dht`,`source`];for(let e of n){let t=e.getAttribute(`id`)??``;if(r.some(e=>t.includes(e)))continue;let n=(e.textContent??``).trim();if(!n)continue;let i=n.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(i);if(typeof e==`object`&&e&&u(e,`pulse`)&&u(e,`beat`)&&u(e,`stepIndex`)&&u(e,`chakraDay`)&&u(e,`kaiSignature`))return e}catch{}}return null}catch{return null}}async function h(e){let r=await e.text(),{meta:i,contextOk:a,typeOk:s}=await o(e),c=i&&u(i,`kaiSignature`)&&u(i,`pulse`)?i:m(r);if(!c||!a||!s)throw Error(`Invalid glyph or missing metadata.`);p(c);let d=c,f=await t(d);if(!f||l(f)!==l(d.kaiSignature))throw Error(`Invalid Kai Signature â€” tampered or unsigned sigil.`);let h=await n(d.kaiSignature);if(typeof d.userPhiKey==`string`){if(l(d.userPhiKey)!==l(h))throw Error(`Î¦-Key mismatch â€” identity invalid.`)}else d.userPhiKey=h;return{svgText:r,meta:d,phiKey:h}}var g=a(s(),1),_=`.svg,image/svg+xml`,v=({onEnter:e})=>{let t=(0,c.useRef)(null),[n,r]=(0,c.useState)(!1),[i,a]=(0,c.useState)(!1),[o,s]=(0,c.useState)(``),[l,u]=(0,c.useState)(null),d=(0,c.useId)(),f=(0,c.useId)(),p=(0,c.useId)(),m=()=>{t.current&&(t.current.value=``)},v=(0,c.useCallback)(async t=>{u(null),s(t.name),a(!0);try{if(!(t.type===`image/svg+xml`||t.name.toLowerCase().endsWith(`.svg`)))throw Error(`Please upload a valid Kai Sigil (.svg).`);e(await h(t))}catch(e){u(e instanceof Error?e.message:`Invalid glyph or missing metadata.`)}finally{a(!1),m()}},[e]),y=(0,c.useCallback)(async e=>{let t=e.target.files?.[0];t&&await v(t)},[v]),b=(0,c.useCallback)(async e=>{e.preventDefault(),e.stopPropagation(),r(!1);let t=e.dataTransfer.files?.[0];t&&await v(t)},[v]),x=e=>{e.preventDefault(),e.dataTransfer.dropEffect=`copy`,n||r(!0)},S=e=>{e.currentTarget.contains(e.relatedTarget)||r(!1)},C=()=>t.current?.click(),w=e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),C())};return(0,g.jsxs)(`section`,{className:`portal-card glass-omni`,"aria-labelledby":d,"aria-describedby":f,children:[(0,g.jsx)(`div`,{className:`breath-ring breath-ring--outer`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`breath-ring breath-ring--inner`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`phi-grid`,"aria-hidden":!0}),(0,g.jsx)(`h1`,{id:d,className:`sr-only`,children:`Drop your Kai Sigil`}),(0,g.jsxs)(`div`,{className:`portal-body`,children:[(0,g.jsxs)(`div`,{className:`dropzone ${n?`dropzone--active`:``} ${i?`dropzone--busy`:``}`,role:`button`,tabIndex:0,onKeyDown:w,onClick:C,onDrop:b,onDragOver:x,onDragLeave:S,"aria-busy":i,"aria-describedby":`${f}${l?` ${p}`:``}`,children:[(0,g.jsxs)(`div`,{className:`dropzone-ornament`,"aria-hidden":!0,children:[(0,g.jsx)(`div`,{className:`ornament-ring ornament-ring--outer`}),(0,g.jsx)(`div`,{className:`ornament-ring ornament-ring--inner`}),(0,g.jsx)(`div`,{className:`ornament-core`})]}),(0,g.jsx)(`div`,{className:`dropzone-icon`,"aria-hidden":!0,children:(0,g.jsxs)(`svg`,{width:`44`,height:`44`,viewBox:`0 0 44 44`,children:[(0,g.jsx)(`defs`,{children:(0,g.jsxs)(`linearGradient`,{id:`dzG`,x1:`0`,y1:`0`,x2:`1`,y2:`1`,children:[(0,g.jsx)(`stop`,{offset:`0%`,stopColor:`#00ffd0`}),(0,g.jsx)(`stop`,{offset:`100%`,stopColor:`#8a2be2`})]})}),(0,g.jsx)(`circle`,{cx:`22`,cy:`22`,r:`20`,fill:`none`,stroke:`url(#dzG)`,strokeWidth:`1.5`}),(0,g.jsx)(`path`,{d:`M22 12 L22 30 M14 20 L22 12 L30 20`,stroke:`url(#dzG)`,strokeWidth:`2`,strokeLinecap:`round`,strokeLinejoin:`round`,fill:`none`})]})}),(0,g.jsxs)(`div`,{className:`dropzone-text`,children:[(0,g.jsx)(`div`,{className:`dz-title`,children:`Inhale your Kai Sigil`}),(0,g.jsxs)(`div`,{id:f,className:`dz-hint`,children:[`Breath-minted `,(0,g.jsx)(`strong`,{children:`Î¦key`}),` only. Drag & drop.`]}),o&&!i&&!l?(0,g.jsxs)(`div`,{className:`dz-file`,children:[`Selected: `,o]}):null,i?(0,g.jsxs)(`div`,{className:`dz-progress`,children:[(0,g.jsx)(`div`,{className:`dz-spinner`}),(0,g.jsx)(`span`,{children:`Verifyingâ€¦`})]}):null]}),(0,g.jsx)(`input`,{ref:t,type:`file`,accept:_,onChange:y,tabIndex:-1,"aria-hidden":!0,className:`dz-input`})]}),l?(0,g.jsx)(`div`,{id:p,className:`portal-error`,role:`alert`,"aria-live":`polite`,children:l}):null,(0,g.jsx)(`p`,{className:`portal-note`,children:`Your sigil is verified by breath. No drift. Only truth.`})]}),(0,g.jsx)(`span`,{className:`sr-only`,children:`Kai Realms sigil gate ready.`})]})},y=5236,b=11,x=44;function S(e){let t=e-1715323541888,n=Math.floor(t/y);return{pulseIndex:n,stepIndex:Math.floor(n/b)%x,beatIndex:Math.floor(n/(b*x))%36}}function C(e){let t=(0,c.useRef)(null);(0,c.useEffect)(()=>{let n=setInterval(()=>{let{pulseIndex:n,stepIndex:r,beatIndex:i}=S(Date.now());n!==t.current&&(e.onPulse?.(n),n%b===0&&e.onStep?.(r),n%(b*x)===0&&e.onBeat?.(i),t.current=n)},y);return()=>clearInterval(n)},[e])}var w={Root:`#FF0033`,Sacral:`#FF8000`,Solar:`#FFD700`,Heart:`#00FF99`,Throat:`#33CCFF`,ThirdEye:`#9933FF`,Crown:`#AA00FF`};function T(e,t,n,r,i){e.save(),e.translate(n,r);let{chakraDay:a,pulse:o}=t.meta,s=w[a]??`#00FFFF`;e.beginPath(),e.arc(0,0,i+4,0,Math.PI*2),e.fillStyle=s,e.shadowColor=s,e.shadowBlur=15,e.fill(),e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fillStyle=`#000012`,e.fill();let c=i+o%11*1.5;e.beginPath(),e.arc(0,0,c,0,Math.PI*2),e.strokeStyle=`${s}AA`,e.lineWidth=1.5,e.stroke(),e.restore()}var E=`kai:game:focus`,D=typeof window<`u`;function O(){if(!D||typeof BroadcastChannel>`u`)return null;try{return new BroadcastChannel(`kai-realms-game-focus`)}catch{return null}}function k(e){let t={id:e,ts:Date.now()};if(D)try{window.dispatchEvent(new CustomEvent(E,{detail:t}))}catch{}let n=O();if(n)try{n.postMessage({type:E,detail:t})}catch{}finally{try{n.close()}catch{}}}function A(e){let t=t=>{let n=t;n?.detail&&e(n.detail)};D&&window.addEventListener(E,t);let n=O(),r=t=>{let n=t?.data;n?.type===E&&n.detail&&e(n.detail)};if(n)try{n.addEventListener(`message`,r)}catch{}return()=>{if(D&&window.removeEventListener(E,t),n)try{n.removeEventListener(`message`,r)}catch{}finally{try{n.close()}catch{}}}}function j(e){let[t,n]=(0,c.useState)(!1),r=(0,c.useRef)(0);return(0,c.useEffect)(()=>A(t=>{n(t.id!==e),r.current=t.ts}),[e]),{paused:t,takeFocus:(0,c.useCallback)(()=>{k(e),n(!1)},[e])}}var M=5236,N=.085,P=1,F=60,I=6.1,L=5.6,ee=.1,te=1.6,R=10,ne=50,re=150,ie=10,ae=Math.floor(M*1.25),oe=.145,se=2.618,ce=M,z=M,le=1e3,ue=.12,B=44,de=.618,fe=.35,pe=3,me=`600 12px ui-sans-serif,system-ui,-apple-system`,V={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0},none:{x:0,y:0}},H={up:`down`,down:`up`,left:`right`,right:`left`,none:`none`};function he(e,t,n){return e+(t-e)*n}function U(e,t){return(e-t+M)%M/M}function ge(e){let t=Math.sin(Math.PI*e);return .78+.44*(t*t)}function _e(e){let t=e.toLowerCase();return t===`arrowup`||t===`w`?`up`:t===`arrowdown`||t===`s`?`down`:t===`arrowleft`||t===`a`?`left`:t===`arrowright`||t===`d`?`right`:`none`}function W(e,t,n){let r=Math.round(n),i=Math.round(t);return r<0||r>=e.length||i<0||i>=e[0].length?!1:e[r][i]!==1}function G(e){return{x:Math.round(e.x),y:Math.round(e.y)}}function K(e,t){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r}function ve(){let e=Array.from({length:23},()=>Array(27).fill(1));((t,n,r,i)=>{for(let a=n;a<n+i;a++)for(let n=t;n<t+r;n++)a>0&&a<22&&n>0&&n<26&&(e[a][n]=0)})(1,1,25,21);for(let t=2;t<25;t++)e[5][t]=1,e[17][t]=1;for(let t=2;t<21;t++)e[t][4]=1,e[t][22]=1;for(let t=6;t<21;t++)e[11][t]=0;for(let t=4;t<19;t++)e[t][13]=0;for(let t=1;t<22;t++)for(let n=1;n<26;n++)e[t][n]===0&&(e[t][n]=2);for(let t of[{x:6,y:6},{x:20,y:6},{x:6,y:16},{x:20,y:16}])e[t.y][t.x]=3;for(let t of[{x:2,y:2},{x:24,y:2},{x:2,y:20},{x:24,y:20}])e[t.y]?.[t.x]!==1&&(e[t.y][t.x]=4);return e}function ye(e){return{pos:{x:e.x,y:e.y},dir:`left`,next:`left`,speed:I}}function q(e,t,n){return{pos:{x:e.x,y:e.y},dir:`left`,speed:L,scatterTarget:n,mode:`chase`,frightUntil:0,color:t}}function be(e){let t=0;for(let n=0;n<e.length;n++)for(let r=0;r<e[0].length;r++)e[n][r]===2&&t++;return t}function xe(e,t){let n=ve(),r=n.length,i=n[0].length,a={x:Math.floor(i/2),y:r-4},o={x:Math.floor(i/2),y:Math.floor(r/2)-1},s=[q({x:o.x-2,y:o.y},`#ff4d4d`,{x:2,y:2}),q({x:o.x+2,y:o.y},`#4dd2ff`,{x:i-3,y:2}),q({x:o.x,y:o.y},`#ffd166`,{x:2,y:r-3}),q({x:o.x,y:o.y+2},`#bd7bff`,{x:i-3,y:r-3})],c={phase:`chase`,nextSwitchAt:t+Se(e,`chase`)};return{grid:n,pellets:be(n),level:e,lives:pe,points:0,bankable:0,scorePhi:0,streak:0,bestStreak:0,comboUntil:0,kaiCharge:0,alive:!0,over:!1,ghosts:s,player:ye(a),onAltar:!1,channelingUntil:0,cycle:c}}function Se(e,t){let n=t===`chase`?7e3:5e3,r=Math.max(.55,1-(e-1)*.06);return Math.floor(n*r)}function Ce(e,t){let n=G(t),r=Math.abs(t.x-n.x),i=Math.abs(t.y-n.y);if(r>=.1||i>=.1)return!1;let a=0;return[`up`,`down`,`left`,`right`].forEach(t=>{W(e,n.x+V[t].x,n.y+V[t].y)&&a++}),a>=3}function we(e,t){if(t.next===`none`||t.next===t.dir)return;if(t.next===H[t.dir]){t.dir=t.next;return}let n=G(t.pos),r=Math.abs(t.pos.x-n.x),i=Math.abs(t.pos.y-n.y);r>=.12||i>=.12||W(e,n.x+V[t.next].x,n.y+V[t.next].y)&&(t.pos.x=n.x,t.pos.y=n.y,t.dir=t.next)}function Te(e,t,n,r,i){if(n===`none`)return;let a=V[n],o=t.x+a.x*r*i,s=t.y+a.y*r*i,c=e[0].length;if(o<-1){t.x=c+1;return}if(o>c+1){t.x=-1;return}if(W(e,Math.round(o),Math.round(s)))t.x=o,t.y=s;else{let e=G(t);t.x=e.x,t.y=e.y}}function Ee(e,t,n,r){let i=[`up`,`left`,`down`,`right`],a=n,o=1/0;for(let s of i){if(s===H[n])continue;let i=Math.round(t.x)+V[s].x,c=Math.round(t.y)+V[s].y;if(!W(e,i,c))continue;let l=K({x:i,y:c},r);l<o&&(o=l,a=s)}if(a===n){let r=H[n];if(W(e,Math.round(t.x)+V[r].x,Math.round(t.y)+V[r].y))return r}return a}var De=({currentPhi:e,onPhiChange:t,onExit:n})=>{let r=(0,c.useRef)(null),i=(0,c.useRef)(null),{paused:a,takeFocus:o}=j(`KaiMaze`),[s,l]=(0,c.useState)({w:0,h:0});(0,c.useEffect)(()=>{let e=r.current;if(!e)return;let t=new ResizeObserver(e=>{for(let t of e){let e=t.contentRect;l({w:e.width,h:e.height})}});return t.observe(e),()=>t.disconnect()},[]);let[u,d]=(0,c.useState)(e);(0,c.useEffect)(()=>d(e),[e]);let[f,p]=(0,c.useState)(()=>xe(1,performance.now())),m=(0,c.useRef)(performance.now()),[h,_]=(0,c.useState)(()=>{if(typeof window>`u`)return!1;let e=window.matchMedia?.(`(pointer: coarse)`)?.matches??!1,t=window.matchMedia?.(`(max-width: 900px)`)?.matches??!1;return e||t});(0,c.useEffect)(()=>{if(typeof window>`u`)return;let e=window.matchMedia(`(pointer: coarse)`),t=window.matchMedia(`(max-width: 900px)`),n=()=>_(e.matches||t.matches);return e.addEventListener?.(`change`,n),t.addEventListener?.(`change`,n),()=>{e.removeEventListener?.(`change`,n),t.removeEventListener?.(`change`,n)}},[]);let v=(0,c.useMemo)(()=>e=>Math.floor(le*(1+ue*(e-1))),[]),y=(0,c.useMemo)(()=>h&&!f.over,[h,f.over]),b=(0,c.useMemo)(()=>(h?`Tap/Swipe or D-pad`:`â†â†‘â†’â†“ / WASD`)+` Â· B/Space to Channel on âŸ Â· Esc to exit`,[h]);(0,c.useEffect)(()=>{if(P>0&&u>=P){let e=u-P;d(e),t(e),o()}},[]);let x=()=>{p(e=>e.channelingUntil?{...e,channelingUntil:0}:e)};(0,c.useEffect)(()=>{let e=e=>{let t=e.key.toLowerCase(),r=_e(t);r!==`none`&&(x(),e.preventDefault(),o(),p(e=>({...e,player:{...e.player,next:r}}))),(t===`b`||t===` `)&&f.onAltar&&f.channelingUntil===0&&(o(),p(e=>({...e,channelingUntil:performance.now()+z}))),t===`escape`&&n&&n(),t===`r`&&f.over&&(o(),p(xe(1,performance.now())),m.current=performance.now())};return window.addEventListener(`keydown`,e),()=>window.removeEventListener(`keydown`,e)},[n,f.over,f.onAltar,f.channelingUntil]);let S=e=>{x(),o(),p(t=>({...t,player:{...t.player,next:e}}))},C=()=>{f.onAltar&&f.channelingUntil===0&&(o(),p(e=>({...e,channelingUntil:performance.now()+z})))};(0,c.useEffect)(()=>{let e=0,n=performance.now(),r=(e,n)=>{if(n.channelingUntil===0||!n.onAltar||e<n.channelingUntil)return n;let r=v(n.level);if(n.bankable<r)return{...n,channelingUntil:0};let i=1+Math.min(1,n.kaiCharge/B)*de,a=Math.max(0,Math.floor(n.bankable/r*i));if(a>0){let e=Math.floor(a*r),i=Math.max(0,n.bankable-e),o=u+a;return d(o),t(o),{...n,scorePhi:n.scorePhi+a,bankable:i,points:i,kaiCharge:Math.max(0,Math.floor(n.kaiCharge*.5)),channelingUntil:0}}return{...n,channelingUntil:0}},i=()=>{e=requestAnimationFrame(i);let o=performance.now(),s=Math.min(1/F,(o-n)/1e3);n=o,!a&&p(e=>{if(e.over)return e;let n=structuredClone(e);if(o>=n.cycle.nextSwitchAt){let e=n.cycle.phase===`chase`?`scatter`:`chase`;n.cycle={phase:e,nextSwitchAt:o+Se(n.level,e)};for(let t of n.ghosts)t.mode!==`fright`&&(t.mode=e)}let i=U(o,m.current),a=ge(i),c=Math.min(1+n.streak*ee,te),l=Math.min(1+n.streak*oe,se),f=n.channelingUntil>0?0:n.player.speed*a*c;we(n.grid,n.player),Te(n.grid,n.player.pos,n.player.dir,f,s);let p=G(n.player.pos);n.onAltar=n.grid[p.y]?.[p.x]===4;let h=n.grid[p.y]?.[p.x]??1;if((h===2||h===3)&&n.channelingUntil===0){let e=Math.abs(i-.5)<=N,t=h===2?R:ne;if(e&&(t+=ie,n.kaiCharge=Math.min(B,n.kaiCharge+1)),t=Math.floor(t*l),n.points+=t,n.bankable=n.points,n.streak+=1,n.streak>n.bestStreak&&(n.bestStreak=n.streak),n.comboUntil=o+ae,n.grid[p.y][p.x]=0,n.pellets=Math.max(0,n.pellets-1),h===3){m.current=o;let e=Math.max(ce*Math.max(.55,1-(n.level-1)*.08),M*.5);for(let t of n.ghosts)t.mode=`fright`,t.frightUntil=o+e}}n.comboUntil>0&&o>n.comboUntil&&(n.streak=Math.max(0,Math.floor(n.streak*.5)),n.comboUntil=0);for(let e of n.ghosts){e.mode===`fright`&&o>=e.frightUntil&&(e.mode=n.cycle.phase);let t=G(n.player.pos);if(Ce(n.grid,e.pos))if(e.mode===`scatter`)e.dir=Ee(n.grid,e.pos,e.dir,e.scatterTarget);else if(e.mode===`fright`){let r=G(e.pos),i=[`up`,`down`,`left`,`right`],a=e.dir,o=-1/0;for(let s of i){if(s===H[e.dir])continue;let i=r.x+V[s].x,c=r.y+V[s].y;if(!W(n.grid,i,c))continue;let l=K({x:i,y:c},t);l>o&&(o=l,a=s)}e.dir=a}else{let r={x:t.x+V[n.player.dir].x*2,y:t.y+V[n.player.dir].y*2};e.dir=Ee(n.grid,e.pos,e.dir,r)}let r=e.mode===`fright`?he(.6,.8,Math.sin(i*Math.PI)):a,c=e.speed*r;if(c*=1.06**(n.level-1),Te(n.grid,e.pos,e.dir,c,s),K(n.player.pos,e.pos)<.4)if(e.mode===`fright`&&n.channelingUntil===0){let t=Math.floor(re*l);n.points+=t,n.bankable=n.points,n.streak+=1,n.streak>n.bestStreak&&(n.bestStreak=n.streak),n.comboUntil=o+ae,e.pos={...e.scatterTarget},e.dir=`left`,e.mode=`scatter`,e.frightUntil=0}else if(--n.lives,n.streak=0,n.comboUntil=0,n.points=Math.max(0,Math.floor(n.points*(1-fe))),n.bankable=n.points,n.channelingUntil=0,n.lives<=0)n.alive=!1,n.over=!0;else{let e={x:Math.floor(n.grid[0].length/2),y:n.grid.length-4};n.player.pos={...e},n.player.dir=`left`,n.player.next=`left`;for(let e of n.ghosts)e.mode=`scatter`;m.current=o}}if(n.pellets<=0&&!n.over){let e=v(n.level),r=Math.floor(n.bankable*.2/e);if(r>0){let i=r*e,a=Math.max(0,n.bankable-i),o=u+r;d(o),t(o),n.scorePhi+=r,n.bankable=a,n.points=a}let i=xe(n.level+1,o);i.scorePhi=n.scorePhi,i.lives=Math.max(1,n.lives),i.bestStreak=Math.max(n.bestStreak,n.streak),i.player.speed=n.player.speed*1.06;for(let e of i.ghosts)e.speed*=1.06;return m.current=o,i}return n=r(o,n),n})};return e=requestAnimationFrame(i),()=>cancelAnimationFrame(e)},[t,u,a,v]),(0,c.useEffect)(()=>{let e=0,t=()=>{e=requestAnimationFrame(t);let n=i.current,o=r.current;if(!n||!o)return;let c=n.getContext(`2d`);if(!c)return;let l=Math.max(0,s.w),d=Math.max(0,s.h);if(l===0||d===0)return;let p=Math.min(2,window.devicePixelRatio||1);(n.width!==Math.floor(l*p)||n.height!==Math.floor(d*p))&&(n.width=Math.floor(l*p),n.height=Math.floor(d*p),n.style.width=`${l}px`,n.style.height=`${d}px`),c.setTransform(p,0,0,p,0,0);let h=f.grid.length,g=f.grid[0].length,_=Math.floor(Math.min(l/g,d/h)),v=_*g,y=_*h,b=Math.floor((l-v)/2),x=Math.floor((d-y)/2),S=c.createLinearGradient(0,0,0,d);S.addColorStop(0,`#07071a`),S.addColorStop(1,`#0c1231`),c.fillStyle=S,c.fillRect(0,0,l,d),Me(c,l,d);for(let e=0;e<h;e++)for(let t=0;t<g;t++){let n=f.grid[e][t],r=b+t*_,i=x+e*_;if(n===1)c.fillStyle=`rgba(255,255,255,0.06)`,c.fillRect(r,i,_,_),c.strokeStyle=`rgba(255,255,255,0.20)`,c.lineWidth=1,c.strokeRect(r+.5,i+.5,_-1,_-1);else if(n===2)c.fillStyle=`rgba(255,255,255,0.95)`,c.beginPath(),c.arc(r+_/2,i+_/2,Math.max(2,_*.09),0,Math.PI*2),c.fill();else if(n===3){let e=c.createRadialGradient(r+_/2,i+_/2,0,r+_/2,i+_/2,Math.max(9,_*.38));e.addColorStop(0,`rgba(255,255,255,0.90)`),e.addColorStop(1,`rgba(255,209,110,0.22)`),c.fillStyle=e,c.beginPath(),c.arc(r+_/2,i+_/2,Math.max(5,_*.22),0,Math.PI*2),c.fill()}else if(n===4){let e=Math.max(8,_*.36);c.save(),c.globalAlpha=.9;let t=c.createRadialGradient(r+_/2,i+_/2,e*.2,r+_/2,i+_/2,e);t.addColorStop(0,`rgba(0,255,208,0.35)`),t.addColorStop(1,`rgba(0,255,208,0.05)`),c.fillStyle=t,c.beginPath(),c.arc(r+_/2,i+_/2,e,0,Math.PI*2),c.fill(),c.strokeStyle=`rgba(0,255,208,0.8)`,c.lineWidth=2,c.beginPath(),c.arc(r+_/2,i+_/2,e*.65,0,Math.PI*2),c.stroke(),c.restore()}}let C=f.player.pos;Oe(c,b+C.x*_,x+C.y*_,_*.45,`rgba(255,255,255,0.96)`);for(let e of f.ghosts){let t=e.pos,n=e.mode===`fright`?`rgba(100,180,255,0.92)`:e.color;ke(c,b+t.x*_,x+t.y*_,_*.44,n)}let w=performance.now(),T=typeof window<`u`&&typeof window.__kai_breath_anchor==`number`?window.__kai_breath_anchor:void 0;T!==void 0&&Ae(c,l,U(w,T)),Ae(c,l,U(w,m.current)),c.fillStyle=`rgba(255,255,255,0.92)`,c.font=me;let E=Math.min(1+f.streak*oe,se);if(c.fillText(`Î¦ ${u.toFixed(0)}  |  PTS ${f.bankable}  |  x${E.toFixed(2)}  |  L${f.level}  |  Lives ${f.lives}  |  Streak ${f.streak}  |  Charge ${f.kaiCharge}/${B}`,8,14),f.channelingUntil>0&&f.onAltar){let e=1-Math.max(0,f.channelingUntil-w)/z,t=l/2;c.strokeStyle=`rgba(0,255,208,0.9)`,c.lineWidth=4,c.globalAlpha=.9,c.beginPath(),c.arc(t,34,16,-Math.PI/2,-Math.PI/2+e*Math.PI*2),c.stroke(),c.globalAlpha=1,c.font=`700 12px ui-sans-serif,system-ui,-apple-system`,c.fillText(`Channelingâ€¦`,t+16+8,38)}if(a&&!f.over){c.fillStyle=`rgba(0,0,0,0.35)`,c.fillRect(0,0,l,d),c.fillStyle=`#fff`,c.font=`700 16px ui-sans-serif,system-ui,-apple-system`;let e=`Paused â€” another Realm is active`;c.fillText(e,(l-c.measureText(e).width)/2,d/2)}if(f.over){c.fillStyle=`rgba(0,0,0,0.55)`,c.fillRect(0,0,l,d),c.fillStyle=`#fff`,c.font=`700 20px ui-sans-serif,system-ui,-apple-system`;let e=`Game Over â€” Press R to restart`;c.fillText(e,(l-c.measureText(e).width)/2,d/2)}};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[f,u,s,a]);let w=f.onAltar&&f.channelingUntil===0;return(0,g.jsxs)(`div`,{className:`km-wrap`,role:`group`,"aria-label":`Kai-Maze`,onPointerDown:()=>o(),onTouchStart:()=>o(),onMouseDown:()=>o(),children:[(0,g.jsxs)(`div`,{className:`km-header`,children:[(0,g.jsx)(`div`,{className:`km-title`,children:`ðŸŒ€ Kai-Maze`}),(0,g.jsx)(`div`,{className:`km-sub`,children:`Score on pulse, risk your points, then âŸ channel to mint Î¦.`})]}),(0,g.jsxs)(`div`,{className:`km-stage`,ref:r,children:[(0,g.jsx)(`canvas`,{ref:i,className:`km-canvas`}),y&&(0,g.jsxs)(`div`,{className:`km-dpad`,style:{position:`absolute`,left:12,bottom:12,width:132,height:132,display:`grid`,gridTemplateColumns:`repeat(3, 1fr)`,gridTemplateRows:`repeat(3, 1fr)`,gap:6,touchAction:`none`,userSelect:`none`,zIndex:4},"aria-label":`Directional pad`,children:[(0,g.jsx)(`div`,{}),(0,g.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move up`,onPointerDown:e=>{e.preventDefault(),S(`up`)},children:`â–²`}),(0,g.jsx)(`div`,{}),(0,g.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move left`,onPointerDown:e=>{e.preventDefault(),S(`left`)},children:`â—€`}),(0,g.jsx)(`button`,{className:`km-dpad-btn`,style:{...J,opacity:.9},"aria-label":`Hold to Channel (if on altar)`,onPointerDown:e=>{e.preventDefault(),C()},title:`Channel one breath to convert points â†’ Î¦`,children:`âŸ`}),(0,g.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move right`,onPointerDown:e=>{e.preventDefault(),S(`right`)},children:`â–¶`}),(0,g.jsx)(`div`,{}),(0,g.jsx)(`button`,{className:`km-dpad-btn`,style:J,"aria-label":`Move down`,onPointerDown:e=>{e.preventDefault(),S(`down`)},children:`â–¼`}),(0,g.jsx)(`div`,{})]}),w&&(0,g.jsx)(`button`,{className:`km-chan-btn`,onClick:()=>{o(),p(e=>e.channelingUntil?e:{...e,channelingUntil:performance.now()+z})},"aria-label":`Channel points into Phi`,title:`Channel one breath to convert points â†’ Î¦`,children:`âŸ CHANNEL`}),f.channelingUntil>0&&(0,g.jsx)(`button`,{className:`km-chan-cancel`,onClick:()=>{o(),p(e=>({...e,channelingUntil:0}))},"aria-label":`Cancel channeling`,title:`Cancel`,children:`Cancel`})]}),(0,g.jsxs)(`div`,{className:`km-footer`,children:[(0,g.jsx)(`button`,{className:`km-btn`,onClick:n,title:`Back`,children:`Back`}),(0,g.jsx)(`div`,{className:`km-hint`,children:b})]})]})};function Oe(e,t,n,r,i){e.save(),e.fillStyle=i,e.beginPath(),e.arc(t,n,r,0,Math.PI*2),e.fill(),e.strokeStyle=`rgba(255,255,255,0.35)`,e.lineWidth=1.25,e.stroke(),e.restore()}function ke(e,t,n,r,i){e.save(),e.fillStyle=i,e.beginPath(),e.arc(t,n,r,Math.PI,0),e.lineTo(t+r,n+r*.85),e.lineTo(t-r,n+r*.85),e.closePath(),e.fill(),e.fillStyle=`#fff`,e.beginPath(),e.arc(t-r*.35,n-r*.15,r*.16,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+r*.35,n-r*.15,r*.16,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(0,0,0,0.7)`,e.beginPath(),e.arc(t-r*.3,n-r*.15,r*.08,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+r*.3,n-r*.15,r*.08,0,Math.PI*2),e.fill(),e.restore()}function Ae(e,t,n){let r=Math.min(460,Math.max(220,t*.5)),i=t/2,a=r/2;e.save(),e.globalAlpha=.35,e.strokeStyle=`rgba(0,255,208,.6)`,e.lineWidth=2,e.beginPath(),e.moveTo(i-a,20),e.lineTo(i+a,20),e.stroke();let o=je(r*N*2);e.globalAlpha=.2,e.fillStyle=`#ffd36e`,e.fillRect(i-o,17,o*2,6),e.globalAlpha=.9,e.fillStyle=`#00ffd0`;let s=i-a+n*r;e.beginPath(),e.arc(s,20,4,0,Math.PI*2),e.fill(),e.restore()}function je(e){return e/2}function Me(e,t,n){e.save(),e.globalAlpha=.08,e.strokeStyle=`rgba(255,255,255,0.15)`,e.lineWidth=1;let r=t/2,i=n/2,a=(1+Math.sqrt(5))/2,o=4;for(let s=0;s<8;s++){let s=Math.min(t,n)/o;e.beginPath(),e.arc(r,i,s,-Math.PI/2,Math.PI),e.stroke(),o*=a}e.restore()}var J={background:`linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04))`,border:`1px solid rgba(255,255,255,0.25)`,borderRadius:10,color:`rgba(255,255,255,0.9)`,fontSize:18,lineHeight:1,padding:0,display:`flex`,alignItems:`center`,justifyContent:`center`,minWidth:36,minHeight:36,touchAction:`none`};(()=>{let e=Array.from({length:31},()=>Array.from({length:28},()=>2));for(let t=0;t<28;t++)e[0][t]=1,e[30][t]=1;for(let t=0;t<31;t++)e[t][0]=1,e[t][27]=1;for(let t=4;t<24;t+=6)for(let n=4;n<27;n+=6)e[n][t]=1,e[n][t+1]=1,e[n+1][t]=1,e[n+1][t+1]=1;for(let t=2;t<26;t++)e[15][t]=0;e[1][1]=3,e[1][26]=3,e[29][1]=3,e[29][26]=3;for(let t=2;t<29;t++)e[t][14]=0;for(let t=2;t<26;t++)e[11][t]=0;return e})();var Ne=5236,Y=3,Pe=Y*2,Fe=2,Ie=.15,Le=220,Re=60,ze=20;function Be(e){return(Math.imul(e^2654435769,2654435761)>>>0)%1e5/1e5}function Ve(e,t){let n=Math.abs(e-t)%360;return n>180&&(n=360-n),n}var He=({currentPhi:e,onPhiChange:t})=>{let[n,r]=(0,c.useState)(`forge`),[i,a]=(0,c.useState)(null),[o,s]=(0,c.useState)(performance.now()),[l,u]=(0,c.useState)(0),[d,f]=(0,c.useState)(!1),[p,m]=(0,c.useState)(null),[h,_]=(0,c.useState)(0);C({onPulse:e=>{a(e),s(performance.now()),m(e=>e&&{...e,delta:e.delta})}}),(0,c.useEffect)(()=>{if(n!==`forge`)return;let e=0,t=!0,r=()=>{if(!t)return;let n=performance.now();u(Math.max(0,n-o)%Ne/Ne*360%360),e=requestAnimationFrame(r)};return e=requestAnimationFrame(r),()=>{t=!1,cancelAnimationFrame(e)}},[o,n]);let v=(0,c.useMemo)(()=>{let e=i??0,t=Math.floor(Be(e)*360),n=Re+(e%2==0?ze:0)-Math.min(20,Math.floor(h*6));return{centerDeg:t,halfWidthDeg:Math.max(10,n/2)}},[i,h]),y=(0,c.useMemo)(()=>n===`forge`&&!d&&e>=Y&&i!==null,[n,d,e,i]),b=(0,c.useCallback)(e=>{let t=Pe,n=1+h*Ie,r=e?Fe:1;return Math.floor(t*n*r)},[h]),x=(0,c.useCallback)(()=>{if(!y)return;let n=e-Y;t(n),f(!0),m(null);let r=Ve(l,v.centerDeg),i=Math.max(4,v.halfWidthDeg*.25),a=r<=v.halfWidthDeg,o=a&&r<=i;window.setTimeout(()=>{if(a){let e=b(o);t(n+e),_(e=>e+1),m({kind:o?`crit`:`hit`,delta:e})}else _(0),m({kind:`miss`,delta:-Y});f(!1)},650)},[y,e,t,l,v.centerDeg,v.halfWidthDeg,b]);return(0,c.useEffect)(()=>{if(n!==`forge`)return;let e=e=>{let t=e.key.toLowerCase();(t===` `||t===`enter`)&&(e.preventDefault(),x())};return window.addEventListener(`keydown`,e),()=>window.removeEventListener(`keydown`,e)},[n,x]),(0,g.jsx)(`div`,{className:`pf-wrap`,role:`group`,"aria-label":`Pulse Forge`,children:n===`forge`?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)(`div`,{className:`pf-header`,children:[(0,g.jsx)(`div`,{className:`pf-title`,children:`âš’ï¸ Pulse Forge`}),(0,g.jsx)(`div`,{className:`pf-sub`,children:`Time your lock to the target arc. Breathe, focus, forge.`}),(0,g.jsx)(`div`,{style:{marginLeft:`auto`,display:`flex`,gap:8},children:(0,g.jsx)(`button`,{type:`button`,className:`pf-lock-btn`,onClick:()=>r(`maze`),title:`Switch to Kai-Maze`,children:`Play Kai-Maze`})})]}),(0,g.jsxs)(`div`,{className:`pf-board`,children:[(0,g.jsxs)(`div`,{className:`pf-dial`,style:{width:Le,height:Le},children:[(0,g.jsx)(`div`,{className:`pf-arc`,style:{"--arc-center":`${v.centerDeg}deg`,"--arc-half":`${v.halfWidthDeg}deg`},"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`pf-marker ${d?`pf-marker--lock`:``}`,style:{transform:`rotate(${l}deg)`},"aria-hidden":!0,children:(0,g.jsx)(`div`,{className:`pf-marker-head`})}),(0,g.jsx)(`div`,{className:`pf-rim`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`pf-ticks`,"aria-hidden":!0,children:Array.from({length:12}).map((e,t)=>(0,g.jsx)(`span`,{style:{transform:`rotate(${t*30}deg)`}},t))})]}),(0,g.jsxs)(`div`,{className:`pf-hud`,children:[(0,g.jsxs)(`div`,{className:`pf-chip`,title:`Your Î¦`,children:[(0,g.jsx)(`span`,{className:`pf-chip__label`,children:`Î¦`}),(0,g.jsx)(`span`,{className:`pf-chip__val`,children:e})]}),(0,g.jsxs)(`div`,{className:`pf-chip`,title:`Streak`,children:[(0,g.jsx)(`span`,{className:`pf-chip__label`,children:`Streak`}),(0,g.jsx)(`span`,{className:`pf-chip__val`,children:h})]}),(0,g.jsxs)(`div`,{className:`pf-chip`,title:`Pulse`,children:[(0,g.jsx)(`span`,{className:`pf-chip__label`,children:`Pulse`}),(0,g.jsx)(`span`,{className:`pf-chip__val`,children:i??`â€”`})]})]})]}),(0,g.jsxs)(`div`,{className:`pf-cta`,children:[(0,g.jsx)(`button`,{className:`pf-lock-btn`,onClick:x,disabled:!y,"aria-disabled":!y,title:y?`Press Space/Enter to Lock`:`Insufficient Î¦ or syncingâ€¦`,children:d?`Lockingâ€¦`:`Lock (âˆ’${Y} Î¦)`}),(0,g.jsxs)(`div`,{className:`pf-hint`,children:[`Press `,(0,g.jsx)(`kbd`,{children:`Space`}),` or `,(0,g.jsx)(`kbd`,{children:`Enter`}),` at the right moment. Even pulses widen the target.`]})]}),p&&(0,g.jsxs)(`div`,{className:`pf-result pf-result--${p.kind}`,role:`status`,"aria-live":`polite`,children:[p.kind===`hit`&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(`span`,{className:`pf-result__emoji`,children:`âœ…`}),(0,g.jsxs)(`span`,{className:`pf-result__text`,children:[`Resonant lock! +`,p.delta,` Î¦`]})]}),p.kind===`crit`&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(`span`,{className:`pf-result__emoji`,children:`ðŸ’¥`}),(0,g.jsxs)(`span`,{className:`pf-result__text`,children:[`Perfect lock! +`,p.delta,` Î¦`]})]}),p.kind===`miss`&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(`span`,{className:`pf-result__emoji`,children:`âŒ`}),(0,g.jsx)(`span`,{className:`pf-result__text`,children:`Miss â€” breathe again.`})]})]})]}):(0,g.jsx)(De,{currentPhi:e,onPhiChange:t,onExit:()=>r(`forge`)})})};function Ue(){return`kai-${Math.random().toString(36).slice(2,8)}`}function We(e){if(typeof e!=`object`||!e)return!1;let t=e;return typeof t.x==`number`&&typeof t.pulseIndex==`number`&&typeof t.chakraDay==`string`&&typeof t.glyph==`object`&&t.glyph!==null}var Ge=null;async function Ke(){return Ge||(Ge=(await r(()=>import(`./bundler-DW1MhLMJ.js`),__vite__mapDeps([0,1,2]))).default,Ge)}function qe(e){let[t]=(0,c.useState)(()=>e??Ue()),[n,r]=(0,c.useState)([]),[i,a]=(0,c.useState)([]),o=(0,c.useRef)(null),s=(0,c.useRef)({}),l=(0,c.useCallback)((e,t)=>{if(!We(t))return;let n={...t,id:e,glyph:t.glyph};a(t=>{let r=t.findIndex(t=>t.id===e);if(r>=0){let e=[...t];return e[r]=n,e}return[...t,n]})},[]),u=(0,c.useCallback)((e,t)=>{We(e)&&l(t,e)},[l]);return(0,c.useEffect)(()=>{let e=!1;return(async()=>{let n=await Ke();if(e)return;let i=new n(t);o.current=i,i.on(`open`,()=>{r(e=>e)}),i.on(`connection`,e=>{s.current[e.peer]=e,r(t=>Array.from(new Set([...t,e.peer]))),e.on(`data`,t=>{u(t,e.peer)}),e.on(`close`,()=>{delete s.current[e.peer],r(t=>t.filter(t=>t!==e.peer)),a(t=>t.filter(t=>t.id!==e.peer))})})})().catch(e=>{console.error(`[KaiRealms] Peer init failed:`,e)}),()=>{e=!0;try{o.current?.destroy()}catch(e){console.warn(`[KaiRealms] Peer destroy failed:`,e)}o.current=null,s.current={},r([]),a([])}},[t,u]),{sessionId:t,peers:n,sendState:(0,c.useCallback)(e=>{let t=Object.values(s.current);for(let n of t)n.open&&n.send(e)},[]),remoteStates:i}}var Je=800,Ye=500,Xe=Je/Ye,X=28,Z=10,Ze=360,Qe=10,Q=5236,$e=.08,et=22,tt=90,nt=80,rt=2,it=4,at=10,ot=3,st=1,ct=3,lt=1,ut=1,$=(e,t,n)=>e<t?t:e>n?n:e,dt=({glyphData:e,onExit:t})=>{let n=(0,c.useRef)(null),r=(0,c.useRef)(null),i=(0,c.useRef)(null),[a,o]=(0,c.useState)({w:Je,h:Ye}),s=(0,c.useRef)(a);(0,c.useEffect)(()=>{s.current=a},[a]);let[l,u]=(0,c.useState)(0),[d,f]=(0,c.useState)(0),[p,m]=(0,c.useState)(!1),[h,_]=(0,c.useState)(ot),[v,y]=(0,c.useState)(0),[b,x]=(0,c.useState)(0),[S,w]=(0,c.useState)(!1),T=(0,c.useRef)(performance.now()),{sendState:E,remoteStates:D}=qe(),O=(0,c.useRef)([]);(0,c.useEffect)(()=>{O.current=D??[]},[D]);let k=(0,c.useRef)(Je/2),A=(0,c.useRef)([]),j=(0,c.useRef)({}),M=(0,c.useRef)(null),N=(0,c.useRef)(null),P=(0,c.useRef)(null),F=(0,c.useRef)(0),I=(0,c.useRef)(0),L=(0,c.useRef)(null);(0,c.useEffect)(()=>{let e=n.current;if(!e)return;let t=new ResizeObserver(e=>{let t=e[0].contentRect,n=Math.max(320,Math.min(960,t.width));o({w:n,h:Math.round(n/Xe)})});return t.observe(e),()=>t.disconnect()},[]),(0,c.useEffect)(()=>{let e=r.current;if(!e)return;let t=e.getContext(`2d`);if(!t)return;let n=Math.min(2,window.devicePixelRatio||1);e.style.width=`${a.w}px`,e.style.height=`${a.h}px`,e.width=Math.floor(a.w*n),e.height=Math.floor(a.h*n),t.setTransform(n,0,0,n,0,0),i.current=t,k.current=$(k.current,X,a.w-X)},[a]),(0,c.useEffect)(()=>{let e=e=>{j.current[e.key]=!0,e.key.toLowerCase()===`p`&&m(e=>!e),e.key.toLowerCase()===`r`&&S&&re()},t=e=>{j.current[e.key]=!1};return window.addEventListener(`keydown`,e),window.addEventListener(`keyup`,t),()=>{window.removeEventListener(`keydown`,e),window.removeEventListener(`keyup`,t)}},[S]),(0,c.useEffect)(()=>{let e=r.current;if(!e)return;let t=t=>{let n=e.getBoundingClientRect();return $((t-n.left)/n.width*s.current.w,X,s.current.w-X)},n=!1,i=e=>{n=!0,k.current=t(e.clientX)},a=e=>{n&&(k.current=t(e.clientX))},o=()=>{n=!1};return e.addEventListener(`pointerdown`,i),e.addEventListener(`pointermove`,a),window.addEventListener(`pointerup`,o),()=>{e.removeEventListener(`pointerdown`,i),e.removeEventListener(`pointermove`,a),window.removeEventListener(`pointerup`,o)}},[]);let ee=e=>Math.max(0,e-T.current)%Q/Q,te=e=>{let t=Math.sin(Math.PI*e);return .65+.7*(t*t)},R=e=>{let{w:t}=s.current,n=performance.now(),r=Math.random()*(t-2*Z)+Z,i=-Z*2,a=(Math.random()-.5)*40,o=(e===`gold`?nt:tt)+v*(at*.2),c={id:`${e}-${n}-${Math.floor(Math.random()*1e6)}`,x:r,y:i,vx:a,baseVy:o,kind:e,bornAt:n},l=A.current.slice(-(et-1));l.push(c),A.current=l};C({onPulse:e=>{f(e),T.current=performance.now(),I.current+=1;for(let e=0;e<rt;e++)R(`basic`);I.current%it===0&&R(`gold`)}});let ne=t=>{let n=P.current,r=k.current,i=d;if(!n||Math.abs(n.x-r)>=1||n.pulseIndex!==i||t-F.current>1e3/Qe){P.current={x:r,pulseIndex:i},F.current=t;try{E({id:`you`,x:r,pulseIndex:i,chakraDay:e.meta.chakraDay,glyph:e})}catch{}}};(0,c.useEffect)(()=>{let t=r.current,n=i.current;if(!t||!n)return;let a=!0,o=t=>{if(!a)return;M.current=requestAnimationFrame(o);let r=N.current??t,i=Math.min(.05,(t-r)/1e3);N.current=t;let{w:c,h:l}=s.current,d=l-X-10;if(!p&&!S){let e=j.current,n=!!(e.ArrowLeft||e.a||e.A),r=!!(e.ArrowRight||e.d||e.D);n&&(k.current=$(k.current-Ze*i,X,c-X)),r&&(k.current=$(k.current+Ze*i,X,c-X));let a=k.current,o=performance.now(),s=ee(o),f=te(s),p=[],m=0,h=0,g=0;for(let e=0;e<A.current.length;e++){let t=A.current[e],n=(t.baseVy+v*(at*.15))*f;t.x+=t.vx*i,t.y+=n*i,t.x<Z&&(t.x=Z,t.vx=Math.abs(t.vx)*.9),t.x>c-Z&&(t.x=c-Z,t.vx=-Math.abs(t.vx)*.9);let r=t.x-a,u=t.y-d;if(Math.hypot(r,u)<X+Z){let e=t.kind===`gold`?ct:lt;m+=e,Math.abs(s-.5)<=$e?(h+=ut,L.current={t:o,x:a,kind:`perfect`}):L.current={t:o,x:a,kind:`good`};continue}if(t.y>l+Z){g+=1;continue}p.push(t)}if(m>0||h>0){let e=m+h;u(t=>t+e),y(e=>{let t=e+1;return x(e=>t>e?t:e),t})}g>0&&(u(e=>Math.max(0,e-st*g)),y(0),_(e=>{let t=Math.max(0,e-g);return t===0&&w(!0),t})),A.current=p,ne(t)}ft(n,e,k.current,d,p||S,A.current,O.current,s.current,T.current,L.current)};return M.current=requestAnimationFrame(o),()=>{a=!1,M.current!==null&&cancelAnimationFrame(M.current),M.current=null,N.current=null}},[e,p,S,a.w,a.h]);let re=()=>{A.current=[],_(ot),y(0),x(e=>e),w(!1)},ie=(0,c.useMemo)(()=>({pulse:d,chakraDay:e?.meta?.chakraDay??`â€”`}),[d,e?.meta?.chakraDay]);return(0,g.jsxs)(`div`,{className:`realm-wrap`,ref:n,children:[(0,g.jsxs)(`div`,{className:`realm-hud`,children:[(0,g.jsxs)(`div`,{className:`hud-chip hud-chip--score`,title:`Banked Î¦`,children:[(0,g.jsx)(`span`,{className:`hud-chip__label`,children:`Î¦`}),(0,g.jsx)(`span`,{className:`hud-chip__value`,children:l})]}),(0,g.jsxs)(`div`,{className:`hud-chip`,title:`Streak`,children:[(0,g.jsx)(`span`,{className:`hud-chip__label`,children:`Streak`}),(0,g.jsx)(`span`,{className:`hud-chip__value`,children:v})]}),(0,g.jsxs)(`div`,{className:`hud-chip`,title:`Lives`,children:[(0,g.jsx)(`span`,{className:`hud-chip__label`,children:`Lives`}),(0,g.jsx)(`span`,{className:`hud-chip__value`,children:h})]}),(0,g.jsxs)(`div`,{className:`hud-chip`,title:`Current Pulse`,children:[(0,g.jsx)(`span`,{className:`hud-chip__label`,children:`Pulse`}),(0,g.jsx)(`span`,{className:`hud-chip__value`,children:ie.pulse})]}),(0,g.jsxs)(`div`,{className:`hud-chip`,title:`Chakra Day`,children:[(0,g.jsx)(`span`,{className:`hud-chip__label`,children:`Day`}),(0,g.jsx)(`span`,{className:`hud-chip__value`,children:ie.chakraDay})]}),(0,g.jsx)(`button`,{className:`hud-button`,onClick:()=>m(e=>!e),"aria-pressed":p,title:`Pause (P)`,children:p?`Resume`:`Pause`})]}),(0,g.jsxs)(`div`,{className:`realm-canvas-wrap`,children:[(0,g.jsx)(`canvas`,{ref:r,className:`realm-canvas`,"aria-label":`Kai Realms Canvas`}),(p||S)&&(0,g.jsx)(`div`,{className:`realm-pause-overlay`,"aria-hidden":!0,children:(0,g.jsxs)(`div`,{className:`pause-card`,children:[(0,g.jsx)(`div`,{className:`pause-title`,children:S?`Game Over`:`Paused`}),(0,g.jsx)(`div`,{className:`pause-sub`,children:S?(0,g.jsxs)(g.Fragment,{children:[`Best Streak: `,(0,g.jsx)(`strong`,{children:b}),` â€” Press `,(0,g.jsx)(`kbd`,{children:`R`}),` to Restart`]}):(0,g.jsxs)(g.Fragment,{children:[`Press `,(0,g.jsx)(`kbd`,{children:`P`}),` or click Resume`]})}),S&&(0,g.jsx)(`button`,{className:`hud-button`,onClick:re,style:{marginTop:12},children:`Restart`})]})})]}),(0,g.jsx)(He,{currentPhi:l,onPhiChange:e=>u(e)}),(0,g.jsx)(`button`,{className:`exit-button`,onClick:t,children:`Exit Realm`})]})};function ft(e,t,n,r,i,a,o,s,c,l){let{w:u,h:d}=s,f=e.createLinearGradient(0,0,0,d);f.addColorStop(0,`#020211`),f.addColorStop(1,`#0b0f2a`),e.fillStyle=f,e.fillRect(0,0,u,d),e.save(),e.globalAlpha=.12;for(let t=0;t<40;t++){let n=t*197%u+t%3,r=t*127%d+t*11%7;e.fillStyle=`white`,e.fillRect(n,r,2,2)}e.restore(),pt(e,u,Math.max(36,Math.round(d*.06)),c);for(let t=0;t<a.length;t++)mt(e,a[t]);T(e,t,n,r,X);for(let t=0;t<o.length;t++){let n=o[t];T(e,n.glyph,$(n.x,X,u-X),r,X)}if(l){let t=performance.now()-l.t;if(t<650){let n=1-t/650;e.save(),e.globalAlpha=n,e.fillStyle=l.kind===`perfect`?`#ffd36e`:`#00ffd0`,e.font=`bold 16px ui-sans-serif,system-ui,Segoe UI,Roboto`,e.textAlign=`center`,e.fillText(l.kind===`perfect`?`Perfect Breath!`:`+Î¦`,l.x,r-X-16),e.restore()}}e.save();let p=e.createLinearGradient(0,r+X+6,0,r+X+18);p.addColorStop(0,`rgba(0,255,208,0.25)`),p.addColorStop(1,`rgba(0,255,208,0.0)`),e.fillStyle=p,e.fillRect(0,r+X+6,u,12),e.restore(),i&&(e.save(),e.fillStyle=`rgba(0,0,0,.35)`,e.fillRect(0,0,u,d),e.restore())}function pt(e,t,n,r){let i=(performance.now()-r)%Q/Q,a=t/2,o=Math.round(n*.6),s=Math.min(420,Math.max(200,Math.round(t*.5))),c=s/2;e.save(),e.globalAlpha=.35,e.strokeStyle=`rgba(0,255,208,.5)`,e.lineWidth=2,e.beginPath(),e.moveTo(a-c,o),e.lineTo(a+c,o),e.stroke();let l=a-c+i*s;e.globalAlpha=.9,e.fillStyle=`#00ffd0`,e.beginPath(),e.arc(l,o,4,0,Math.PI*2),e.fill(),e.globalAlpha=.25,e.fillStyle=`#ffd36e`;let u=a,d=s*$e;e.fillRect(u-d,o-3,d*2,6),e.restore()}function mt(e,t){e.save();let n=Z;e.globalAlpha=.35;let r=e.createLinearGradient(t.x,t.y-12,t.x,t.y+n);r.addColorStop(0,`rgba(0,255,208,0.0)`),r.addColorStop(1,t.kind===`gold`?`rgba(255,211,110,0.35)`:`rgba(0,255,208,0.35)`),e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y-12),e.lineTo(t.x,t.y+n*.2),e.stroke(),e.globalAlpha=1;let i=e.createRadialGradient(t.x,t.y,n*.15,t.x,t.y,n);i.addColorStop(0,`#fff`),t.kind===`gold`?(i.addColorStop(.5,`#ffd36e`),i.addColorStop(1,`rgba(255,211,110,0.0)`)):(i.addColorStop(.5,`#00ffd0`),i.addColorStop(1,`rgba(0,255,208,0.0)`)),e.fillStyle=i,e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),e.strokeStyle=t.kind===`gold`?`rgba(255,211,110,.75)`:`rgba(0,255,208,.65)`,e.lineWidth=1.25,e.stroke(),e.restore()}var ht=({onClose:t})=>{let[n,r]=(0,c.useState)(null),i=(0,c.useRef)(null),a=(0,c.useRef)(null),o=(0,c.useCallback)(e=>r(e),[]),s=(0,c.useCallback)(()=>{r(null),t?.()},[t]);(0,c.useEffect)(()=>{let e=e=>{e.key===`Escape`&&t?.()};return document.addEventListener(`keydown`,e),a.current?.focus(),()=>document.removeEventListener(`keydown`,e)},[t]),(0,c.useEffect)(()=>{let e=i.current;if(!e)return;let t=e=>e.stopPropagation();return e.addEventListener(`wheel`,t,{passive:!0}),()=>e.removeEventListener(`wheel`,t)},[]);let l=()=>t?.(),u=e=>e.stopPropagation();return(0,g.jsxs)(`div`,{className:`realms-backdrop realms-veil`,role:`dialog`,"aria-modal":`true`,"aria-labelledby":`kai-realms-title`,onMouseDown:l,children:[(0,g.jsx)(`div`,{className:`realms-stars`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`realms-halo realms-halo--1`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`realms-halo realms-halo--2`,"aria-hidden":!0}),(0,g.jsxs)(`div`,{ref:i,className:`realms-container glass-omni`,onMouseDown:u,role:`document`,children:[(0,g.jsx)(`div`,{className:`breath-ring breath-ring--outer`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`breath-ring breath-ring--inner`,"aria-hidden":!0}),(0,g.jsx)(`div`,{className:`phi-grid`,"aria-hidden":!0}),(0,g.jsxs)(`header`,{className:`realms-header`,children:[(0,g.jsx)(`button`,{ref:a,type:`button`,className:`realms-close auric-btn`,"aria-label":`Close Kai Realms`,onClick:e=>{e.stopPropagation(),t?.()},onMouseDown:e=>e.stopPropagation(),onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),e.stopPropagation(),t?.())},children:(0,g.jsx)(e,{size:20,"aria-hidden":!0})}),(0,g.jsx)(`div`,{className:`header-seals`,"aria-hidden":!0,children:(0,g.jsxs)(`div`,{className:`seal-emblem`,children:[(0,g.jsx)(`div`,{className:`seal-ring`}),(0,g.jsx)(`div`,{className:`seal-ring seal-ring--inner`}),(0,g.jsx)(`div`,{className:`seal-core`})]})}),(0,g.jsx)(`h2`,{id:`kai-realms-title`,className:`sr-only`,children:`Kai Realms â€” Sigil Gate`})]}),(0,g.jsx)(`main`,{className:`realms-body`,children:n?(0,g.jsx)(`div`,{className:`realm-stage`,children:(0,g.jsx)(dt,{glyphData:n,onExit:s})}):(0,g.jsx)(`div`,{className:`portal-stage`,children:(0,g.jsx)(v,{onEnter:o})})}),(0,g.jsx)(`footer`,{className:`realms-footer`,"aria-hidden":!0,children:(0,g.jsx)(`div`,{className:`footer-center`,style:{margin:`0 auto`},children:(0,g.jsx)(gt,{})})})]})]})};function gt(){return(0,g.jsxs)(`svg`,{className:`seal-coin`,width:`56`,height:`56`,viewBox:`0 0 56 56`,"aria-hidden":!0,children:[(0,g.jsxs)(`defs`,{children:[(0,g.jsxs)(`radialGradient`,{id:`coinGlowRealms`,cx:`50%`,cy:`50%`,r:`50%`,children:[(0,g.jsx)(`stop`,{offset:`0%`,stopColor:`#ffffff`,stopOpacity:`0.9`}),(0,g.jsx)(`stop`,{offset:`40%`,stopColor:`#ffd86b`,stopOpacity:`0.75`}),(0,g.jsx)(`stop`,{offset:`100%`,stopColor:`#ffd86b`,stopOpacity:`0.15`})]}),(0,g.jsxs)(`linearGradient`,{id:`coinEdgeRealms`,x1:`0`,y1:`0`,x2:`1`,y2:`1`,children:[(0,g.jsx)(`stop`,{offset:`0%`,stopColor:`#00ffd0`,stopOpacity:`0.8`}),(0,g.jsx)(`stop`,{offset:`100%`,stopColor:`#8a2be2`,stopOpacity:`0.8`})]})]}),(0,g.jsx)(`circle`,{cx:`28`,cy:`28`,r:`26`,fill:`url(#coinGlowRealms)`,stroke:`url(#coinEdgeRealms)`,strokeWidth:`1.5`}),(0,g.jsxs)(`g`,{className:`seal-coin__rotor`,children:[(0,g.jsx)(`circle`,{cx:`28`,cy:`28`,r:`18`,fill:`none`,stroke:`url(#coinEdgeRealms)`,strokeWidth:`1.25`}),(0,g.jsxs)(`g`,{stroke:`rgba(255,255,255,0.35)`,strokeWidth:`0.6`,children:[(0,g.jsx)(`line`,{x1:`28`,y1:`10`,x2:`28`,y2:`46`}),(0,g.jsx)(`line`,{x1:`10`,y1:`28`,x2:`46`,y2:`28`}),(0,g.jsx)(`line`,{x1:`15`,y1:`15`,x2:`41`,y2:`41`}),(0,g.jsx)(`line`,{x1:`41`,y1:`15`,x2:`15`,y2:`41`})]})]}),(0,g.jsx)(`circle`,{className:`seal-coin__core`,cx:`28`,cy:`28`,r:`6.5`})]})}export{ht as default};